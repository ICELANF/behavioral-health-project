<template>
  <div class="client-home-optimized">
    <!-- 1. é¡¶éƒ¨é—®å€™åŒº -->
    <div class="welcome-section">
      <div class="welcome-content">
        <div class="greeting">
          <div class="greeting-time">{{ greetingText }}</div>
          <div class="greeting-name">{{ userName }} ğŸ‘‹</div>
        </div>
        <a-avatar :size="60" :src="avatarUrl || undefined" class="user-avatar" @click="router.push('/client/my/profile')">
          <template v-if="!avatarUrl">{{ avatarText }}</template>
        </a-avatar>
      </div>

      <!-- å¥åº·è¯„åˆ† - ä½¿ç”¨ç»„ä»¶ -->
      <div class="health-score-wrapper">
        <HealthScoreCircle
          :score="healthScore"
          :size="100"
          :status-text="healthScoreText"
          :subtitle="`ğŸ”¥ è¿ç»­æ‰“å¡ ${streakDays} å¤©`"
          :show-info="false"
        />
      </div>
    </div>

    <!-- 2. ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <!-- ä»Šæ—¥é‡ç‚¹ä»»åŠ¡ -->
      <div class="section-card">
        <div class="task-section-header">
          <h3 class="section-title" style="margin:0">âœ¨ ä»Šå¤©è¦åšçš„äº‹</h3>
          <a-button type="link" size="small" @click="showCatalog = true" style="font-size:14px">
            <PlusCircleOutlined /> æ·»åŠ ä»»åŠ¡
          </a-button>
        </div>
        <TaskList
          v-if="priorityTasks.length > 0"
          :tasks="priorityTasks"
          :show-header="false"
          :show-progress="false"
          :show-progress-ring="true"
          :show-source-badge="true"
          :show-delete-button="true"
          :collapsible="true"
          :max-uncompleted="5"
          :show-encouragement="false"
          @toggle="toggleTask"
          @delete="deleteTask"
        />
        <div v-else class="empty-tasks">
          <div class="empty-icon">ğŸ“‹</div>
          <div class="empty-text">ä»Šå¤©è¿˜æ²¡æœ‰ä»»åŠ¡</div>
          <a-button type="primary" size="small" @click="showCatalog = true">é€‰æ‹©ä»»åŠ¡</a-button>
        </div>
      </div>

      <!-- å®Œæˆåº†ç¥è¦†ç›–å±‚ -->
      <Teleport to="body">
        <Transition name="celebrate-fade">
          <div v-if="celebrationVisible" class="celebrate-overlay" @click="celebrationVisible = false">
            <div class="celebrate-card" @click.stop>
              <div class="celebrate-emoji">{{ celebrationData.emoji }}</div>
              <div class="celebrate-title">{{ celebrationData.title }}</div>
              <div class="celebrate-msg">{{ celebrationData.message }}</div>
              <div v-if="celebrationData.points" class="celebrate-points">+{{ celebrationData.points }} ç§¯åˆ†</div>
              <div class="celebrate-remaining">è¿˜å‰© {{ celebrationData.remaining }} é¡¹ä»»åŠ¡</div>
            </div>
          </div>
        </Transition>
      </Teleport>

      <!-- 3. å…³æ³¨æŒ‡æ ‡è¶‹åŠ¿ â€” 7å¤©è¿·ä½ æ›²çº¿ -->
      <div class="section-card health-trends">
        <div class="trends-header">
          <h3 class="section-title" style="margin:0">ğŸ“Š æˆ‘çš„å…³æ³¨æŒ‡æ ‡</h3>
          <a class="trends-more" @click="router.push('/client/progress')">è¯¦ç»†åˆ†æ â€º</a>
        </div>

        <div class="trend-cards">
          <div
            v-for="m in activeMetrics"
            :key="m.key"
            class="trend-card"
            :style="{ borderLeftColor: m.color }"
            @click="router.push('/client/progress')"
          >
            <div class="trend-card-top">
              <span class="trend-icon">{{ m.icon }}</span>
              <span class="trend-label">{{ m.label }}</span>
              <span class="trend-arrow" :class="m.trendDir">{{ m.trendArrow }}</span>
            </div>
            <div class="trend-card-mid">
              <span class="trend-latest">{{ m.latest }}</span>
              <span class="trend-unit">{{ m.unit }}</span>
            </div>
            <div class="trend-sparkline">
              <TrendChart
                type="line"
                :data="m.data"
                :labels="m.labels"
                :line-color="m.color"
                :height="50"
                :width="280"
                :show-grid="false"
                :show-area="true"
                :show-dots="false"
                :show-labels="false"
                :show-stats="false"
                :stroke-width="2"
                :compact="true"
              />
            </div>
            <div class="trend-card-foot">{{ m.trendText }}</div>
          </div>
        </div>
      </div>

      <!-- 4. å¿«é€Ÿå…¥å£ â€” ç´§å‡‘è¡Œ -->
      <div class="section-card quick-row">
        <div class="quick-items">
          <div class="quick-item" @click="router.push('/client/data-input')">
            <span class="quick-icon">ğŸ“</span><span>è®°å½•</span>
          </div>
          <div class="quick-item" @click="router.push('/client/chat-v2')">
            <span class="quick-icon">ğŸ’¬</span><span>AIåŠ©æ‰‹</span>
          </div>
          <div class="quick-item" @click="router.push('/client/progress')">
            <span class="quick-icon">ğŸ“ˆ</span><span>è¿›å±•</span>
          </div>
          <div class="quick-item" @click="showMoreDrawer = true">
            <span class="quick-icon">ğŸ¯</span><span>æ›´å¤š</span>
          </div>
        </div>
      </div>

      <!-- 5. æ¯æ—¥æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰ -->
      <div class="section-card daily-tip" v-if="dailyTip">
        <div class="tip-header">
          <div class="tip-icon-large">{{ dailyTip.icon }}</div>
          <div class="tip-content">
            <div class="tip-title">{{ dailyTip.title }}</div>
            <div class="tip-text">{{ dailyTip.content }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="bottom-nav">
      <div class="nav-item active">
        <HomeOutlined />
        <span>é¦–é¡µ</span>
      </div>
      <div class="nav-item" @click="router.push('/client/device-dashboard')">
        <LineChartOutlined />
        <span>æ•°æ®</span>
      </div>
      <div class="nav-item center-btn" @click="router.push('/client/chat-v2')">
        <div class="center-icon">
          <MessageOutlined />
        </div>
      </div>
      <div class="nav-item" @click="router.push('/client/learning-progress')">
        <ReadOutlined />
        <span>å­¦ä¹ </span>
      </div>
      <div class="nav-item" @click="router.push('/client/my/profile')">
        <UserOutlined />
        <span>æˆ‘çš„</span>
      </div>
    </div>

    <!-- ä»»åŠ¡ç›®å½•æŠ½å±‰ -->
    <a-drawer
      v-model:open="showCatalog"
      title="é€‰æ‹©ä»Šæ—¥ä»»åŠ¡"
      placement="bottom"
      :height="'75vh'"
    >
      <div class="catalog-groups">
        <div v-for="group in catalogGroups" :key="group.label" class="catalog-group">
          <div class="catalog-group-label">{{ group.label }}</div>
          <div class="catalog-items">
            <div
              v-for="item in group.items"
              :key="item.id"
              class="catalog-item"
              :class="{ 'catalog-item-added': addedCatalogIds.has(item.id) }"
              @click="addCatalogTask(item)"
            >
              <span class="catalog-icon">{{ item.icon }}</span>
              <span class="catalog-title">{{ item.title }}</span>
              <span v-if="addedCatalogIds.has(item.id)" class="catalog-check">âœ“</span>
              <PlusOutlined v-else class="catalog-plus" />
            </div>
          </div>
        </div>
      </div>
    </a-drawer>

    <!-- æ›´å¤šåŠŸèƒ½æŠ½å±‰ -->
    <a-drawer
      v-model:open="showMoreDrawer"
      title="æ›´å¤šåŠŸèƒ½"
      placement="bottom"
      :height="'70vh'"
    >
      <div class="more-menu">
        <div class="more-item" @click="goToPage('/client/my/assessments')">
          <div class="more-icon">ğŸ“‹</div>
          <div class="more-label">æµ‹è¯„è®°å½•</div>
        </div>
        <div class="more-item" @click="goToPage('/client/my/trajectory')">
          <div class="more-icon">ğŸ¯</div>
          <div class="more-label">è¡Œä¸ºè½¨è¿¹</div>
        </div>
        <div class="more-item" @click="goToPage('/client/learning-progress')">
          <div class="more-icon">ğŸ“š</div>
          <div class="more-label">å­¦ä¹ è¿›åº¦</div>
        </div>
        <div class="more-item" @click="goToPage('/client/my/devices')">
          <div class="more-icon">âŒš</div>
          <div class="more-label">æˆ‘çš„è®¾å¤‡</div>
        </div>
      </div>
    </a-drawer>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import {
  UserOutlined,
  HomeOutlined,
  LineChartOutlined,
  MessageOutlined,
  ReadOutlined,
  PlusCircleOutlined,
  PlusOutlined,
} from '@ant-design/icons-vue'
import { message } from 'ant-design-vue'
import { healthApi } from '@/api/health'
import { profileApi } from '@/api/index'
import { HealthScoreCircle, TaskList, TrendChart } from '@/components/health'
import type { Task } from '@/components/health'

const router = useRouter()

// ç”¨æˆ·ä¿¡æ¯
const userName = ref(localStorage.getItem('admin_name') || localStorage.getItem('admin_username') || '')
const healthScore = ref(0)
const streakDays = ref(0)
const loading = ref(true)

// å¤´åƒæ˜¾ç¤ºæ–‡å­—ï¼ˆå–åå­—æœ€åä¸¤ä¸ªå­—ï¼‰
const avatarText = computed(() => {
  const name = userName.value || ''
  return name.length > 2 ? name.slice(-2) : name || '?'
})

// patientId no longer needed â€” real endpoints are JWT-scoped

// é—®å€™è¯­
const greetingText = computed(() => {
  const hour = new Date().getHours()
  if (hour < 6) return 'å¤œæ·±äº†ï¼Œæ—©ç‚¹ä¼‘æ¯'
  if (hour < 9) return 'æ—©ä¸Šå¥½'
  if (hour < 12) return 'ä¸Šåˆå¥½'
  if (hour < 14) return 'ä¸­åˆå¥½'
  if (hour < 18) return 'ä¸‹åˆå¥½'
  if (hour < 22) return 'æ™šä¸Šå¥½'
  return 'å¤œæ·±äº†ï¼Œæ—©ç‚¹ä¼‘æ¯'
})

const healthScoreText = computed(() => {
  if (healthScore.value >= 90) return 'çŠ¶æ€éå¸¸å¥½ï¼'
  if (healthScore.value >= 75) return 'ä¿æŒå¾—ä¸é”™'
  if (healthScore.value >= 60) return 'ç»§ç»­åŠ æ²¹'
  return 'éœ€è¦æ›´å¤šå…³æ³¨'
})

// ä»Šæ—¥é‡ç‚¹ä»»åŠ¡ï¼ˆæœ€å¤š3ä¸ªï¼‰
const priorityTasks = ref<Task[]>([])

// åº†ç¥è¦†ç›–å±‚
const celebrationVisible = ref(false)
const celebrationData = ref({
  emoji: 'ğŸ‰',
  title: 'å¤ªæ£’äº†ï¼',
  message: '',
  points: 0,
  remaining: 0,
})

const toggleTask = async (task: Task) => {
  if (task.completed) return
  task.completed = true
  try {
    const res = await healthApi.completeTask(String(task.id))
    // åç«¯è¿”å›ä¸ªæ€§åŒ–åé¦ˆ: { emoji, message, points_earned, streak_days }
    const fb = res || {}
    const remaining = priorityTasks.value.filter(t => !t.completed).length
    celebrationData.value = {
      emoji: fb.emoji || 'ğŸ‰',
      title: 'å¤ªæ£’äº†ï¼',
      message: fb.message || 'ç»§ç»­åŠ æ²¹ï¼',
      points: fb.points_earned || 10,
      remaining,
    }
    // å»¶è¿Ÿ300msåå¼¹å‡ºåº†ç¥
    setTimeout(() => {
      celebrationVisible.value = true
      // 2.5såè‡ªåŠ¨å…³é—­
      setTimeout(() => { celebrationVisible.value = false }, 2500)
    }, 300)
  } catch (e: any) {
    if (e?.response?.status === 409) {
      // å·²æ‰“å¡ï¼Œå¿½ç•¥
    } else {
      task.completed = false
      console.error('å®Œæˆä»»åŠ¡å¤±è´¥:', e)
    }
  }
}

const deleteTask = async (task: Task) => {
  try {
    await healthApi.removeTask(String(task.id))
    const idx = priorityTasks.value.findIndex(t => t.id === task.id)
    if (idx !== -1) priorityTasks.value.splice(idx, 1)
    message.success('ä»»åŠ¡å·²åˆ é™¤')
  } catch (e: any) {
    const msg = e?.response?.data?.detail || 'åˆ é™¤å¤±è´¥'
    message.warning(msg)
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…³æ³¨æŒ‡æ ‡è¶‹åŠ¿ â€” 7å¤©è¿·ä½ æ›²çº¿
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface MetricTrend {
  key: string
  icon: string
  label: string
  color: string
  unit: string
  latest: string
  data: number[]
  labels: string[]
  trendArrow: string
  trendDir: string
  trendText: string
}

// All possible metrics
const glucoseTrend = ref<MetricTrend>({
  key: 'glucose', icon: 'ğŸ©¸', label: 'è¡€ç³–', color: '#ef4444', unit: 'mmol/L',
  latest: '--', data: [], labels: [], trendArrow: 'â†’', trendDir: 'stable', trendText: 'æš‚æ— æ•°æ®',
})
const weightTrend = ref<MetricTrend>({
  key: 'weight', icon: 'âš–ï¸', label: 'ä½“é‡', color: '#8b5cf6', unit: 'kg',
  latest: '--', data: [], labels: [], trendArrow: 'â†’', trendDir: 'stable', trendText: 'æš‚æ— æ•°æ®',
})
const exerciseTrend = ref<MetricTrend>({
  key: 'exercise', icon: 'ğŸƒ', label: 'è¿åŠ¨', color: '#10b981', unit: 'åˆ†é’Ÿ',
  latest: '--', data: [], labels: [], trendArrow: 'â†’', trendDir: 'stable', trendText: 'æš‚æ— æ•°æ®',
})
const bpTrend = ref<MetricTrend>({
  key: 'bp', icon: 'ğŸ’‰', label: 'è¡€å‹', color: '#f59e0b', unit: 'mmHg',
  latest: '--', data: [], labels: [], trendArrow: 'â†’', trendDir: 'stable', trendText: 'æš‚æ— æ•°æ®',
})
const sleepTrend = ref<MetricTrend>({
  key: 'sleep', icon: 'ğŸ˜´', label: 'ç¡çœ ', color: '#6366f1', unit: 'åˆ†',
  latest: '--', data: [], labels: [], trendArrow: 'â†’', trendDir: 'stable', trendText: 'æš‚æ— æ•°æ®',
})

// User's diagnoses â†’ which metrics to show
const userDiagnoses = ref<string[]>([])

const activeMetrics = computed<MetricTrend[]>(() => {
  const diags = userDiagnoses.value.map(d => d.toLowerCase())
  const metrics: MetricTrend[] = []

  // Always show glucose if diabetic, or as default primary
  const hasDiabetes = diags.some(d => d.includes('ç³–å°¿'))
  const hasHypertension = diags.some(d => d.includes('é«˜è¡€å‹'))
  const hasOrtho = diags.some(d => d.includes('æ¤') || d.includes('å…³èŠ‚') || d.includes('éª¨') || d.includes('è‚©'))

  if (hasDiabetes || diags.length === 0) metrics.push(glucoseTrend.value)
  if (hasHypertension) metrics.push(bpTrend.value)
  metrics.push(weightTrend.value)
  metrics.push(exerciseTrend.value)
  if (hasOrtho) metrics.push(sleepTrend.value)

  // Ensure at least 3, at most 4
  const all = [glucoseTrend.value, weightTrend.value, exerciseTrend.value, bpTrend.value, sleepTrend.value]
  for (const m of all) {
    if (metrics.length >= 4) break
    if (!metrics.includes(m)) metrics.push(m)
  }
  return metrics.slice(0, 4)
})

function computeTrend(data: number[]): { arrow: string; dir: string; text: string } {
  if (data.length < 2) return { arrow: 'â†’', dir: 'stable', text: 'æ•°æ®ä¸è¶³' }
  const recent = data.slice(-3)
  const earlier = data.slice(0, 3)
  const avgRecent = recent.reduce((s, v) => s + v, 0) / recent.length
  const avgEarlier = earlier.reduce((s, v) => s + v, 0) / earlier.length
  const diff = avgRecent - avgEarlier
  const pct = avgEarlier > 0 ? Math.abs(diff / avgEarlier * 100).toFixed(1) : '0'
  if (diff > 0.1) return { arrow: 'â†—', dir: 'up', text: `è¾ƒå‰å‡é«˜ ${pct}%` }
  if (diff < -0.1) return { arrow: 'â†˜', dir: 'down', text: `è¾ƒå‰ä¸‹é™ ${pct}%` }
  return { arrow: 'â†’', dir: 'stable', text: 'ä¿æŒç¨³å®š' }
}

// æ¯æ—¥æç¤º
const dailyTip = ref<{ icon: string; title: string; content: string } | null>(null)

// ä»»åŠ¡ç›®å½•
const showCatalog = ref(false)
const catalogItems = ref<any[]>([])
const addedCatalogIds = ref(new Set<string>())

interface CatalogGroup {
  label: string
  items: any[]
}
const catalogGroups = computed<CatalogGroup[]>(() => {
  const groups: Record<string, any[]> = {}
  for (const item of catalogItems.value) {
    const tag = item.tag || 'å…¶ä»–'
    if (!groups[tag]) groups[tag] = []
    groups[tag].push(item)
  }
  return Object.entries(groups).map(([label, items]) => ({ label, items }))
})

const loadCatalog = async () => {
  try {
    const data = await healthApi.getTaskCatalog()
    catalogItems.value = data.catalog || []
  } catch (e) {
    console.error('åŠ è½½ä»»åŠ¡ç›®å½•å¤±è´¥:', e)
  }
}

const addCatalogTask = async (item: any) => {
  if (addedCatalogIds.value.has(item.id)) {
    message.info('ä»Šå¤©å·²æ·»åŠ è¿‡è¯¥ä»»åŠ¡')
    return
  }
  try {
    const res = await healthApi.addTaskFromCatalog(item.id)
    addedCatalogIds.value.add(item.id)
    message.success(res.message || 'ä»»åŠ¡å·²æ·»åŠ ')
    // Reload tasks
    await loadTasks()
  } catch (e: any) {
    const msg = e?.response?.data?.detail || 'æ·»åŠ å¤±è´¥'
    message.warning(msg)
    if (msg.includes('å·²æ·»åŠ ')) addedCatalogIds.value.add(item.id)
  }
}

const loadTasks = async () => {
  try {
    const rawTasks = await healthApi.getDailyTasks()
    const taskList = rawTasks?.tasks || (Array.isArray(rawTasks) ? rawTasks : [])
    const emojiMap: Record<string, string> = {
      glucose: 'ğŸ©¸', weight: 'âš–ï¸', exercise: 'ğŸƒ', ç›‘æµ‹: 'ğŸ©¸',
      mood: 'ğŸ˜Š', assessment: 'ğŸ“‹', nutrition: 'ğŸ', è¥å…»: 'ğŸ',
      emotion: 'ğŸ’›', sleep: 'ğŸ˜´', ç¡çœ : 'ğŸ˜´', è¿åŠ¨: 'ğŸƒ',
      æƒ…ç»ª: 'ğŸ’›', å­¦ä¹ : 'ğŸ“–', ç”¨è¯: 'ğŸ’Š',
    }
    priorityTasks.value = taskList.map((t: any) => ({
      id: t.id,
      name: t.title || t.tag || 'ä»»åŠ¡',
      hint: t.time_hint ? `å»ºè®®æ—¶é—´: ${t.time_hint}` : undefined,
      emoji: emojiMap[t.type || t.tag] || 'ğŸ“',
      completed: t.completed ?? t.done ?? false,
      source: t.source || 'rx',
    }))
  } catch (e) {
    console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', e)
  }
}

// æ›´å¤šåŠŸèƒ½
const showMoreDrawer = ref(false)

const goToPage = (path: string) => {
  router.push(path)
  showMoreDrawer.value = false
}

// åŠ è½½æ•°æ®
const loadData = async () => {
  try {
    loading.value = true

    // å¹¶è¡ŒåŠ è½½: è¯„åˆ† + ä»»åŠ¡ + AIæç¤º + 7å¤©è¶‹åŠ¿ + ç”¨æˆ·æ¡£æ¡ˆ
    const [scoreData, tasksData, summaryData, gluRes, wtRes, exRes, bpRes, profileRes] = await Promise.allSettled([
      healthApi.getHealthScore(),
      healthApi.getDailyTasks(),
      healthApi.getAISummary(),
      healthApi.getGlucoseHistory({ period: '7d' }),
      healthApi.getWeightHistory({ period: '7d' }),
      healthApi.getExerciseHistory({ period: '7d' }),
      healthApi.getBloodPressureHistory({ limit: 7 }),
      profileApi.getProfile(),
    ])

    // å¥åº·æ•°æ®æ‘˜è¦ â†’ ç”¨äºä¸‹é¢è®¡ç®—ç»¼åˆè¯„åˆ†
    let summaryGlucose = 0
    let summarySteps = 0
    if (scoreData.status === 'fulfilled' && scoreData.value) {
      const sd = scoreData.value
      summaryGlucose = sd.latest_glucose?.value ?? 0
      summarySteps = sd.steps_today ?? 0
    }

    // ç”¨æˆ·è¯Šæ–­ â†’ åŠ¨æ€é€‰æ‹©æŒ‡æ ‡
    if (profileRes.status === 'fulfilled' && profileRes.value) {
      const pf = profileRes.value
      userDiagnoses.value = pf.diagnoses || (pf.diagnosis ? [pf.diagnosis] : [])
    }

    // Helper: deduplicate by day (keep first per day) and sort ascending (oldestâ†’newest)
    const dedup = (arr: any[], dateKey: string) => {
      const seen = new Set<string>()
      const unique = arr.filter((r: any) => {
        const day = (r[dateKey] || '').slice(0, 10)
        if (!day || seen.has(day)) return false
        seen.add(day)
        return true
      })
      unique.sort((a: any, b: any) => (a[dateKey] || '').localeCompare(b[dateKey] || ''))
      return unique.slice(-7)
    }

    // 7å¤©è¡€ç³–è¶‹åŠ¿ â€” backend returns { readings: [{value, recorded_at, ...}], statistics, period }
    if (gluRes.status === 'fulfilled' && gluRes.value) {
      const raw = gluRes.value.readings || gluRes.value.records || gluRes.value.data || (Array.isArray(gluRes.value) ? gluRes.value : [])
      const records = dedup(raw, 'recorded_at')
      if (records.length > 0) {
        const vals = records.map((r: any) => r.value || r.glucose || 0)
        const lbls = records.map((r: any) => (r.recorded_at || '').slice(5, 10))
        const latest = vals[vals.length - 1]
        const t = computeTrend(vals)
        glucoseTrend.value = { ...glucoseTrend.value, data: vals, labels: lbls, latest: latest.toFixed(1), trendArrow: t.arrow, trendDir: t.dir, trendText: t.text }
      }
    }

    // 7å¤©ä½“é‡è¶‹åŠ¿ â€” backend returns { records: [{weight_kg, bmi, recorded_at, ...}], trend, total }
    if (wtRes.status === 'fulfilled' && wtRes.value) {
      const raw = wtRes.value.records || wtRes.value.data || (Array.isArray(wtRes.value) ? wtRes.value : [])
      const records = dedup(raw, 'recorded_at')
      if (records.length > 0) {
        const vals = records.map((r: any) => r.weight_kg || r.value || r.weight || 0)
        const lbls = records.map((r: any) => (r.recorded_at || '').slice(5, 10))
        const latest = vals[vals.length - 1]
        const t = computeTrend(vals)
        weightTrend.value = { ...weightTrend.value, data: vals, labels: lbls, latest: latest.toFixed(1), trendArrow: t.arrow, trendDir: t.dir, trendText: t.text }
      }
    }

    // 7å¤©è¿åŠ¨è¶‹åŠ¿ â€” backend returns { records: [{date, steps, active_minutes, ...}], total }
    if (exRes.status === 'fulfilled' && exRes.value) {
      const raw = exRes.value.records || exRes.value.items || (Array.isArray(exRes.value) ? exRes.value : [])
      // Activity uses 'date' field, already one-per-day; sort ascending
      const records = [...raw].sort((a: any, b: any) => (a.date || '').localeCompare(b.date || '')).slice(-7)
      if (records.length > 0) {
        const vals = records.map((r: any) => r.active_minutes || r.duration || r.minutes || 0)
        const lbls = records.map((r: any) => (r.date || '').slice(5, 10))
        const total = vals.reduce((s: number, v: number) => s + v, 0)
        const t = computeTrend(vals)
        exerciseTrend.value = { ...exerciseTrend.value, data: vals, labels: lbls, latest: String(total), trendArrow: t.arrow, trendDir: t.dir, trendText: `7å¤©å…± ${total} åˆ†é’Ÿ` }
      }
    }

    // è¡€å‹è¶‹åŠ¿ â€” backend returns { records: [{systolic, diastolic, recorded_at, ...}], statistics, total }
    if (bpRes.status === 'fulfilled' && bpRes.value) {
      const raw = bpRes.value.records || (Array.isArray(bpRes.value) ? bpRes.value : [])
      const records = dedup(raw, 'recorded_at')
      if (records.length > 0) {
        const vals = records.map((r: any) => r.systolic || 0)
        const lbls = records.map((r: any) => (r.recorded_at || '').slice(5, 10))
        const latestRec = records[records.length - 1]
        const latestStr = `${latestRec.systolic || '--'}/${latestRec.diastolic || '--'}`
        const t = computeTrend(vals)
        bpTrend.value = { ...bpTrend.value, data: vals, labels: lbls, latest: latestStr, trendArrow: t.arrow, trendDir: t.dir, trendText: t.text }
      }
    }

    // ä»»åŠ¡åˆ—è¡¨ + è¿ç»­å¤©æ•° + å®Œæˆç‡
    let taskCompletionPct = 0
    if (tasksData.status === 'fulfilled' && tasksData.value) {
      const rawTasks = tasksData.value
      const taskList = rawTasks?.tasks || (Array.isArray(rawTasks) ? rawTasks : [])
      taskCompletionPct = rawTasks?.completion_pct ?? 0
      streakDays.value = rawTasks?.streak_days ?? 0
      const emojiMap: Record<string, string> = {
        glucose: 'ğŸ©¸', weight: 'âš–ï¸', exercise: 'ğŸƒ', ç›‘æµ‹: 'ğŸ©¸',
        mood: 'ğŸ˜Š', assessment: 'ğŸ“‹', nutrition: 'ğŸ', è¥å…»: 'ğŸ',
        emotion: 'ğŸ’›', sleep: 'ğŸ˜´', ç¡çœ : 'ğŸ˜´', è¿åŠ¨: 'ğŸƒ',
        æƒ…ç»ª: 'ğŸ’›', å­¦ä¹ : 'ğŸ“–', ç”¨è¯: 'ğŸ’Š',
      }
      priorityTasks.value = taskList.map((t: any) => ({
        id: t.id,
        name: t.title || t.tag || 'ä»»åŠ¡',
        hint: t.time_hint ? `å»ºè®®æ—¶é—´: ${t.time_hint}` : undefined,
        emoji: emojiMap[t.type || t.tag] || 'ğŸ“',
        completed: t.completed ?? t.done ?? false,
        source: t.source || 'rx',
      }))
    }

    // ç»¼åˆå¥åº·è¯„åˆ† = ä»»åŠ¡å®Œæˆ(35) + è¡€ç³–è¾¾æ ‡(25) + è¿åŠ¨(20) + è¿ç»­æ‰“å¡(20)
    {
      let score = 0
      // 1. ä»»åŠ¡å®Œæˆåº¦ â†’ æœ€é«˜ 35 åˆ†
      score += Math.round(taskCompletionPct * 0.35)
      // 2. è¡€ç³–è¾¾æ ‡ â†’ æœ€é«˜ 25 åˆ† (ç©ºè…¹ 4~7 ä¼˜ç§€, 7~10 ä¸€èˆ¬)
      if (summaryGlucose > 0) {
        if (summaryGlucose >= 4 && summaryGlucose <= 7) score += 25
        else if (summaryGlucose <= 10) score += 15
        else score += 5
      }
      // 3. è¿åŠ¨é‡ â†’ æœ€é«˜ 20 åˆ† (æ­¥æ•°/8000 * 20, ä¸Šé™20)
      score += Math.min(20, Math.round((summarySteps / 8000) * 20))
      // 4. è¿ç»­æ‰“å¡ â†’ æœ€é«˜ 20 åˆ† (æ¯å¤© +4, ä¸Šé™20)
      score += Math.min(20, streakDays.value * 4)
      healthScore.value = Math.min(100, score)
    }

    // AI æ¯æ—¥æç¤º
    if (summaryData.status === 'fulfilled' && summaryData.value) {
      const tip = summaryData.value
      const tipText = tip.tip || tip.summary || tip.content || ''
      if (tipText) {
        dailyTip.value = { icon: 'ğŸ’¡', title: 'AI å¥åº·å»ºè®®', content: tipText }
      }
    }

  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error)
    message.error('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
  } finally {
    loading.value = false
  }
}

onMounted(() => {
  loadData()
  loadCatalog()
})
</script>

<style scoped>
.client-home-optimized {
  min-height: 100vh;
  background: #f5f7fa;
  padding-bottom: 80px;
}

/* 1. é¡¶éƒ¨é—®å€™åŒº */
.welcome-section {
  background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
  padding: 24px 20px 32px;
  border-radius: 0 0 32px 32px;
}

.welcome-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.greeting-time {
  color: rgba(255,255,255,0.9);
  font-size: 15px;
  margin-bottom: 4px;
}

.greeting-name {
  color: #fff;
  font-size: 28px;
  font-weight: 700;
}

.user-avatar {
  background: rgba(255,255,255,0.25) !important;
  border: 3px solid rgba(255,255,255,0.5);
  color: #fff !important;
  font-size: 20px !important;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.2s;
}

.user-avatar:hover {
  transform: scale(1.05);
}

.health-score-wrapper {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 20px;
  display: flex;
  justify-content: center;
}

/* 2. ä¸»å†…å®¹åŒº */
.main-content {
  max-width: 640px;
  margin: -20px auto 0;
  padding: 0 16px;
  position: relative;
  z-index: 10;
}

.section-card {
  background: #fff;
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 2px 16px rgba(0,0,0,0.06);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 16px 0;
}

/* å…³æ³¨æŒ‡æ ‡è¶‹åŠ¿ */
.health-trends { padding-bottom: 8px; }
.trends-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.trends-more {
  font-size: 13px;
  color: #10b981;
  cursor: pointer;
  font-weight: 500;
}
.trend-cards {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.trend-card {
  background: #f9fafb;
  border-radius: 14px;
  padding: 12px 14px 6px;
  cursor: pointer;
  border-left: 4px solid #10b981;
  transition: all 0.2s;
}
.trend-card:hover {
  background: #f3f4f6;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.trend-card-top {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 2px;
}
.trend-icon { font-size: 16px; }
.trend-label { font-size: 13px; color: #6b7280; font-weight: 500; }
.trend-arrow {
  margin-left: auto;
  font-size: 16px;
  font-weight: 700;
}
.trend-arrow.up { color: #ef4444; }
.trend-arrow.down { color: #10b981; }
.trend-arrow.stable { color: #9ca3af; }
.trend-card-mid {
  display: flex;
  align-items: baseline;
  gap: 4px;
  margin-bottom: 2px;
}
.trend-latest {
  font-size: 24px;
  font-weight: 700;
  color: #1f2937;
}
.trend-unit {
  font-size: 12px;
  color: #9ca3af;
}
.trend-sparkline {
  height: 50px;
  overflow: hidden;
  margin: 0 -4px;
}
.trend-card-foot {
  font-size: 11px;
  color: #9ca3af;
  text-align: right;
  padding-bottom: 4px;
}

/* å¿«é€Ÿå…¥å£ç´§å‡‘è¡Œ */
.quick-row { padding: 10px 16px; }
.quick-items {
  display: flex;
  justify-content: space-around;
}
.quick-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  font-size: 12px;
  color: #6b7280;
  font-weight: 500;
  padding: 6px 12px;
  border-radius: 10px;
  transition: background 0.2s;
}
.quick-item:hover { background: #f3f4f6; }
.quick-icon { font-size: 24px; }

/* æ¯æ—¥æç¤º */
.daily-tip {
  background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  border: 2px solid #bfdbfe;
}

.tip-header {
  display: flex;
  gap: 16px;
  align-items: flex-start;
}

.tip-icon-large {
  font-size: 40px;
  flex-shrink: 0;
}

.tip-title {
  font-size: 16px;
  font-weight: 600;
  color: #1e40af;
  margin-bottom: 6px;
}

.tip-text {
  font-size: 14px;
  color: #1e3a8a;
  line-height: 1.6;
}

/* åº•éƒ¨å¯¼èˆª */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 8px 0 20px;
  box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
  z-index: 100;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  color: #9ca3af;
  font-size: 11px;
  cursor: pointer;
  transition: color 0.2s;
}

.nav-item:hover {
  color: #10b981;
}

.nav-item.active {
  color: #10b981;
  font-weight: 600;
}

.nav-item :deep(.anticon) {
  font-size: 24px;
}

.nav-item.center-btn {
  margin-top: -24px;
}

.center-icon {
  width: 56px;
  height: 56px;
  background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  box-shadow: 0 4px 16px rgba(16,185,129,0.4);
}

.center-icon :deep(.anticon) {
  font-size: 28px;
}

/* æ›´å¤šåŠŸèƒ½æŠ½å±‰ */
.more-menu {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  padding: 20px;
}

.more-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 20px;
  background: #f9fafb;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s;
}

.more-item:hover {
  background: #f3f4f6;
  transform: translateY(-4px);
}

.more-icon {
  font-size: 40px;
}

.more-label {
  font-size: 14px;
  font-weight: 500;
  color: #1f2937;
}

/* ä»»åŠ¡åŒºåŸŸå¤´éƒ¨ */
.task-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

/* ç©ºä»»åŠ¡çŠ¶æ€ */
.empty-tasks {
  text-align: center;
  padding: 24px 0;
}
.empty-icon {
  font-size: 40px;
  margin-bottom: 8px;
}
.empty-text {
  color: #9ca3af;
  margin-bottom: 12px;
}

/* ç›®å½•åˆ†ç»„ */
.catalog-groups {
  padding-bottom: 20px;
}
.catalog-group {
  margin-bottom: 16px;
}
.catalog-group-label {
  font-weight: 600;
  font-size: 15px;
  color: #374151;
  margin-bottom: 8px;
  padding-left: 4px;
}
.catalog-items {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.catalog-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border-radius: 20px;
  border: 1px solid #e5e7eb;
  background: #fff;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}
.catalog-item:hover {
  border-color: #667eea;
  background: #f0f4ff;
}
.catalog-item-added {
  border-color: #10b981;
  background: #ecfdf5;
  color: #059669;
}
.catalog-icon {
  font-size: 16px;
}
.catalog-title {
  flex: 1;
}
.catalog-plus {
  color: #9ca3af;
  font-size: 12px;
}
.catalog-check {
  color: #10b981;
  font-weight: 600;
}

/* åº†ç¥è¦†ç›–å±‚ */
.celebrate-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  backdrop-filter: blur(4px);
}

.celebrate-card {
  background: #fff;
  border-radius: 24px;
  padding: 36px 32px 28px;
  text-align: center;
  max-width: 300px;
  width: 80%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  animation: celebratePop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes celebratePop {
  0% {
    opacity: 0;
    transform: scale(0.5);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.celebrate-emoji {
  font-size: 64px;
  margin-bottom: 12px;
  animation: celebrateBounce 0.6s ease 0.3s;
}

@keyframes celebrateBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}

.celebrate-title {
  font-size: 22px;
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 8px;
}

.celebrate-msg {
  font-size: 15px;
  color: #4b5563;
  line-height: 1.5;
  margin-bottom: 16px;
}

.celebrate-points {
  display: inline-block;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  color: #92400e;
  font-size: 18px;
  font-weight: 700;
  padding: 6px 20px;
  border-radius: 20px;
  margin-bottom: 12px;
}

.celebrate-remaining {
  font-size: 13px;
  color: #9ca3af;
}

/* åº†ç¥åŠ¨ç”»è¿‡æ¸¡ */
.celebrate-fade-enter-active {
  transition: opacity 0.3s ease;
}

.celebrate-fade-leave-active {
  transition: opacity 0.4s ease;
}

.celebrate-fade-enter-from,
.celebrate-fade-leave-to {
  opacity: 0;
}
</style>
