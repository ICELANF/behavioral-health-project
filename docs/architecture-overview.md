# 行为健康数字平台 — 架构总览 (v11 归档)

> **此文档已归档，最新版本请查看: [platform-architecture-overview.md](platform-architecture-overview.md) (v17)**
>
> 最后更新: 2026-02-01
> 版本: v11
> 状态: 已归档

---

## 一、平台全景架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          用户接入层 (Frontend)                               │
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐ │
│  │  C端患者门户  │  │  教练工作台   │  │  专家督导台   │  │   管理后台       │ │
│  │  :5177/client │  │ :5177/coach  │  │ :5177/expert │  │  :5177/dashboard │ │
│  │  (自我管理)   │  │  (干预执行)   │  │  (质量监督)   │  │  (系统配置)      │ │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └───────┬──────────┘ │
│         │                 │                 │                   │            │
│  ┌──────┴─────┐    ┌──────┴──────┐                                          │
│  │ H5移动端   │    │ UI组件库    │                                           │
│  │ :5173      │    │ :5176       │                                           │
│  │(Vant移动UI)│    │(Tailwind)   │                                           │
│  └────────────┘    └─────────────┘                                          │
└───────────────────────────┬─────────────────────────────────────────────────┘
                            │ HTTP / WebSocket
┌───────────────────────────┴─────────────────────────────────────────────────┐
│                         服务层 (Backend Services)                            │
│                                                                             │
│  ┌──────────────────┐  ┌───────────────────┐  ┌──────────────────────────┐  │
│  │ 决策引擎 :8002   │  │  主API网关 :8000  │  │  质量审计服务 :8003     │  │
│  │ (FastAPI)        │  │  (FastAPI)        │  │  (FastAPI)              │  │
│  │ ·CGM数据接入     │  │  ·用户认证        │  │  ·教练行为审计          │  │
│  │ ·干预策略生成    │  │  ·评估API         │  │  ·AI建议质量检查        │  │
│  │ ·AI对话(同步)    │  │  ·Agent编排       │  │  ·干预效果追踪          │  │
│  │ ·小程序API       │  │  ·设备数据        │  │                        │  │
│  └────────┬─────────┘  └────────┬──────────┘  └──────────────────────────┘  │
│           │                     │                                           │
│  ┌────────┴─────────────────────┴──────────────────────────────────────┐    │
│  │                    核心引擎层 (Core Engines)                         │    │
│  │                                                                     │    │
│  │  ┌─────────────┐ ┌──────────────┐ ┌────────────┐ ┌──────────────┐  │    │
│  │  │ 评估引擎    │ │ 触发引擎     │ │ 决策核心   │ │ BAPS评估体系 │  │    │
│  │  │ assessment  │ │ trigger      │ │ decision   │ │ 4大量表      │  │    │
│  │  │ _engine.py  │ │ _engine.py   │ │ _core.py   │ │ 评分引擎     │  │    │
│  │  │ 17KB        │ │ 3.4KB        │ │ 2.5KB      │ │ 报告生成     │  │    │
│  │  └─────────────┘ └──────────────┘ └────────────┘ └──────────────┘  │    │
│  │                                                                     │    │
│  │  ┌─────────────┐ ┌──────────────┐ ┌────────────┐ ┌──────────────┐  │    │
│  │  │ Agent编排器 │ │ Agent路由    │ │ Agent注册  │ │ 八爪鱼引擎   │  │    │
│  │  │orchestrator │ │ router.py    │ │ registry   │ │ octopus      │  │    │
│  │  │ 9KB         │ │ 7.1KB        │ │ 3.3KB      │ │ _engine 9.6KB│  │    │
│  │  └─────────────┘ └──────────────┘ └────────────┘ └──────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────┬─────────────────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────────────────┐
│                        AI/LLM 层 (Intelligence)                             │
│                                                                             │
│  ┌──────────────────┐              ┌──────────────────────────────────────┐  │
│  │ Ollama :11434    │              │  Dify :8080                         │  │
│  │ qwen2.5:7b       │              │  ·工作流编排                        │  │
│  │ ·对话生成        │              │  ·知识库RAG                         │  │
│  │ ·评估辅助        │              │  ·多Agent路由                       │  │
│  │ ·跟进内容        │              │  ·Proactive Health Coach            │  │
│  └──────────────────┘              └──────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────────────────┐
│                         数据层 (Data)                                        │
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ PostgreSQL   │  │ Redis        │  │ Weaviate     │  │ 文件存储      │    │
│  │ :5432        │  │ :6379        │  │ 向量数据库   │  │ knowledge/    │    │
│  │ 18张数据表   │  │ 会话缓存     │  │ 语义检索     │  │ Obsidian知识库│    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、版块详解

### 2.1 前端应用层

#### A. Admin Portal（管理后台）— 端口 5177

四类角色统一登录入口，Vue 3 + Ant Design Vue。

| 角色 | 入口路由 | 页面数 | 核心功能 |
|------|---------|--------|---------|
| **患者 (C端)** | `/client` | 2 | 健康仪表盘、AI对话、任务打卡、用药提醒、健康指标 |
| **教练 (B端)** | `/coach-portal` | 1+抽屉 | 学员管理、AI建议审核、跟进对话、评估量表、目标设定 |
| **专家 (督导)** | `/expert-portal` | 1+抽屉 | 案例监督、教练评估、质量审计、统计看板 |
| **管理员** | `/dashboard` | 20+ | 课程/考试/直播/教练/学员/干预包/Prompt/设置 |

```
管理员后台路由树:
├── /dashboard          工作台概览
├── /course/*           课程管理 (列表/创建/编辑/章节)
├── /question/*         题库管理 (列表/创建/编辑)
├── /exam/*             考试管理 (列表/创建/编辑/成绩/监考)
├── /live/*             直播管理 (列表/创建/编辑)
├── /coach/*            教练管理 (列表/详情/晋级审核)
├── /student            学员管理
├── /prompts/*          Prompt模板管理
├── /interventions      干预包管理
└── /settings           系统设置
```

#### B. H5 移动端 — 端口 5173

患者移动端应用，Vue 3 + Vant 4（移动UI组件库）。

| 页面 | 路由 | 功能 |
|------|------|------|
| 首页 | `/` | 欢迎卡片、效能感评分、快捷入口、专家团队、今日任务 |
| AI对话 | `/chat` | 多专家选择、消息气泡、效能感滑块、可穿戴数据输入 |
| 任务 | `/tasks` | 每日任务清单 |
| 看板 | `/dashboard` | 健康数据分析 |
| 我的 | `/profile` | 个人健康档案 |

#### C. UI组件库 — 端口 5176

行为健康专用组件库演示，Vue 3 + Tailwind CSS。

| 视图 | 内容 |
|------|------|
| C端用户 | 任务清单、行为处方卡片、进度图表、健康指标、用药提醒 |
| B端教练 | 共情看板、处方推荐器、用户健康监测、用药概览、调试面板 |
| 组件文档 | 四阶段模型、完成状态、风险等级、健康指标API文档、用药提醒组件文档 |

---

### 2.2 后端服务层

#### A. 决策引擎（主运行服务）— 端口 8002

文件: `D:\behavioral-health-project\main.py` (179行)

**当前实际运行的核心服务**，负责：

| 端点 | 方法 | 功能 | 状态 |
|------|------|------|------|
| `/intervene` | POST | CGM数据接入→干预策略生成 | ✅ 运行中 |
| `/latest_status` | GET | 获取最新血糖+历史数据 | ✅ 运行中 |
| `/chat` | POST | AI对话（SSE流式） | ✅ 运行中 |
| `/chat_sync` | POST | AI对话（同步返回） | ✅ 运行中 |
| `/api/v1/mp/task/today` | GET | 今日任务 | ✅ 运行中 |
| `/api/v1/mp/user/state` | GET | 用户状态（积分/天数） | ✅ 运行中 |
| `/api/v1/mp/progress/summary` | GET | 进度摘要 | ✅ 运行中 |
| `/api/v1/mp/task/feedback` | POST | 任务反馈 | ✅ 运行中 |
| `/api/v1/mp/agent/reply` | POST | Agent AI回复 | ✅ 运行中 |

#### B. 主API网关 — 端口 8000

文件: `D:\behavioral-health-project\api\main.py` (23KB)

完整的REST API网关，含编排器、评估、认证等：

| 模块 | 端点前缀 | 功能 |
|------|---------|------|
| 编排器 | `/orchestrator/*` | Master Agent 9步流程、Agent路由、多Agent协调 |
| 评估 | `/api/assessment/*` | BAPS评估创建/查询/结果 |
| 认证 | `/api/auth/*` | 登录/注册/登出 |
| 对话 | `/api/v1/chat` | 聊天消息/历史 |
| 设备 | `/api/v1/mp/device-data` | 设备数据上传 |
| 分发 | `/api/v1/dispatch` | Dify/Ollama 智能路由 |

#### C. 质量审计服务 — 端口 8003

教练行为审计、AI建议质量检查、干预效果追踪。

---

### 2.3 核心引擎层

#### A. 评估引擎 (`core/assessment_engine.py` — 17KB)

L2级评估系统，四模块架构：

```
输入 (文本/HRV/血糖/用户画像)
  ↓
①触发识别 → 20+触发因子 (high_glucose, stress_overload, depression_sign...)
  ↓
②风险评估 → R0(正常) ~ R4(危机) 五级风险
  ↓
③Agent路由 → 主Agent + 3辅助Agent (加权评分排序)
  ↓
④干预匹配 → 个性化干预方案
```

**触发因子分类:**

| 类别 | 触发因子 |
|------|---------|
| 生理 | high_glucose, low_glucose, glucose_spike |
| 心理 | high_stress_hrv, high_anxiety, depression_sign |
| 行为 | task_failure, low_adherence, low_motivation, sedentary |
| 环境 | work_stress, poor_sleep |

**风险评分公式:** `Critical×40 + High×20 + Moderate×10 + Low×5`

#### B. BAPS 评估体系 (`core/baps/` — 66KB)

**平台核心竞争力** — 四维行为评估框架：

| 量表 | 题数 | 评估维度 | 产出 |
|------|------|---------|------|
| **大五人格** BigFive | 50 | 外向性/神经质/尽责性/宜人性/开放性 | 人格基线画像 |
| **BPT-6 行为分型** | 18 | 执行型/知识型/情绪型/关系型/环境型/矛盾型 | 行为改变模式 |
| **CAPACITY 改变力** | 32 | 意识/自主/匹配/资源/承诺/认同/时间/期望 | 改变准备度(32-160分) |
| **SPI 成功指数** | 50 | 动机30%/能力25%/支持20%/环境15%/历史10% | 成功率预测(<15%~>75%) |

**评分引擎:** `scoring_engine.py` (26KB) — 反向计分、维度分析、星级评定、交叉分析
**报告生成:** `report_generator.py` (16KB) — 完整评估报告生成

#### C. 触发引擎 (`core/trigger_engine.py` — 3.4KB)

实时健康数据触发检测：
- 血糖 > 10.0 → `high_glucose` (HIGH)
- 血糖 < 3.9 → `low_glucose` (CRITICAL)
- 血糖波动 > 3.0 → `glucose_spike` (MODERATE)
- HRV异常 → `high_stress_hrv`

#### D. Agent 系统 (`agents/` — 48KB)

| 组件 | 文件 | 功能 |
|------|------|------|
| 注册中心 | `registry.py` | Agent动态注册与发现 |
| 意图路由 | `router.py` | 关键词匹配→专家路由 |
| 编排器 | `orchestrator.py` | Master Agent 9步流程 |
| 八爪鱼引擎 | `octopus_engine.py` | FSM状态机Agent编排 |
| 工作流 | `workflow_engine.py` | Agent工作流执行 |
| 协作 | `collaboration.py` | 多Agent协同机制 |

**可路由的AI Agent:**

| Agent | 触发条件 | 优先级 |
|-------|---------|--------|
| CrisisAgent | 自杀倾向/危机事件 | P1(立即) |
| GlucoseAgent | 血糖异常 | P2(24h内) |
| MetabolicAgent | 代谢综合征 | P2 |
| StressAgent | HRV异常/高压力 | P2 |
| MentalHealthAgent | 焦虑/抑郁征兆 | P2 |
| NutritionAgent | 饮食相关 | P3 |
| ExerciseAgent | 运动相关 | P3 |
| SleepAgent | 睡眠质量差 | P3 |
| MotivationAgent | 动机不足 | P3 |
| CoachingAgent | 一般教练指导 | P4 |
| TCMAgent | 中医养生 | P4 |

---

### 2.4 AI/LLM 层

| 服务 | 端口 | 模型 | 用途 |
|------|------|------|------|
| **Ollama** | 11434 | qwen2.5:7b | 对话生成、评估辅助、教练跟进内容 |
| **Dify** | 8080 | qwen2.5:7b (via Ollama) | 工作流编排、知识库RAG、多Agent路由 |

**Dify 工作流:**
- Proactive Health Coach (主动健康教练)
- Proactive Health Balance (吃动守恒)
- Behavior Health Agent (行为健康Agent)

**LLM路由策略:** `auto` → 优先Dify，失败回退Ollama

---

### 2.5 数据层

**PostgreSQL 18张核心表:**

| 表 | 存储内容 |
|----|---------|
| `users` | 用户画像、角色、依从率 |
| `assessments` | L2评估记录、风险等级、主Agent |
| `trigger_records` | 触发因子记录、严重度、置信度 |
| `interventions` | 干预方案、状态、用户反馈 |
| `health_data` | 通用健康数据(血糖/HRV/血压等) |
| `glucose_readings` | CGM血糖读数、趋势、餐标签 |
| `hrv_readings` | HRV(SDNN/RMSSD)、压力分 |
| `sleep_records` | 睡眠时长、阶段、质量分 |
| `activity_records` | 步数、距离、卡路里、久坐 |
| `chat_sessions/messages` | AI对话会话和消息 |
| `user_devices` | 设备绑定(CGM/手表等) |
| `vital_signs` | 体征数据(血压/体温/血氧) |

---

## 三、版块间逻辑关系

### 3.1 四类角色交互闭环

```
                    ┌──────────┐
                    │ 系统管理员 │
                    │ (配置规则) │
                    └─────┬────┘
                          │ 配置评估量表、干预包、Prompt模板、课程
                          ▼
┌──────────┐    审核确认   ┌──────────┐    质量监督    ┌──────────┐
│  患者     │◄────────────│  教练     │◄──────────────│  专家     │
│          │             │          │               │          │
│ ·完成问卷 │────────────→│ ·查看评估 │──────────────→│ ·审核阶段 │
│ ·健康打卡 │  数据上报    │ ·审核AI建议│  案例上报     │ ·修正评估 │
│ ·接收建议 │             │ ·推送干预 │               │ ·策略指导 │
│ ·AI对话   │◄────────────│ ·跟进对话 │◄──────────────│ ·培训教练 │
│ ·用药打卡 │  推送建议    │ ·目标设定 │  反馈指导     │ ·统计分析 │
└──────────┘             └──────────┘               └──────────┘
      │                       │                          │
      └───────────┬───────────┘                          │
                  ▼                                      │
            ┌──────────┐                                 │
            │ AI引擎    │◄────────────────────────────────┘
            │          │  专家可调整AI策略参数
            │ ·评估分析 │
            │ ·干预建议 │
            │ ·风险预警 │
            └──────────┘
```

### 3.2 数据流向

```
CGM/可穿戴设备 ──→ 决策引擎(:8002) ──→ 触发引擎 ──→ 评估引擎
                         │                              │
                         ▼                              ▼
                    实时指标展示                    风险等级+Agent路由
                    (C端+B端同步)                        │
                                                        ▼
问卷填写(C端) ──→ BAPS评分引擎 ──→ 行为阶段判定 ──→ 干预包匹配
                                        │                │
                                        ▼                ▼
                                教练/专家审核确认    推送到患者端
                                        │
                                        ▼
                                  阶段结果存储
                              (非患者主动可见)
```

### 3.3 评估流程（核心业务流）

```
Step 1: 患者完成BAPS四维评估 (150题)
        ├── 大五人格 (50题) → 人格画像
        ├── BPT-6 (18题) → 行为模式分型
        ├── CAPACITY (32题) → 改变准备度
        └── SPI (50题) → 成功率预测

Step 2: 系统自动计算
        ├── 行为阶段 (TTM: 前意向→意向→准备→行动→维持→终止)
        ├── 风险等级 (R0~R4)
        ├── 行为模式类型
        └── 改变力评分

Step 3: 教练审阅
        ├── 查看评估报告
        ├── 确认或标注异议
        └── 制定干预计划

Step 4: 专家审核 (高风险/敏感案例)
        ├── 审核评估准确性
        ├── 修正阶段判定
        └── 决定信息披露范围

Step 5: 结果应用
        ├── 教练端: 显示阶段+报告+干预建议
        ├── 专家端: 完整报告+统计分析
        ├── 患者端: 仅正向引导语 (不暴露阶段标签)
        └── 管理端: 脱敏统计数据
```

---

## 四、当前进度

### 4.1 已完成 ✅

| 模块 | 完成项 | 说明 |
|------|--------|------|
| **前端四角色** | 登录/页面/导航/退出 | 四角色独立视图均可访问并交互 |
| **患者端** | 健康仪表盘/AI对话/任务打卡/用药提醒 | 实时数据从后端引擎获取，10秒刷新 |
| **教练端** | 学员管理/AI审核/跟进对话/评估量表/目标设定/设置 | AI跟进通过Ollama生成，5个快捷模板 |
| **专家端** | 督导看板/案例审核/教练评估 | 基础框架完成 |
| **管理端** | 课程/考试/直播/教练/学员/干预包/Prompt/设置 | 20+页面完整 |
| **决策引擎** | CGM接入/干预生成/AI对话/小程序API | 端口8002运行中，实时处理数据 |
| **BAPS评估** | 四大量表/评分引擎/报告生成 | 后端代码完整(66KB) |
| **Agent系统** | 注册/路由/编排/协作/八爪鱼引擎 | 11种专业Agent可路由 |
| **数据库** | 18张表ORM模型 | 完整schema定义 |
| **AI/LLM** | Ollama + Dify双通道 | qwen2.5:7b运行中 |
| **UI组件库** | C端/B端/文档三视图 | 健康指标+用药提醒已同步 |
| **实时监测** | CGM血糖→前端指标卡片 | 推送数据后前端自动更新 |
| **用药提醒** | 打卡/药物说明/注意事项 | 三处前端统一展示 |

### 4.2 待完成 🔲

| 模块 | 待办项 | 优先级 |
|------|--------|--------|
| **评估流程前端** | BAPS问卷填写界面 (C端) | 🔴 高 |
| **评估结果展示** | 教练端评估报告查看界面 | 🔴 高 |
| **阶段权限控制** | C端隐藏阶段标签，仅正向引导 | 🔴 高 |
| **评估审核流程** | 专家审核+修正评估结果 | 🔴 高 |
| **信息披露规则** | 管理员配置哪些信息对患者可见 | 🟡 中 |
| **BAPS→前端API** | 评估引擎接口接入前端 | 🟡 中 |
| **Agent实际调用** | 前端聊天接入真实Agent路由 | 🟡 中 |
| **设备数据对接** | HRV/睡眠/运动数据实时接入 | 🟡 中 |
| **数据库实际连接** | PostgreSQL替代内存mock数据 | 🟡 中 |
| **教练晋级考试** | 考试系统与教练等级联动 | 🟢 低 |
| **直播功能** | 实际推流/拉流对接 | 🟢 低 |
| **微信小程序** | 小程序端打包部署 | 🟢 低 |

### 4.3 当前运行服务清单

| 端口 | 服务 | 进程 | 状态 |
|------|------|------|------|
| 8000 | Django/FastAPI 主API | Python | ✅ 运行中 |
| 8002 | 决策引擎+小程序API | Python/FastAPI | ✅ 运行中 |
| 8003 | 质量审计服务 | Python/FastAPI | ✅ 运行中 |
| 8080 | Dify LLM平台 | Docker | ✅ 运行中 |
| 5173 | H5 移动端 | Vite/Vue3 | ✅ 运行中 |
| 5176 | UI组件库 | Vite/Vue3 | ✅ 运行中 |
| 5177 | Admin Portal (四角色) | Vite/Vue3 | ✅ 运行中 |
| 11434 | Ollama LLM | Ollama | ✅ 运行中 |

---

## 五、技术栈总览

| 层 | 技术 |
|----|------|
| **前端** | Vue 3 + TypeScript + Vite |
| **桌面UI** | Ant Design Vue 4 |
| **移动UI** | Vant 4 |
| **组件库UI** | Tailwind CSS |
| **后端** | Python 3.11 + FastAPI |
| **数据库** | PostgreSQL + Redis + Weaviate |
| **ORM** | SQLAlchemy |
| **LLM** | Ollama (qwen2.5:7b) + Dify |
| **容器** | Docker Compose |
| **实时通信** | SSE (Server-Sent Events) |
| **认证** | JWT Token |

---

## 六、代码量统计

| 目录 | 文件数 | 总大小 | 说明 |
|------|--------|--------|------|
| `core/` | 17 .py | ~450KB | 核心引擎(含254KB master_agent_v0) |
| `core/baps/` | 4 .py | ~67KB | BAPS评估体系 |
| `api/` | 19 .py | ~230KB | API层(含57KB device_data) |
| `agents/` | 12 files | ~58KB | Agent系统 |
| `admin-portal/src/` | 50+ files | ~400KB | 管理后台前端 |
| `h5/src/` | 15 files | ~30KB | 移动端前端 |
| `scripts/` | 6 .py | ~195KB | 工具脚本 |
