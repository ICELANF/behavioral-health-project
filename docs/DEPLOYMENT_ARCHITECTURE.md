# 行健xingjian-agent 部署架构

## 产品形态

| 平台 | 形态 | 特点 |
|------|------|------|
| **H5网页端** | 移动端网页 | 无需下载，扫码即用，适合首次体验 |
| **微信小程序** | 小程序 | 微信生态内，用户粘性高，支持订阅消息 |

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户触达层                               │
│  ┌─────────────────────┐    ┌─────────────────────────────────┐ │
│  │     H5 网页端        │    │        微信小程序                │ │
│  │  (Vue3/React)       │    │    (原生/Taro/uni-app)          │ │
│  │  - 响应式设计        │    │    - 订阅消息推送                │ │
│  │  - PWA 离线支持      │    │    - 微信登录                   │ │
│  └─────────────────────┘    └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         API 网关层                               │
│                    (Nginx / 云函数网关)                          │
│                 - 请求路由 / 限流 / 鉴权                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Dify 平台 (Docker)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐ │
│  │  聊天 API    │  │   知识库      │  │   行健xingjian-agent   │ │
│  │  /chat       │  │   RAG        │  │   - 四专家协作          │ │
│  │  /completion │  │              │  │   - 八爪鱼限幅          │ │
│  └──────────────┘  └──────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据存储层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────────────────┐ │
│  │  PostgreSQL  │  │    Redis     │  │   向量数据库            │ │
│  │  用户数据     │  │   会话缓存   │  │   知识检索              │ │
│  └──────────────┘  └──────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## H5 网页端方案

### 技术选型
- **框架**: Vue 3 + Vite 或 React + Next.js
- **UI库**: Vant (Vue) / Ant Design Mobile (React)
- **状态管理**: Pinia / Zustand
- **请求**: Axios + 封装

### 核心功能
```
H5功能模块
├── 首页
│   ├── 今日任务卡片
│   ├── 效能状态展示
│   └── 快捷入口
├── 对话页
│   ├── 与行健Agent对话
│   ├── 专家切换
│   └── 历史记录
├── 评估页
│   ├── 五大人格测评
│   └── 健康问卷
├── 进度页
│   ├── 习惯打卡
│   ├── 成就墙
│   └── 数据统计
└── 我的
    ├── 个人信息
    ├── 设置
    └── 反馈
```

### Dify API 调用示例
```javascript
// H5 调用 Dify Chat API
const chatWithAgent = async (message) => {
  const response = await fetch('https://your-domain/v1/chat-messages', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_API_KEY',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      inputs: {},
      query: message,
      response_mode: 'streaming',
      conversation_id: conversationId,
      user: userId
    })
  });
  return response;
};
```

---

## 微信小程序方案

### 技术选型
- **框架**: 原生微信小程序 或 Taro 3 / uni-app (跨端)
- **状态管理**: MobX-miniprogram / Pinia
- **UI库**: WeUI / Vant Weapp

### 核心功能
```
小程序功能模块
├── 首页 (tabBar)
│   ├── 每日推荐任务
│   ├── 效能仪表盘
│   └── 快速对话入口
├── 对话 (tabBar)
│   ├── AI对话界面
│   ├── 流式回复展示
│   └── 语音输入支持
├── 发现 (tabBar)
│   ├── 健康知识
│   ├── 案例故事
│   └── 工具推荐
├── 我的 (tabBar)
│   ├── 打卡日历
│   ├── 成就徽章
│   ├── 数据报告
│   └── 设置
└── 订阅消息
    ├── 每日提醒
    ├── 任务完成通知
    └── 周报推送
```

### 微信小程序调用示例
```javascript
// 小程序调用 Dify API
wx.request({
  url: 'https://your-domain/v1/chat-messages',
  method: 'POST',
  header: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  },
  data: {
    inputs: {},
    query: message,
    response_mode: 'blocking', // 小程序建议用blocking
    conversation_id: conversationId,
    user: openId
  },
  success: (res) => {
    console.log(res.data.answer);
  }
});
```

---

## 部署方案

### 方案一：轻量部署 (推荐起步)

```
┌────────────────┐     ┌────────────────┐
│  H5 (Vercel/   │     │  小程序云开发   │
│  Netlify)      │     │  (云函数)       │
└───────┬────────┘     └───────┬────────┘
        │                      │
        └──────────┬───────────┘
                   ▼
         ┌─────────────────┐
         │  Dify Cloud     │
         │  (官方托管)      │
         └─────────────────┘
```

### 方案二：私有化部署 (数据安全)

```
┌────────────────┐     ┌────────────────┐
│  H5 (Nginx)    │     │  小程序        │
└───────┬────────┘     └───────┬────────┘
        │                      │
        └──────────┬───────────┘
                   ▼
         ┌─────────────────┐
         │  自建服务器      │
         │  - Dify Docker  │
         │  - Ollama LLM   │
         │  - PostgreSQL   │
         └─────────────────┘
```

---

## 关键配置

### Dify 应用发布设置

1. **创建应用后 → 发布 → API 访问**
2. 获取 API Key
3. 配置 CORS 允许 H5 域名
4. 配置 IP 白名单（小程序服务器）

### 微信小程序配置

```json
// app.json
{
  "requiredPrivateInfos": ["chooseLocation"],
  "permission": {
    "scope.userLocation": {
      "desc": "用于提供本地化健康建议"
    }
  }
}
```

### 服务器域名配置

在微信公众平台配置：
- request 合法域名: `https://your-dify-domain.com`
- uploadFile 合法域名: `https://your-dify-domain.com`

---

## 下一步行动

1. [ ] 完成 Dify 初始设置 (localhost:8080)
2. [ ] 导入行健xingjian-agent 配置
3. [ ] 创建知识库并上传文档
4. [ ] 发布应用获取 API Key
5. [ ] 搭建 H5 前端框架
6. [ ] 创建微信小程序项目
7. [ ] 对接 Dify API
8. [ ] 测试与优化
