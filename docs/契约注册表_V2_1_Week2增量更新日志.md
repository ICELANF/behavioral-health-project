# 契约注册表 V2.1 增量更新日志 — Week 2 双轨晋级 + 防刷策略

> 基线: V2.0 (Week 1 交付)  
> 更新: V2.1 (Week 2 交付)  
> 日期: 2026-02-15  
> 范围: Task A 双轨晋级校验引擎 + Task B 六种防刷策略引擎

---

## 一、Week 2 交付总览

| 任务 | 契约来源 | 优先级 | 文件数 | 测试数 | 状态 |
|------|---------|--------|--------|--------|------|
| Task A: 双轨晋级校验引擎 | Sheet④⑩⑪ | P0 | 4 | 26 PASS | ✅ 完成 |
| Task B: 六种防刷策略引擎 | Sheet⑦⑩ | P0 | 3 | 29 PASS | ✅ 完成 |
| **合计** | | | **7 文件** | **55 PASS** | ✅ |

---

## 二、Task A: 双轨晋级校验引擎

### 2.1 核心公式
```
晋级 = 积分轨达标(门槛) ∧ 成长轨验证通过(判定)
```

### 2.2 L0-L5 阈值配置 (对齐 Sheet④ 第4节)

| 晋级路径 | 成长分 | 贡献分 | 影响力分 | 积分性质 | 同道者 | 仪式 | 防刷策略 |
|---------|-------|-------|---------|---------|-------|------|---------|
| L0→L1 破壳者🐣 | ≥100 | — | — | 硬性门槛 | 4人(≥2行为尝试) | 数据诚实承诺+成长契约 | AS-01 |
| L1→L2 传灯者🕯️ | ≥300 | ≥50 | — | ⚠️非硬性参考 | 4人(≥2完成S3, ≥1达S4) | 分享诚信承诺+共创契约 | AS-02,03 |
| L2→L3 持杖者🪄 | ≥800 | ≥100 | — | 硬性门槛 | 4人(≥2通过考核, ≥1教练潜力) | 伦理宣言5条+服务契约 | AS-04,06 |
| L3→L4 立柱者🏛️ | ≥1500 | ≥500 | ≥200 | 硬性三维 | 4人(≥2独立执业, ≥1项目负责人) | 专家责任宣言7条 | AS-05,06 |
| L4→L5 归源者🌊 | ≥3000 | ≥1500 | ≥800 | 硬性三维 | 4人(≥2区域标杆, ≥1大师潜力) | 行业引领宣言 | 全部6种 |

### 2.3 四种状态管理 (Sheet④ 双轨状态×引导话术)

| 状态 | 积分轨 | 成长轨 | 系统行为 | 固化话术 |
|------|-------|-------|---------|---------|
| 1 正常成长 | ❌未达标 | ❌未验证 | 正常积累 | 你正在成长的路上,每一步都有价值 |
| 2 等待验证⚠️ | ✅达标 | ❌未过 | 触发差距报告 | 活跃度已达标!接下来完成成长验证 |
| 3 成长先到(罕见) | ❌未达 | ✅通过 | 提示积分差距 | 能力已验证,继续日常活动很快达标 |
| 4 晋级就绪 | ✅达标 | ✅通过 | 启动仪式流程 | 恭喜!准备好晋级仪式了吗? |

### 2.4 组件架构

```
PromotionOrchestrator (编排器)
  ├── DualTrackChecker (双轨校验)
  │     ├── PointsService     → 积分轨校验
  │     ├── PeerTracking      → 同道者质量校验
  │     ├── StageService      → S0-S5/90天稳定/周期
  │     ├── ExamService       → 考核+伦理校验
  │     └── CompanionService  → 能力/案例校验
  ├── GapAnalyzer (差距分析)
  ├── PromotionStateManager (状态持久化)
  └── NotificationService (状态变更通知)
```

### 2.5 API 端点 (+6)

| 端点 | 方法 | 功能 |
|------|------|------|
| /v1/promotion/status | GET | 查询晋级状态 |
| /v1/promotion/gap-report | GET | 差距分析报告 |
| /v1/promotion/check | POST | 手动触发校验 |
| /v1/promotion/ceremony | POST | 启动晋级仪式 |
| /v1/promotion/peers | GET | 同道者仪表盘 |
| /v1/promotion/thresholds/{level} | GET | 查看晋级条件(公开) |

### 2.6 测试覆盖 (26/26 PASS)

| 测试区间 | 覆盖范围 | 数量 |
|---------|---------|------|
| DTK-01~05b | L0-L5阈值配置正确性 | 6 |
| DTK-06~09 | 四种状态判定 | 4 |
| DTK-10~13 | 积分轨校验(精确/低于/软门槛/三维) | 4 |
| DTK-14~17 | 成长轨校验(同道者/90天/伦理/周期) | 4 |
| DTK-18~20 | 差距分析报告 | 3 |
| DTK-21~23 | 晋级仪式流程 | 3 |
| DTK-24~25 | 边界场景 | 2 |

---

## 三、Task B: 六种防刷策略引擎

### 3.1 策略矩阵 (对齐 Sheet⑦)

| 编号 | 策略 | 机制 | 用户感知 | 阻断行为 |
|------|------|------|---------|---------|
| AS-01 | 每日上限 | 同一行为每日上限, 次日重置 | 「今日已达上限」 | 硬性阻断, 0分 |
| AS-02 | 质量加权 | 高质量×2, 低质量×0.5 | 不展示倍率 | 积分调整 |
| AS-03 | 时间衰减 | 重复执行递减(1→0.8→0.5→0.2) | 「尝试不同行为」 | 积分衰减 |
| AS-04 | 交叉验证 | 涉及他人→对方确认后发放 | 「等待确认中」 | 暂扣积分 |
| AS-05 | 成长轨校验 | 积分达标但成长未过→状态2 | 见双轨引擎 | 不阻断积分, 阻断晋级 |
| AS-06 | 异常检测 | 1h>20次或突发>8次/60s→标记 | **不提示**(避免对抗) | 标记审查, 不阻断 |

### 3.2 流水线执行顺序

```
请求 → AS-06 异常检测 (先标记)
     → AS-01 每日上限 (硬性阻断 → 短路)
     → AS-04 交叉验证 (等待确认 → 短路)
     → AS-03 时间衰减 (积分调整)
     → AS-02 质量加权 (在衰减后叠加)
     → AS-05 成长轨校验 (附加信息)
     → 最终积分
```

### 3.3 衰减曲线 (AS-03)

| 周期内次数 | 倍率 | 示例(10分基础) |
|-----------|------|---------------|
| 1-5次 | ×1.0 | 10分 |
| 6-10次 | ×0.8 | 8分 |
| 11-20次 | ×0.5 | 5分 |
| 21次起 | ×0.2 | 2分(最低1分) |

### 3.4 质量加权等级 (AS-02)

| 质量评分 | 倍率 | 等级 |
|---------|------|------|
| ≥0.8 | ×2.0 | 高质量 |
| ≥0.6 | ×1.0 | 标准 |
| ≥0.3 | ×0.5 | 低质量 |
| <0.3 | ×0.0 | 拒绝 |

### 3.5 事件→策略映射覆盖

| 事件类别 | 事件数 | 策略覆盖 |
|---------|--------|---------|
| 治理事件 (Week1 Task2) | 10 | 全部10个 ✅ |
| Agent生态事件 | 7 | 全部7个 ✅ |
| 基础积分事件 | 14 | 全部14个 ✅ |
| V4.0行为联动 | 10 | 全部10个 ✅ |
| **总计** | **41个事件** | **100%覆盖** |

### 3.6 API 端点 (+6)

| 端点 | 方法 | 功能 |
|------|------|------|
| /v1/anti-cheat/evaluate | POST | 积分策略校验(内部) |
| /v1/anti-cheat/confirm | POST | 交叉验证确认(AS-04) |
| /v1/anti-cheat/daily-status | GET | 今日剩余次数 |
| /v1/anti-cheat/review-queue | GET | 异常审查队列(管理员) |
| /v1/anti-cheat/review-resolve | POST | 审查结果处理(管理员) |
| /v1/anti-cheat/strategy-map/{event} | GET | 事件策略映射查询 |

### 3.7 测试覆盖 (29/29 PASS)

| 测试区间 | 覆盖范围 | 数量 |
|---------|---------|------|
| ACE-01~04 | AS-01 每日上限 | 4 |
| ACE-05~08b | AS-02 质量加权 | 5 |
| ACE-09~12 | AS-03 时间衰减 | 4 |
| ACE-13~16 | AS-04 交叉验证 | 4 |
| ACE-17~18 | AS-05 成长轨校验 | 2 |
| ACE-19~21 | AS-06 异常检测 | 3 |
| ACE-22~25 | Pipeline集成 | 4 |
| 映射完整性 | 事件策略映射 | 3 |

---

## 四、契约注册表映射更新

### Sheet④ 晋级契约
- L0→L5 五级双轨阈值: **全部落地** ✅
- 四种状态管理+引导话术: **已实现** ✅
- 四同道者追踪服务: **已实现** ✅
- 仪式契约签署清单: **已配置** ✅

### Sheet⑦ 积分契约
- 六种防刷策略引擎: **全部实现** ✅
- 41个事件→策略映射: **100%覆盖** ✅
- 衰减曲线/质量加权: **精确对齐契约** ✅

### Sheet⑩ 技术实施映射
- 「双轨晋级校验引擎」P0: **已完成** ✅
- 「六种防刷策略引擎」P0: **已完成** ✅
- 「等待验证UI组件」P1: 后端就绪, 前端待集成
- 「四同道者追踪系统」P0: **已完成** (PeerTrackingService)

### Sheet⑪ 教练体系管理
- 六级体系 L0-L5 全量对齐: ✅
- 四同道者裂变金字塔: PeerTrackingService 落地
- S0-S5 阶段对接: 通过 StageService 接口预留

---

## 五、合并指标更新

| 维度 | V2.0 (Week1) | V2.1 (Week2) | 变化 |
|------|-------------|-------------|------|
| API端点 | 626 | 638 | +12 (6 promotion + 6 anti-cheat) |
| 测试 | 424 passed | 479 passed | +55 (26 dual-track + 29 anti-cheat) |
| 晋级引擎 | 未实现 | L0→L5 五级双轨 | 🆕 |
| 防刷策略 | 配置映射 | 6种引擎+Pipeline | 🆕 |
| 积分事件覆盖 | ~63% (19/30) | ~63% + 41事件防刷 | 防刷100% |
| RBAC | 94% | 95% | +1% (同道者追踪) |

---

## 六、Task A/B 交叉集成

```
IncentiveEngine.award_points(user_id, event_type, base_points)
  │
  ├─→ AntiCheatPipeline.process(request)       ← Task B
  │     ├── AS-06: 异常检测 → 标记
  │     ├── AS-01: 每日上限 → 阻断/通过
  │     ├── AS-04: 交叉验证 → 暂扣/通过
  │     ├── AS-03: 时间衰减 → 调整积分
  │     ├── AS-02: 质量加权 → 调整积分
  │     └── AS-05: 触发双轨校验 → PromotionOrchestrator
  │                                              ← Task A
  ├─→ write_points(final_points)
  │
  └─→ PromotionOrchestrator.check_eligibility() ← Task A
        ├── DualTrackChecker.check()
        │     ├── 积分轨: PointsService
        │     ├── 成长轨: PeerTracking + Stage + Exam
        │     └── 状态判定: 1/2/3/4
        ├── GapAnalyzer.analyze()
        └── StateManager.update()
```

---

## 七、Week 3-4 后续任务

| 任务 | 依赖 | 预估 |
|------|------|------|
| S0-S5 阶段前端可视化 | Task A StageService接口 | 1周 |
| 责任追踪+治理仪表盘 | Week1 Task4 审计框架 | 2周 |
| 体验版评估+AI试用 | Week1 Task1 观察员分层 | 4天 |
| 等待验证UI组件 | Task A 四种状态API | 1周 |
| 400分制考核系统 | Task A L2→L3 考核接口 | 2周 |

---

## 八、交付文件清单

### Task A: 双轨晋级校验引擎 (4文件)
1. `dual_track_engine.py` — 核心引擎+L0-L5阈值+状态管理+差距分析+编排器
2. `peer_tracking_service.py` — 四同道者追踪服务
3. `promotion_api.py` — 6个REST端点
4. `test_dual_track.py` — 26个测试用例

### Task B: 六种防刷策略引擎 (3文件)
5. `anti_cheat_engine.py` — 6种策略+Pipeline+事件映射注册表
6. `anti_cheat_api.py` — 6个REST端点+审查队列
7. `test_anti_cheat.py` — 29个测试用例
