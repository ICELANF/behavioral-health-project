{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "agent_task_v1.0",
  "title": "Agent Task Schema",
  "description": "定义 Master Agent 与专业 Agent 之间的任务通信格式",

  "definitions": {
    "AgentType": {
      "type": "string",
      "enum": [
        "SleepAgent",
        "GlucoseAgent",
        "StressAgent",
        "NutritionAgent",
        "ExerciseAgent",
        "MentalHealthAgent",
        "TCMWellnessAgent",
        "CrisisAgent"
      ],
      "description": "专业 Agent 类型"
    },

    "TaskPriority": {
      "type": "string",
      "enum": ["critical", "high", "normal", "low"],
      "description": "任务优先级"
    },

    "TaskStatus": {
      "type": "string",
      "enum": ["pending", "processing", "completed", "failed", "timeout"],
      "description": "任务状态"
    },

    "ProfileSummary": {
      "type": "object",
      "description": "精简版用户画像 (传递给 Agent)",
      "properties": {
        "user_id": {"type": "string"},
        "age": {"type": "integer"},
        "sex": {"type": "string"},
        "diabetes": {"type": "string"},
        "behavior_stage": {"type": "string"},
        "spi_coefficient": {"type": "number"},
        "stress_level": {"type": "string"},
        "motivation": {"type": "string"},
        "efficacy_score": {"type": "number"},
        "focus_areas": {"type": "array", "items": {"type": "string"}},
        "coaching_style": {"type": "string"},
        "active_risk_flags": {"type": "array", "items": {"type": "string"}}
      }
    },

    "RecentData": {
      "type": "object",
      "description": "近期相关数据",
      "properties": {
        "cgm": {
          "type": "object",
          "properties": {
            "current_glucose": {"type": "number"},
            "trend": {"type": "string"},
            "tir_percent": {"type": "number"},
            "avg_7d": {"type": "number"},
            "high_events_24h": {"type": "integer"},
            "low_events_24h": {"type": "integer"}
          }
        },
        "sleep": {
          "type": "object",
          "properties": {
            "last_night_hours": {"type": "number"},
            "quality_score": {"type": "number"},
            "deep_sleep_percent": {"type": "number"},
            "avg_7d_hours": {"type": "number"},
            "trend": {"type": "string"}
          }
        },
        "hrv": {
          "type": "object",
          "properties": {
            "sdnn": {"type": "number"},
            "rmssd": {"type": "number"},
            "stress_index": {"type": "number"},
            "recovery_score": {"type": "number"},
            "trend": {"type": "string"}
          }
        },
        "activity": {
          "type": "object",
          "properties": {
            "steps_today": {"type": "integer"},
            "avg_steps_7d": {"type": "integer"},
            "active_minutes": {"type": "integer"},
            "sedentary_hours": {"type": "number"}
          }
        },
        "mood": {
          "type": "object",
          "properties": {
            "current_score": {"type": "integer", "minimum": 1, "maximum": 5},
            "trend": {"type": "string"},
            "recent_notes": {"type": "array", "items": {"type": "string"}}
          }
        }
      }
    }
  },

  "task_request": {
    "type": "object",
    "title": "Agent Task Request",
    "description": "发送给专业 Agent 的任务请求",
    "required": ["task_id", "agent_type", "question"],
    "properties": {
      "task_id": {
        "type": "string",
        "pattern": "^T[0-9]+$",
        "description": "任务唯一标识符"
      },
      "agent_type": {
        "$ref": "#/definitions/AgentType"
      },
      "question": {
        "type": "string",
        "description": "发送给 Agent 的具体问题/指令"
      },
      "priority": {
        "$ref": "#/definitions/TaskPriority",
        "default": "normal"
      },
      "context": {
        "type": "object",
        "properties": {
          "profile": {"$ref": "#/definitions/ProfileSummary"},
          "recent_data": {"$ref": "#/definitions/RecentData"},
          "user_message": {"type": "string", "description": "用户原始消息"},
          "session_id": {"type": "string"},
          "conversation_history": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "role": {"type": "string", "enum": ["user", "assistant"]},
                "content": {"type": "string"},
                "timestamp": {"type": "string", "format": "date-time"}
              }
            },
            "maxItems": 10,
            "description": "最近10轮对话历史"
          }
        }
      },
      "constraints": {
        "type": "object",
        "description": "任务约束条件",
        "properties": {
          "max_response_length": {"type": "integer", "default": 500},
          "response_style": {"type": "string", "enum": ["concise", "detailed", "educational"]},
          "include_references": {"type": "boolean", "default": false},
          "timeout_ms": {"type": "integer", "default": 30000}
        }
      },
      "metadata": {
        "type": "object",
        "properties": {
          "created_at": {"type": "string", "format": "date-time"},
          "requester": {"type": "string", "default": "MasterAgent"},
          "trace_id": {"type": "string"}
        }
      }
    }
  },

  "task_response": {
    "type": "object",
    "title": "Agent Task Response",
    "description": "专业 Agent 返回的任务响应",
    "required": ["task_id", "agent_type", "status"],
    "properties": {
      "task_id": {
        "type": "string"
      },
      "agent_type": {
        "$ref": "#/definitions/AgentType"
      },
      "status": {
        "$ref": "#/definitions/TaskStatus"
      },
      "analysis": {
        "type": "object",
        "description": "分析结果",
        "properties": {
          "summary": {"type": "string", "description": "核心发现摘要"},
          "findings": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "category": {"type": "string"},
                "observation": {"type": "string"},
                "severity": {"type": "string", "enum": ["info", "warning", "critical"]},
                "confidence": {"type": "number", "minimum": 0, "maximum": 1}
              }
            }
          },
          "correlations": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "factor_a": {"type": "string"},
                "factor_b": {"type": "string"},
                "relationship": {"type": "string"},
                "strength": {"type": "string", "enum": ["weak", "moderate", "strong"]}
              }
            },
            "description": "发现的相关性"
          }
        }
      },
      "recommendations": {
        "type": "array",
        "description": "干预建议列表",
        "items": {
          "type": "object",
          "properties": {
            "type": {"type": "string", "enum": ["behavioral", "nutritional", "medical", "lifestyle", "psychological"]},
            "action": {"type": "string", "description": "具体行动建议"},
            "rationale": {"type": "string", "description": "建议原因"},
            "priority": {"type": "integer", "minimum": 1, "maximum": 5},
            "difficulty": {"type": "integer", "minimum": 1, "maximum": 5},
            "duration_minutes": {"type": "integer"},
            "timing": {"type": "string", "description": "建议执行时间"},
            "resources": {
              "type": "object",
              "properties": {
                "knowledge_link": {"type": "string"},
                "video_link": {"type": "string"},
                "product_id": {"type": "string"}
              }
            }
          }
        }
      },
      "response_text": {
        "type": "string",
        "description": "面向用户的响应文本"
      },
      "coach_notes": {
        "type": "string",
        "description": "给 Master Agent 的内部备注 (不直接展示给用户)"
      },
      "follow_up": {
        "type": "object",
        "properties": {
          "suggested_questions": {"type": "array", "items": {"type": "string"}},
          "monitoring_points": {"type": "array", "items": {"type": "string"}},
          "escalation_needed": {"type": "boolean", "default": false},
          "escalation_reason": {"type": "string"}
        }
      },
      "metadata": {
        "type": "object",
        "properties": {
          "processing_time_ms": {"type": "number"},
          "model_used": {"type": "string"},
          "confidence_score": {"type": "number", "minimum": 0, "maximum": 1},
          "completed_at": {"type": "string", "format": "date-time"}
        }
      }
    }
  },

  "examples": {
    "sleep_glucose_task_request": {
      "task_id": "T789",
      "agent_type": "SleepAgent",
      "question": "分析睡眠问题与血糖关系并给出干预建议",
      "priority": "high",
      "context": {
        "profile": {
          "user_id": "U12345",
          "age": 45,
          "sex": "M",
          "diabetes": "T2D",
          "behavior_stage": "compromise",
          "spi_coefficient": 0.7,
          "stress_level": "high",
          "motivation": "medium",
          "efficacy_score": 45,
          "focus_areas": ["sleep", "glucose"],
          "coaching_style": "gentle",
          "active_risk_flags": ["睡眠不足", "HRV偏低"]
        },
        "recent_data": {
          "cgm": {
            "current_glucose": 145,
            "trend": "stable",
            "tir_percent": 68,
            "avg_7d": 138,
            "high_events_24h": 3
          },
          "sleep": {
            "last_night_hours": 5.5,
            "quality_score": 58,
            "deep_sleep_percent": 12,
            "avg_7d_hours": 5.8,
            "trend": "declining"
          },
          "hrv": {
            "sdnn": 42,
            "rmssd": 28,
            "stress_index": 65,
            "recovery_score": 55,
            "trend": "declining"
          }
        },
        "user_message": "最近晚上总是睡不好，血糖也高"
      },
      "constraints": {
        "max_response_length": 400,
        "response_style": "concise"
      }
    },

    "sleep_glucose_task_response": {
      "task_id": "T789",
      "agent_type": "SleepAgent",
      "status": "completed",
      "analysis": {
        "summary": "睡眠不足与血糖控制不佳存在双向影响关系",
        "findings": [
          {
            "category": "sleep",
            "observation": "近7天平均睡眠5.8小时，低于建议的7小时",
            "severity": "warning",
            "confidence": 0.95
          },
          {
            "category": "sleep_quality",
            "observation": "深度睡眠仅12%，显著低于正常的20-25%",
            "severity": "warning",
            "confidence": 0.9
          },
          {
            "category": "glucose",
            "observation": "TIR 68%低于目标70%，夜间血糖波动较大",
            "severity": "warning",
            "confidence": 0.85
          }
        ],
        "correlations": [
          {
            "factor_a": "睡眠时长",
            "factor_b": "血糖TIR",
            "relationship": "睡眠不足导致胰岛素敏感性下降",
            "strength": "strong"
          },
          {
            "factor_a": "HRV/压力",
            "factor_b": "睡眠质量",
            "relationship": "高压力状态影响睡眠深度",
            "strength": "moderate"
          }
        ]
      },
      "recommendations": [
        {
          "type": "behavioral",
          "action": "睡前30分钟进行4-7-8呼吸练习",
          "rationale": "降低交感神经活性，改善入睡",
          "priority": 1,
          "difficulty": 1,
          "duration_minutes": 5,
          "timing": "22:30",
          "resources": {
            "knowledge_link": "/knowledge/sleep/breathing-478",
            "video_link": "/videos/breathing-relaxation-5min"
          }
        },
        {
          "type": "lifestyle",
          "action": "固定作息，每晚10:30前上床",
          "rationale": "建立稳定的昼夜节律",
          "priority": 2,
          "difficulty": 2,
          "timing": "每晚"
        }
      ],
      "response_text": "从您的数据来看，睡眠不足和血糖波动确实在相互影响。睡眠不足会降低胰岛素敏感性，让血糖更难控制。我们先从改善睡眠入手，今晚试试睡前呼吸练习？",
      "coach_notes": "用户处于妥协与接受阶段，已有改变意愿但需要降低门槛。建议从简单的呼吸练习开始，不宜一次给太多任务。",
      "follow_up": {
        "suggested_questions": ["您平时几点睡觉？", "睡前有使用手机的习惯吗？"],
        "monitoring_points": ["今晚睡眠时长", "明早空腹血糖", "呼吸练习完成情况"],
        "escalation_needed": false
      },
      "metadata": {
        "processing_time_ms": 850,
        "model_used": "qwen2.5:0.5b",
        "confidence_score": 0.88,
        "completed_at": "2026-01-23T10:12:05"
      }
    }
  }
}
