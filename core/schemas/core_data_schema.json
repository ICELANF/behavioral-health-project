{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "core_data_schema_v1.0",
  "title": "行健行为教练 Core Data Schema",
  "description": "系统最高级别数据协议规范 - 所有模块的统一数据契约",
  "version": "1.0",

  "system_constraints": {
    "authority_principle": "UserMasterProfile 是系统唯一权威用户主画像源",
    "communication_protocol": {
      "orchestrator_to_agent": "AgentTask",
      "agent_to_orchestrator": "AgentResult"
    },
    "prohibited_actions": [
      "AGENT私自维护用户主画像",
      "模块私自新增/删除/重命名核心字段",
      "绕过AgentTask/AgentResult直接跨模块通信"
    ],
    "intervention_closure": "InterventionPlan → DailyTask → 执行反馈 → 回写Profile"
  },

  "definitions": {
    "SchemaVersion": {
      "type": "object",
      "properties": {
        "schema_version": {"type": "string", "const": "1.0"},
        "extensions": {"type": "object", "additionalProperties": true}
      },
      "required": ["schema_version"]
    },

    "UserInput": {
      "type": "object",
      "description": "统一输入对象 - 系统所有外部输入的统一入口",
      "required": ["input_id", "user_id", "input_type", "raw_content", "timestamp"],
      "properties": {
        "input_id": {"type": "string"},
        "user_id": {"type": "string"},
        "input_type": {
          "type": "string",
          "enum": ["chat", "wearable_data", "medical_record", "questionnaire", "manual_log"]
        },
        "raw_content": {"type": "object"},
        "timestamp": {"type": "string", "format": "date-time"},
        "source": {
          "type": "string",
          "enum": ["app", "device", "clinician", "system"]
        },
        "intent_hint": {"type": "string", "description": "可为空，用于初步意图识别"},
        "schema_version": {"type": "string", "default": "1.0"},
        "extensions": {"type": "object"}
      }
    },

    "UserMasterProfile": {
      "type": "object",
      "description": "用户主画像 - 全系统唯一权威用户状态对象",
      "required": ["user_id"],
      "properties": {
        "user_id": {"type": "string"},
        "schema_version": {"type": "string", "default": "1.0"},

        "demographics": {
          "type": "object",
          "properties": {
            "age": {"type": "integer"},
            "gender": {"type": "string", "enum": ["male", "female", "other"]},
            "height": {"type": "number", "description": "cm"},
            "weight": {"type": "number", "description": "kg"}
          }
        },

        "medical_profile": {
          "type": "object",
          "properties": {
            "diagnoses": {
              "type": "array",
              "items": {"type": "string"}
            },
            "medications": {
              "type": "array",
              "items": {"type": "string"}
            },
            "lab_summary": {
              "type": "object",
              "properties": {
                "HbA1c": {"type": "number"},
                "BP_systolic": {"type": "integer"},
                "BP_diastolic": {"type": "integer"},
                "UA": {"type": "number"},
                "TC": {"type": "number"},
                "TG": {"type": "number"},
                "LDL": {"type": "number"},
                "HDL": {"type": "number"}
              }
            }
          }
        },

        "device_profile": {
          "type": "object",
          "properties": {
            "cgm_summary": {
              "type": "object",
              "properties": {
                "avg_glucose": {"type": "number"},
                "tir_percent": {"type": "number"},
                "gmi": {"type": "number"},
                "cv_percent": {"type": "number"}
              }
            },
            "hrv_summary": {
              "type": "object",
              "properties": {
                "avg_hrv": {"type": "number"},
                "rmssd": {"type": "number"},
                "stress_index": {"type": "number"}
              }
            },
            "activity_summary": {
              "type": "object",
              "properties": {
                "daily_steps": {"type": "integer"},
                "active_minutes": {"type": "integer"},
                "sleep_hours": {"type": "number"}
              }
            }
          }
        },

        "behavior_profile": {
          "type": "object",
          "properties": {
            "current_stage": {
              "type": "string",
              "enum": ["precontemplation", "contemplation", "preparation", "action", "maintenance"],
              "description": "行为改变阶段(TTM)"
            },
            "motivation_level": {
              "type": "number",
              "minimum": 0,
              "maximum": 10
            },
            "self_efficacy": {
              "type": "number",
              "minimum": 0,
              "maximum": 10
            },
            "resistance_level": {
              "type": "string",
              "enum": ["resistance", "ambivalence", "compromise", "adaptation", "integration"],
              "description": "五层次心理准备度"
            },
            "dominant_behavior_patterns": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        },

        "inner_need_profile": {
          "type": "object",
          "properties": {
            "core_needs": {
              "type": "array",
              "items": {"type": "string"},
              "description": "核心需求标签"
            },
            "emotional_tendencies": {
              "type": "array",
              "items": {"type": "string"},
              "description": "情绪倾向标签"
            }
          }
        },

        "risk_profile": {
          "type": "object",
          "properties": {
            "metabolic_risk_level": {
              "type": "string",
              "enum": ["low", "moderate", "high", "critical"]
            },
            "cardiovascular_risk_level": {
              "type": "string",
              "enum": ["low", "moderate", "high", "critical"]
            },
            "mental_stress_level": {
              "type": "string",
              "enum": ["low", "moderate", "high", "critical"]
            }
          }
        },

        "intervention_state": {
          "type": "object",
          "properties": {
            "active_plan_id": {"type": "string"},
            "adherence_score": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            },
            "last_adjustment_time": {"type": "string", "format": "date-time"}
          }
        },

        "history_refs": {
          "type": "object",
          "properties": {
            "recent_assessments": {
              "type": "array",
              "items": {"type": "string"},
              "maxItems": 10
            },
            "recent_tasks": {
              "type": "array",
              "items": {"type": "string"},
              "maxItems": 20
            }
          }
        },

        "extensions": {"type": "object"}
      }
    },

    "AgentTask": {
      "type": "object",
      "description": "中枢→AGENT标准指令对象 - Orchestrator调用专业AGENT的唯一通信协议",
      "required": ["task_id", "user_id", "target_agent", "task_type"],
      "properties": {
        "task_id": {"type": "string"},
        "user_id": {"type": "string"},
        "target_agent": {
          "type": "string",
          "enum": ["metabolic", "sleep", "emotion", "motivation", "coaching", "nutrition", "exercise", "tcm", "crisis"]
        },
        "task_type": {
          "type": "string",
          "enum": ["analysis", "assessment_request", "planning_support", "interpretation"]
        },
        "focus_domain": {"type": "string"},
        "context_snapshot": {
          "type": "object",
          "description": "从UserMasterProfile截取的必要字段"
        },
        "specific_questions": {
          "type": "array",
          "items": {"type": "string"}
        },
        "priority": {
          "type": "string",
          "enum": ["high", "normal", "low"],
          "default": "normal"
        },
        "schema_version": {"type": "string", "default": "1.0"},
        "extensions": {"type": "object"}
      }
    },

    "AgentResult": {
      "type": "object",
      "description": "AGENT→中枢回传对象 - 所有AGENT分析结果的统一回传格式",
      "required": ["task_id", "agent_id", "domain"],
      "properties": {
        "task_id": {"type": "string"},
        "agent_id": {"type": "string"},
        "domain": {"type": "string"},
        "key_findings": {
          "type": "array",
          "items": {"type": "string"}
        },
        "behavior_pattern_tags": {
          "type": "array",
          "items": {"type": "string"}
        },
        "inner_need_tags": {
          "type": "array",
          "items": {"type": "string"}
        },
        "risk_assessment": {
          "type": "object",
          "properties": {
            "risk_level": {
              "type": "string",
              "enum": ["low", "moderate", "high", "critical"]
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "recommendations": {
          "type": "array",
          "items": {"type": "string"},
          "description": "仅建议，不直接生成任务"
        },
        "data_updates": {
          "type": "object",
          "description": "建议写回Profile的字段"
        },
        "schema_version": {"type": "string", "default": "1.0"},
        "extensions": {"type": "object"}
      }
    },

    "InterventionPlan": {
      "type": "object",
      "description": "干预路径对象 - 从分析到行动的核心桥梁（行为处方）",
      "required": ["plan_id", "user_id", "target_goals", "current_stage"],
      "properties": {
        "plan_id": {"type": "string"},
        "user_id": {"type": "string"},
        "target_goals": {
          "type": "array",
          "items": {"type": "string"}
        },
        "current_stage": {
          "type": "string",
          "enum": ["startup", "adaptation", "stability", "internalization"]
        },
        "strategy_type": {
          "type": "string",
          "enum": ["cognitive", "behavioral", "emotional_support", "combined"],
          "description": "认知/行为/情绪支持/组合型"
        },
        "intervention_modules": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "module_type": {
                "type": "string",
                "enum": ["nutrition", "exercise", "sleep", "emotion", "cognitive"]
              },
              "intensity_level": {
                "type": "string",
                "enum": ["light", "moderate", "intensive"]
              },
              "duration": {"type": "string"},
              "key_methods": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          }
        },
        "adjustment_rules": {
          "type": "array",
          "items": {"type": "string"}
        },
        "expected_outcomes": {
          "type": "array",
          "items": {"type": "string"}
        },
        "schema_version": {"type": "string", "default": "1.0"},
        "extensions": {"type": "object"}
      }
    },

    "DailyTask": {
      "type": "object",
      "description": "每日任务与陪伴执行对象 - 系统真正产生行为改变的执行出口",
      "required": ["task_id", "user_id", "task_type", "description"],
      "properties": {
        "task_id": {"type": "string"},
        "user_id": {"type": "string"},
        "related_plan_id": {"type": "string"},
        "task_type": {
          "type": "string",
          "enum": ["micro_habit", "reflection", "training", "measurement"]
        },
        "description": {"type": "string"},
        "scheduled_time": {"type": "string"},
        "completion_status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "skipped"],
          "default": "pending"
        },
        "user_feedback": {"type": "string"},
        "adherence_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "schema_version": {"type": "string", "default": "1.0"},
        "extensions": {"type": "object"}
      }
    }
  },

  "data_flow": {
    "main_pipeline": [
      {"step": 1, "action": "UserInput进入系统"},
      {"step": 2, "action": "Orchestrator解析输入，更新UserMasterProfile基础字段"},
      {"step": 3, "action": "Router基于Profile+Intent生成1-2个AgentTask"},
      {"step": 4, "action": "各AGENT返回AgentResult"},
      {"step": 5, "action": "Multi-Agent Coordinator融合多个AgentResult"},
      {"step": 6, "action": "Intervention Planner读取Profile+AgentResult生成InterventionPlan"},
      {"step": 7, "action": "Planner生成DailyTask"},
      {"step": 8, "action": "Response Synthesizer输出对话+任务"},
      {"step": 9, "action": "执行反馈写回DailyTask和UserMasterProfile"}
    ],
    "write_back_channels": [
      "AgentResult.data_updates",
      "InterventionPlan.adjustment",
      "DailyTask.feedback"
    ],
    "write_back_authority": "Master Orchestrator统一写回"
  }
}
