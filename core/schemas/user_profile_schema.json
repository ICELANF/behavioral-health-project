{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "user_master_profile_v2.0",
  "title": "User Master Profile (用户主画像)",
  "description": "统一用户主画像，贯穿9步处理流程",

  "type": "object",
  "required": ["user_id", "basic"],

  "properties": {
    "user_id": {
      "type": "string",
      "description": "用户唯一标识"
    },

    "created_at": {
      "type": "string",
      "format": "date-time"
    },

    "updated_at": {
      "type": "string",
      "format": "date-time"
    },

    "basic": {
      "type": "object",
      "description": "基本信息",
      "properties": {
        "age": {"type": "integer", "minimum": 0, "maximum": 120},
        "sex": {"type": "string", "enum": ["M", "F"]},
        "height_cm": {"type": "number"},
        "weight_kg": {"type": "number"},
        "occupation": {"type": "string"},
        "education": {"type": "string"},
        "marital_status": {"type": "string", "enum": ["single", "married", "divorced", "widowed"]}
      },
      "required": ["age", "sex"]
    },

    "medical": {
      "type": "object",
      "description": "医疗健康信息",
      "properties": {
        "diabetes": {
          "type": "string",
          "enum": ["none", "prediabetes", "T1D", "T2D", "GDM"],
          "description": "糖尿病类型: 无/糖尿病前期/1型/2型/妊娠期"
        },
        "bp": {
          "type": "string",
          "pattern": "^\\d{2,3}/\\d{2,3}$",
          "description": "血压 收缩压/舒张压"
        },
        "bp_category": {
          "type": "string",
          "enum": ["normal", "elevated", "stage1_hypertension", "stage2_hypertension", "crisis"]
        },
        "cholesterol": {
          "type": "object",
          "properties": {
            "total": {"type": "number"},
            "ldl": {"type": "number"},
            "hdl": {"type": "number"},
            "triglycerides": {"type": "number"}
          }
        },
        "medications": {
          "type": "array",
          "items": {"type": "string"},
          "description": "当前用药列表"
        },
        "conditions": {
          "type": "array",
          "items": {"type": "string"},
          "description": "其他疾病/状况"
        },
        "allergies": {
          "type": "array",
          "items": {"type": "string"}
        },
        "last_checkup": {
          "type": "string",
          "format": "date"
        }
      }
    },

    "behavior": {
      "type": "object",
      "description": "行为状态 (基于自研五层次模型)",
      "properties": {
        "stage": {
          "type": "string",
          "enum": ["resistance", "ambivalence", "compromise", "adaptation", "integration"],
          "description": "心理准备度层次: 完全对抗/抗拒与反思/妥协与接受/顺应与调整/全面臣服"
        },
        "stage_chinese": {
          "type": "string",
          "enum": ["完全对抗", "抗拒与反思", "妥协与接受", "顺应与调整", "全面臣服"]
        },
        "spi_coefficient": {
          "type": "number",
          "minimum": 0.3,
          "maximum": 1.0,
          "description": "SPI系数: 0.3/0.5/0.7/0.9/1.0"
        },
        "patterns": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "night_eating",
              "emotional_eating",
              "low_activity",
              "sedentary",
              "poor_sleep",
              "irregular_meals",
              "stress_eating",
              "binge_eating",
              "skipping_meals",
              "late_night_screen",
              "caffeine_dependence",
              "alcohol_use",
              "smoking"
            ]
          },
          "description": "识别到的行为模式"
        },
        "adherence_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "依从性评分 0-1"
        },
        "task_completion_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "streak_days": {
          "type": "integer",
          "description": "连续完成任务天数"
        },
        "cultivation_phase": {
          "type": "string",
          "enum": ["startup", "adaptation", "stability", "internalization"],
          "description": "四阶段养成: 启动期/适应期/稳定期/内化期"
        }
      }
    },

    "psych": {
      "type": "object",
      "description": "心理状态",
      "properties": {
        "stress_level": {
          "type": "string",
          "enum": ["low", "medium", "high", "severe"]
        },
        "stress_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "motivation": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        },
        "motivation_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "anxiety_level": {
          "type": "string",
          "enum": ["normal", "mild", "moderate", "severe"]
        },
        "depression_level": {
          "type": "string",
          "enum": ["normal", "mild", "moderate", "severe"]
        },
        "efficacy_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "自我效能感"
        },
        "mood_trend": {
          "type": "string",
          "enum": ["improving", "stable", "declining"]
        },
        "resilience": {
          "type": "string",
          "enum": ["low", "medium", "high"],
          "description": "心理韧性"
        },
        "social_support": {
          "type": "string",
          "enum": ["poor", "moderate", "good", "excellent"]
        }
      }
    },

    "constitution": {
      "type": "object",
      "description": "体质指标",
      "properties": {
        "bmi": {
          "type": "number",
          "description": "体质指数"
        },
        "bmi_category": {
          "type": "string",
          "enum": ["underweight", "normal", "overweight", "obese_1", "obese_2", "obese_3"]
        },
        "visceral_fat": {
          "type": "string",
          "enum": ["normal", "borderline", "high", "very_high"]
        },
        "body_fat_percent": {
          "type": "number"
        },
        "muscle_mass": {
          "type": "string",
          "enum": ["low", "normal", "high"]
        },
        "inflammation_risk": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        },
        "metabolic_age": {
          "type": "integer"
        },
        "tcm_constitution": {
          "type": "string",
          "enum": [
            "balanced",
            "qi_deficiency",
            "yang_deficiency",
            "yin_deficiency",
            "phlegm_dampness",
            "damp_heat",
            "blood_stasis",
            "qi_stagnation",
            "special"
          ],
          "description": "中医体质"
        }
      }
    },

    "biometrics": {
      "type": "object",
      "description": "生物指标 (来自设备/检测)",
      "properties": {
        "glucose": {
          "type": "object",
          "properties": {
            "fasting": {"type": "number", "description": "空腹血糖 mg/dL"},
            "postprandial": {"type": "number", "description": "餐后血糖 mg/dL"},
            "hba1c": {"type": "number", "description": "糖化血红蛋白 %"},
            "tir": {"type": "number", "description": "时间在范围内 %"},
            "avg_7d": {"type": "number"},
            "trend": {"type": "string", "enum": ["improving", "stable", "worsening"]}
          }
        },
        "hrv": {
          "type": "object",
          "properties": {
            "sdnn": {"type": "number"},
            "rmssd": {"type": "number"},
            "trend": {"type": "string", "enum": ["improving", "stable", "declining"]}
          }
        },
        "sleep": {
          "type": "object",
          "properties": {
            "avg_duration": {"type": "number"},
            "avg_quality": {"type": "number"},
            "deep_sleep_percent": {"type": "number"},
            "sleep_debt_hours": {"type": "number"},
            "trend": {"type": "string", "enum": ["improving", "stable", "declining"]}
          }
        },
        "activity": {
          "type": "object",
          "properties": {
            "avg_steps": {"type": "integer"},
            "active_minutes_weekly": {"type": "integer"},
            "sedentary_hours_daily": {"type": "number"},
            "exercise_frequency": {"type": "string", "enum": ["none", "occasional", "regular", "active"]}
          }
        }
      }
    },

    "preferences": {
      "type": "object",
      "description": "用户偏好设置",
      "properties": {
        "focus": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["sleep", "glucose", "weight", "stress", "exercise", "nutrition", "mood", "energy"]
          },
          "description": "关注的健康领域"
        },
        "coaching_style": {
          "type": "string",
          "enum": ["gentle", "direct", "motivational", "educational"],
          "description": "偏好的教练风格"
        },
        "notification_time": {
          "type": "string",
          "pattern": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$"
        },
        "language": {
          "type": "string",
          "default": "zh-CN"
        },
        "preferred_experts": {
          "type": "array",
          "items": {"type": "string"}
        },
        "avoided_topics": {
          "type": "array",
          "items": {"type": "string"}
        },
        "max_tasks_per_day": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "default": 2
        }
      }
    },

    "goals": {
      "type": "object",
      "description": "健康目标",
      "properties": {
        "primary": {
          "type": "string",
          "description": "主要目标"
        },
        "secondary": {
          "type": "array",
          "items": {"type": "string"}
        },
        "target_weight": {"type": "number"},
        "target_hba1c": {"type": "number"},
        "target_bp": {"type": "string"},
        "target_sleep_hours": {"type": "number"},
        "target_steps": {"type": "integer"},
        "deadline": {"type": "string", "format": "date"}
      }
    },

    "risk_flags": {
      "type": "array",
      "description": "风险标记",
      "items": {
        "type": "object",
        "properties": {
          "flag": {"type": "string"},
          "severity": {"type": "string", "enum": ["low", "medium", "high", "critical"]},
          "detected_at": {"type": "string", "format": "date-time"},
          "resolved": {"type": "boolean", "default": false}
        }
      }
    },

    "history": {
      "type": "object",
      "description": "历史记录摘要",
      "properties": {
        "total_sessions": {"type": "integer"},
        "first_session": {"type": "string", "format": "date"},
        "last_session": {"type": "string", "format": "date-time"},
        "total_tasks_assigned": {"type": "integer"},
        "total_tasks_completed": {"type": "integer"},
        "assessments_count": {"type": "integer"},
        "interventions_count": {"type": "integer"},
        "improvement_trend": {
          "type": "string",
          "enum": ["significant_improvement", "moderate_improvement", "stable", "decline"]
        }
      }
    },

    "current_intervention": {
      "type": "object",
      "description": "当前干预计划",
      "properties": {
        "plan_id": {"type": "string"},
        "strategy": {"type": "string"},
        "started_at": {"type": "string", "format": "date"},
        "expected_end": {"type": "string", "format": "date"},
        "phase": {"type": "integer", "minimum": 1, "maximum": 4},
        "progress_percent": {"type": "number"}
      }
    },

    "today": {
      "type": "object",
      "description": "今日状态快照",
      "properties": {
        "tasks": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "task_id": {"type": "string"},
              "title": {"type": "string"},
              "status": {"type": "string", "enum": ["pending", "in_progress", "completed", "skipped"]}
            }
          }
        },
        "mood_log": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "time": {"type": "string"},
              "score": {"type": "integer", "minimum": 1, "maximum": 5},
              "note": {"type": "string"}
            }
          }
        },
        "device_sync_time": {"type": "string", "format": "date-time"},
        "check_ins": {"type": "integer"}
      }
    }
  },

  "examples": [
    {
      "user_id": "U12345",
      "created_at": "2026-01-01T00:00:00",
      "updated_at": "2026-01-23T10:12:00",
      "basic": {
        "age": 45,
        "sex": "M"
      },
      "medical": {
        "diabetes": "T2D",
        "bp": "130/85",
        "bp_category": "stage1_hypertension",
        "medications": ["二甲双胍", "降压药"]
      },
      "behavior": {
        "stage": "compromise",
        "stage_chinese": "妥协与接受",
        "spi_coefficient": 0.7,
        "patterns": ["night_eating", "low_activity"],
        "adherence_score": 0.62,
        "cultivation_phase": "adaptation"
      },
      "psych": {
        "stress_level": "high",
        "stress_score": 72,
        "motivation": "medium",
        "motivation_score": 55,
        "efficacy_score": 45
      },
      "constitution": {
        "bmi": 28.3,
        "bmi_category": "overweight",
        "visceral_fat": "high",
        "inflammation_risk": "medium"
      },
      "biometrics": {
        "glucose": {
          "fasting": 126,
          "hba1c": 7.2,
          "tir": 68,
          "trend": "stable"
        },
        "hrv": {
          "sdnn": 42,
          "trend": "declining"
        },
        "sleep": {
          "avg_duration": 5.5,
          "avg_quality": 58,
          "trend": "declining"
        }
      },
      "preferences": {
        "focus": ["sleep", "glucose"],
        "coaching_style": "gentle",
        "max_tasks_per_day": 2
      },
      "goals": {
        "primary": "改善睡眠和血糖控制",
        "target_hba1c": 6.5,
        "target_sleep_hours": 7
      },
      "risk_flags": [
        {
          "flag": "睡眠不足",
          "severity": "medium",
          "detected_at": "2026-01-22T08:00:00",
          "resolved": false
        }
      ]
    }
  ]
}
