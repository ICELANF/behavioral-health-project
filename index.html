<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸»åŠ¨å¥åº·æŒ‡æŒ¥èˆ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --main-green: #00b894; }
        body { background: #f0f2f5; }
        .dashboard-card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .coach-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--main-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,184,148,0.4); z-index: 1000; }
        #coach-chat { position: fixed; bottom: 100px; right: 30px; width: 300px; height: 400px; background: white; border-radius: 10px; display: none; flex-direction: column; box-shadow: 0 5px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container py-4">
    <header class="mb-4 text-center">
        <h1 class="display-6 fw-bold text-dark">ä¸»åŠ¨å¥åº· Â· æ•°å­—åŒ–èº«</h1>
        <span class="badge bg-success">å®æ—¶æ•°æ®é“¾è·¯å·²æ¥é€š</span>
    </header>

    <div class="row">
        <div class="col-lg-5">
            <div class="card dashboard-card p-4">
                <h5 class="mb-3">æ•°æ®è¾“å…¥</h5>
                <div class="mb-3">
                    <input type="number" id="glucoseValue" class="form-control form-control-lg" placeholder="è¾“å…¥å½“å‰è¡€ç³–å€¼">
                </div>
                <div class="mb-3">
                    <div id="tag-container">
                        <span class="badge bg-secondary p-2 mb-2" onclick="toggleTag(this, 'compliance_low')">ä¾ä»æ€§ä½</span>
                        <span class="badge bg-secondary p-2 mb-2" onclick="toggleTag(this, 'diet_excess')">é¥®é£Ÿè¶…æ ‡</span>
                    </div>
                </div>
                <button class="btn btn-primary w-100" onclick="sendIntervention()">åˆ†æå¹¶ç”Ÿæˆå»ºè®®</button>
                
                <div id="ai-response" class="mt-4" style="display:none;">
                    <hr>
                    <p class="fw-bold text-success" id="strategy-label"></p>
                    <div id="content-text" class="small text-muted border-start ps-3"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card dashboard-card p-4">
                <h5 class="mb-3">è¡€ç³–æ³¢åŠ¨è¶‹åŠ¿ (è¿‘12å°æ—¶)</h5>
                <canvas id="glucoseChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="coach-fab" onclick="toggleChat()">ğŸ“</div>
<div id="coach-chat">
    <div class="p-3 bg-success text-white rounded-top d-flex justify-content-between">
        <span>å¥åº·æ•™ç»ƒ - æåŒ»ç”Ÿ</span>
        <button class="btn-close btn-close-white" onclick="toggleChat()"></button>
    </div>
    <div class="flex-grow-1 p-3 overflow-auto small" id="chat-messages">
        <div class="bg-light p-2 rounded mb-2">æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„ä¸“å±æ•™ç»ƒã€‚ç³»ç»Ÿæç¤ºæ‚¨åˆšæ‰è¡€ç³–æ³¢åŠ¨è¾ƒå¤§ï¼Œè¯·é—®æ‚¨ç°åœ¨æ„Ÿè§‰å¦‚ä½•ï¼Ÿ</div>
    </div>
    <div class="p-2 border-top d-flex">
        <input type="text" id="chat-input" class="form-control form-control-sm me-2" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-sm btn-success" onclick="sendChat()">å‘é€</button>
    </div>
</div>

<script>
    let myChart = null;
    let selectedTags = [];

    function toggleTag(el, tag) {
        if (selectedTags.includes(tag)) {
            selectedTags = selectedTags.filter(t => t !== tag);
            el.classList.replace('bg-primary', 'bg-secondary');
        } else {
            selectedTags.push(tag);
            el.classList.replace('bg-secondary', 'bg-primary');
        }
    }

    function toggleChat() {
        const chat = document.getElementById('coach-chat');
        chat.style.display = chat.style.display === 'flex' ? 'none' : 'flex';
    }

    function updateChart(labels, data) {
        const ctx = document.getElementById('glucoseChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'è¡€ç³–æµ“åº¦ (mmol/L)',
                    data: data,
                    borderColor: '#00b894',
                    backgroundColor: 'rgba(0, 184, 148, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: { y: { min: 3, max: 15 } }
            }
        });
    }

    async function sendIntervention() {
        const glucose = document.getElementById('glucoseValue').value;
        if (!glucose) return;

        try {
            const response = await fetch('http://127.0.0.1:8002/intervene', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: 1001,
                    user_name: "è€å¼ ",
                    current_glucose: parseFloat(glucose),
                    behavioral_tags: selectedTags
                })
            });
            const res = await response.json();
            
            // æ›´æ–° UI
            document.getElementById('ai-response').style.display = 'block';
            document.getElementById('strategy-label').innerText = res.strategy_name;
            document.getElementById('content-text').innerText = res.content;
            
            // æ›´æ–°å›¾è¡¨
            updateChart(res.timestamps, res.history);

            // å¦‚æœè¡€ç³–è¿‡é«˜ï¼Œè‡ªåŠ¨å¼¹çª—è”ç³»æ•™ç»ƒ
            if (parseFloat(glucose) > 10) {
                setTimeout(() => {
                    document.getElementById('coach-chat').style.display = 'flex';
                }, 1000);
            }
        } catch (e) { alert("åç«¯è¿æ¥å¤±è´¥"); }
    }

    // ---------- æ•™ç»ƒèŠå¤©ï¼ˆSSE æµå¼ï¼‰ ----------
    async function sendChat() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;
        input.value = '';

        const container = document.getElementById('chat-messages');
        // ç”¨æˆ·æ°”æ³¡
        container.innerHTML += `<div class="text-end mb-2"><span class="bg-success text-white p-2 rounded d-inline-block">${msg}</span></div>`;
        // AI æ°”æ³¡ï¼ˆé€å­—å¡«å……ï¼‰
        const aiId = 'ai-' + Date.now();
        container.innerHTML += `<div class="bg-light p-2 rounded mb-2" id="${aiId}"><span class="text-muted">æ€è€ƒä¸­...</span></div>`;
        container.scrollTop = container.scrollHeight;

        try {
            const resp = await fetch('http://127.0.0.1:8002/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg, user_id: '1001' })
            });
            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            let buf = '';
            let fullText = '';
            const aiBubble = document.getElementById(aiId);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buf += decoder.decode(value, { stream: true });
                const lines = buf.split('\n');
                buf = lines.pop();
                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    try {
                        const ev = JSON.parse(line.slice(6));
                        if (ev.chunk) { fullText += ev.chunk; aiBubble.innerText = fullText; }
                        if (ev.error) { aiBubble.innerText = 'å‡ºé”™: ' + ev.error; }
                    } catch {}
                }
                container.scrollTop = container.scrollHeight;
            }
            if (!fullText) aiBubble.innerText = 'æ•™ç»ƒæš‚æ—¶æ— æ³•å“åº”';
        } catch (e) {
            document.getElementById(aiId).innerText = 'è¿æ¥å¤±è´¥: ' + e.message;
        }
    }

    // åˆå§‹åŒ–ç©ºç™½å›¾è¡¨
    updateChart(["0:00","4:00","8:00"], [5.5, 6.0, 5.8]);
</script>
</body>
</html>