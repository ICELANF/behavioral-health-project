{
  "version": "1.0.0",
  "name": "behavior_diagnosis_prompts",
  "description": "AI辅助行为诊断Prompt配置，用于生成四层诊断报告",
  "compatible_with": {
    "dify_workflow": "Proactive Health Coach",
    "ollama_model": "qwen2.5:7b",
    "state_sync_manager": "1.0.0",
    "behavior_rules": "1.0.0"
  },

  "prompts": {
    "layer1_behavior_diagnosis": {
      "id": "PROMPT_L1_DIAGNOSIS",
      "name": "第一层行为诊断生成",
      "description": "基于隐性数据生成问题-困难-目的诊断和六类原因初评",
      "model_config": {
        "primary": {"provider": "dify", "workflow": "behavior_diagnosis"},
        "fallback": {"provider": "ollama", "model": "qwen2.5:7b"}
      },
      "parameters": {
        "temperature": 0.3,
        "max_tokens": 2500,
        "top_p": 0.9
      },
      
      "system_prompt": "你是一位经验丰富的行为健康诊断专家，擅长从用户的对话和行为数据中识别健康问题、改变困难和深层目的。\n\n【诊断框架】\n你需要完成三位一体的问题识别：\n1. 表层问题：用户当前面临的具体健康问题或症状\n2. 中层困难：阻碍改变的内在阻力、外在限制、心理矛盾、习惯问题\n3. 深层目的：用户改变的根本动力来源（价值观、身份认同、生命意义）\n\n【六类原因框架】\n评估驱动改变的六类原因（每类1-5分）：\n- 内在驱动力：价值观觉醒、身份愿望、生命目的\n- 外在事件：健康事件、生活变故、社会压力\n- 情绪体验：恐惧、愤怒、内疚、希望\n- 认知知识：新洞察、新知识、风险认知\n- 能力资源：时间、经济、技能、环境\n- 社会支持：榜样、同伴、家人、专业人士\n\n【分析原则】\n1. 基于证据分析，标注每个结论的数据来源\n2. 区分表层症状和深层原因\n3. 寻找行为改变的积极动力\n4. 对不确定的判断标注置信度\n5. 语言专业但不生硬，保持共情",

      "user_prompt_template": "请基于以下用户数据，生成第一层行为诊断报告。\n\n## 用户基本信息\n- 用户ID: {{user_id}}\n- 性别: {{gender}}\n- 年龄: {{age}}\n- 主诉: {{chief_complaint}}\n- 入组天数: {{days_since_enrollment}}\n- 当前行为阶段: {{current_stage}}\n\n## 对话数据摘要（最近14天）\n{{conversation_summary}}\n\n## 关键语句提取\n{{key_statements}}\n\n## 情绪分析结果\n- 主导情绪: {{dominant_emotion}}\n- 情绪强度: {{emotion_intensity}}\n- 情绪波动: {{emotion_variance}}\n- 关键情绪事件:\n{{emotional_events}}\n\n## 任务执行数据\n- 总体完成率: {{task_completion_rate}}\n- 连续打卡天数: {{streak_days}}\n- 跳过任务次数: {{skip_count}}\n- 跳过原因汇总: {{skip_reasons}}\n- 完成率趋势: {{completion_trend}}\n\n## 触发事件记录（最近30天）\n{{trigger_events}}\n\n## 目标陈述提取\n{{goal_statements}}\n\n## 支持网络信息\n{{support_network}}\n\n---\n\n请严格按照以下JSON格式输出诊断结果：\n\n```json\n{\n  \"diagnosis_id\": \"DIAG_{{user_id}}_{{timestamp}}\",\n  \"version\": 1,\n  \"generated_at\": \"{{current_datetime}}\",\n  \n  \"problem_difficulty_purpose\": {\n    \"surface_problem\": {\n      \"description\": \"用一句话描述表层问题\",\n      \"specific_indicators\": [\"具体指标1\", \"具体指标2\"],\n      \"data_sources\": [\"数据来源1\", \"数据来源2\"],\n      \"confidence\": 0.85\n    },\n    \"behavior_difficulty\": {\n      \"primary_difficulty\": \"主要困难描述\",\n      \"difficulty_types\": {\n        \"internal_resistance\": {\"present\": true, \"description\": \"...\", \"severity\": 3},\n        \"external_limitation\": {\"present\": false, \"description\": null, \"severity\": 0},\n        \"psychological_conflict\": {\"present\": true, \"description\": \"...\", \"severity\": 2},\n        \"habit_pattern\": {\"present\": true, \"description\": \"...\", \"severity\": 3}\n      },\n      \"root_causes\": [\"根因1\", \"根因2\"],\n      \"confidence\": 0.75\n    },\n    \"deep_purpose\": {\n      \"description\": \"深层目的描述\",\n      \"value_connection\": \"与哪些价值观相连\",\n      \"identity_aspiration\": \"身份愿望\",\n      \"motivation_type\": \"intrinsic|extrinsic|mixed\",\n      \"confidence\": 0.65\n    }\n  },\n  \n  \"six_reasons_assessment\": {\n    \"D1_internal_drive\": {\n      \"total_score\": 16,\n      \"max_score\": 20,\n      \"question_scores\": {\n        \"Q01\": {\"score\": 4, \"evidence\": \"...\", \"source\": \"PROFILE\"},\n        \"Q02\": {\"score\": 3, \"evidence\": \"...\", \"source\": \"CONV\"},\n        \"Q03\": {\"score\": 4, \"evidence\": \"...\", \"source\": \"CONV\"},\n        \"Q04\": {\"score\": 5, \"evidence\": \"...\", \"source\": \"TASK\"}\n      },\n      \"dimension_confidence\": 0.70,\n      \"needs_verification\": false\n    },\n    \"D2_external_events\": {\n      \"total_score\": 12,\n      \"max_score\": 20,\n      \"question_scores\": {},\n      \"dimension_confidence\": 0.85,\n      \"needs_verification\": false\n    },\n    \"D3_emotional_experience\": {\n      \"total_score\": 14,\n      \"max_score\": 20,\n      \"question_scores\": {},\n      \"dimension_confidence\": 0.75,\n      \"needs_verification\": false\n    },\n    \"D4_cognitive_knowledge\": {\n      \"total_score\": 9,\n      \"max_score\": 20,\n      \"question_scores\": {},\n      \"dimension_confidence\": 0.60,\n      \"needs_verification\": true,\n      \"weakness_flag\": true\n    },\n    \"D5_capability_resources\": {\n      \"total_score\": 8,\n      \"max_score\": 20,\n      \"question_scores\": {},\n      \"dimension_confidence\": 0.70,\n      \"needs_verification\": false,\n      \"weakness_flag\": true\n    },\n    \"D6_social_support\": {\n      \"total_score\": 18,\n      \"max_score\": 25,\n      \"question_scores\": {},\n      \"dimension_confidence\": 0.65,\n      \"needs_verification\": true\n    },\n    \"part1_total\": 77,\n    \"part1_max\": 125\n  },\n  \n  \"psychological_level_preliminary\": {\n    \"determined_level\": \"L3\",\n    \"level_name\": \"妥协与接受\",\n    \"level_name_en\": \"Selective Acceptance\",\n    \"core_psychology\": \"改变可能是必要的，但我想可控地去做\",\n    \"behavioral_stage_mapping\": \"S1-S2\",\n    \"evidence\": [\n      {\"type\": \"language\", \"content\": \"用户多次说'试试看'\", \"weight\": 0.3},\n      {\"type\": \"behavior\", \"content\": \"任务完成率50%，有尝试但不稳定\", \"weight\": 0.4},\n      {\"type\": \"emotion\", \"content\": \"担心但愿意\", \"weight\": 0.3}\n    ],\n    \"counter_evidence\": [],\n    \"confidence\": 0.70\n  },\n  \n  \"overall_assessment\": {\n    \"overall_confidence\": 0.72,\n    \"data_sufficiency\": \"adequate\",\n    \"requires_explicit_verification\": [\"D4_cognitive_knowledge\", \"D6_social_support\", \"deep_purpose\"],\n    \"recommended_verification_questions\": [\"Q13\", \"Q14\", \"Q23\"],\n    \"key_insights\": [\n      \"用户有较强的内在动力，但认知知识和能力资源是短板\",\n      \"家人支持可能是重要的正向因素，需要进一步确认\"\n    ]\n  }\n}\n```"
    },

    "psychological_level_determination": {
      "id": "PROMPT_PSYCH_LEVEL",
      "name": "心理层次精确判定",
      "description": "基于行为和对话数据判定心理准备层次",
      "model_config": {
        "primary": {"provider": "ollama", "model": "qwen2.5:7b"},
        "fallback": null
      },
      "parameters": {
        "temperature": 0.2,
        "max_tokens": 1200
      },
      
      "system_prompt": "你是一位行为改变心理评估专家，专门评估用户面对改变时的心理准备状态。\n\n【五个心理层次】\n\nL1 完全对抗 (Total Resistance)\n- 核心心理：\"改变是威胁\"\n- 典型表现：愤怒、否认、争辩、反向行为\n- 语言特征：\"不行\"、\"不可能\"、\"别管我\"、\"没用的\"\n- 行为特征：完成率<10%，主动退出，对抗性回复\n\nL2 抗拒与反思 (Resistance with Reflection)\n- 核心心理：\"我不想改变，但开始看见必要性\"\n- 典型表现：矛盾、挣扎、质疑、寻找例外\n- 语言特征：\"也许\"、\"但是\"、\"一方面...另一方面\"\n- 行为特征：完成率10-30%，断断续续，情绪波动大\n\nL3 妥协与接受 (Selective Acceptance)\n- 核心心理：\"改变可能是必要的，但我想可控地去做\"\n- 典型表现：愿意尝试、担心失败、小步前进\n- 语言特征：\"试试看\"、\"先做一点\"、\"慢慢来\"\n- 行为特征：完成率30-60%，有尝试但不稳定\n\nL4 顺应与调整 (Adaptive Alignment)\n- 核心心理：\"改变对我来说是合理的，我愿意适应它\"\n- 典型表现：主动寻求方法、自发调整、处理障碍\n- 语言特征：\"我发现\"、\"调整一下\"、\"找到方法了\"\n- 行为特征：完成率60-85%，连续打卡>7天，能处理波动\n\nL5 全面内化 (Full Internalization)\n- 核心心理：\"这就是我\"\n- 典型表现：自然而然、帮助他人、身份认同\n- 语言特征：\"习惯了\"、\"就是这样\"、\"我本来就是这样的人\"\n- 行为特征：完成率>85%，连续打卡>30天，自然恢复\n\n【判定原则】\n1. 以最近7天的表现为主要依据\n2. 同时考虑语言模式(40%)、行为模式(40%)、情绪反应(20%)\n3. 宁可保守判定，不要高估用户的准备度\n4. 注意区分\"说的\"和\"做的\"，行为证据权重更高\n5. 考虑时间趋势，近期表现权重更高",

      "user_prompt_template": "请判定以下用户的心理层次。\n\n## 用户基本信息\n- 用户ID: {{user_id}}\n- 入组天数: {{days_since_enrollment}}\n- 当前行为阶段: {{current_stage}}\n\n## 最近7天对话摘要\n{{recent_conversations}}\n\n## 关键语句提取（按时间排序）\n{{key_statements}}\n\n## 任务执行表现（最近7天）\n- 完成率: {{completion_rate_7d}}\n- 连续天数: {{streak_days}}\n- 跳过次数: {{skip_count_7d}}\n- 跳过原因: {{skip_reasons}}\n- 完成时间模式: {{completion_time_pattern}}\n\n## 情绪模式\n- 主导情绪: {{dominant_emotion}}\n- 情绪趋势: {{emotion_trend}}\n- 负面情绪触发: {{negative_triggers}}\n\n## 与AI/教练的互动模式\n- 主动提问次数: {{proactive_questions}}\n- 求助次数: {{help_requests}}\n- 反馈质量: {{feedback_quality}}\n\n---\n\n请输出判定结果（严格JSON格式）：\n\n```json\n{\n  \"determined_level\": \"L3\",\n  \"level_name\": \"妥协与接受\",\n  \"level_name_display\": \"准备期\",\n  \"behavioral_stage_mapping\": \"S1-S2\",\n  \"coefficient\": 0.6,\n  \"confidence\": 0.75,\n  \n  \"evidence_analysis\": {\n    \"language_evidence\": {\n      \"score\": 3.5,\n      \"max_score\": 5,\n      \"key_phrases\": [\"试试看\", \"先做一点\", \"担心坚持不住\"],\n      \"interpretation\": \"语言模式符合L3典型特征\"\n    },\n    \"behavior_evidence\": {\n      \"score\": 3.0,\n      \"max_score\": 5,\n      \"key_indicators\": [\"完成率52%\", \"连续3天\", \"有中断但恢复\"],\n      \"interpretation\": \"行为模式显示尝试但不稳定\"\n    },\n    \"emotion_evidence\": {\n      \"score\": 3.2,\n      \"max_score\": 5,\n      \"key_indicators\": [\"担心但愿意\", \"偶尔焦虑\"],\n      \"interpretation\": \"情绪模式显示谨慎乐观\"\n    },\n    \"weighted_score\": 3.24\n  },\n  \n  \"counter_evidence\": [\n    {\"content\": \"偶尔有'做不到'的表达\", \"suggests_level\": \"L2\", \"impact\": -0.1}\n  ],\n  \n  \"transition_signals\": {\n    \"toward_L4\": {\n      \"signals\": [\"主动提问增加\", \"开始寻找替代方案\"],\n      \"probability\": 0.3\n    },\n    \"toward_L2\": {\n      \"signals\": [\"压力大时有退缩\"],\n      \"probability\": 0.15\n    }\n  },\n  \n  \"intervention_guidance\": {\n    \"core_strategy\": \"微习惯培养 + 即时正向反馈\",\n    \"key_focus\": \"降低门槛，提供成功体验\",\n    \"avoid\": \"不要设定过高目标，不要强调失败后果\",\n    \"recommended_action_packages\": [\"PKG_MOTIVATION_BOOST\", \"PKG_TASK_ADJUSTMENT\"]\n  }\n}\n```"
    },

    "spi_interpretation": {
      "id": "PROMPT_SPI_INTERPRET",
      "name": "SPI指数解读",
      "description": "解读SPI指数并生成干预建议",
      "model_config": {
        "primary": {"provider": "local", "type": "rule_based"},
        "fallback": {"provider": "ollama", "model": "qwen2.5:7b"}
      },
      
      "calculation_logic": {
        "formula": "SPI = (part1_total / 125) × level_coefficient × (part3_total / 30) × 100",
        "example": "SPI = (77/125) × 0.6 × (22/30) × 100 = 0.616 × 0.6 × 0.733 × 100 ≈ 27"
      },
      
      "interpretation_rules": {
        ">=70": {
          "level": "high",
          "display": "高",
          "success_rate": "70-90%",
          "stage_mapping": "S2-S3",
          "intervention_intensity": "active",
          "recommendation": "可以立即启动系统化干预计划",
          "action_packages": ["PKG_TASK_ADJUSTMENT", "PKG_CELEBRATION"]
        },
        "50-69": {
          "level": "medium_high",
          "display": "中等偏上",
          "success_rate": "50-70%",
          "stage_mapping": "S1-S2",
          "intervention_intensity": "moderate",
          "recommendation": "先强化薄弱环节，再启动行动计划",
          "action_packages": ["PKG_MOTIVATION_BOOST", "PKG_TASK_ADJUSTMENT"]
        },
        "30-49": {
          "level": "medium_low",
          "display": "中等偏下",
          "success_rate": "30-50%",
          "stage_mapping": "S0-S1",
          "intervention_intensity": "supportive",
          "recommendation": "先处理阻抗，建立改变动机",
          "action_packages": ["PKG_STRESS_RELIEF", "PKG_MOTIVATION_BOOST"]
        },
        "<30": {
          "level": "low",
          "display": "低",
          "success_rate": "<30%",
          "stage_mapping": "S0",
          "intervention_intensity": "minimal",
          "recommendation": "等待更好时机，仅提供陪伴支持",
          "action_packages": ["PKG_STRESS_RELIEF"]
        }
      }
    },

    "prescription_generation": {
      "id": "PROMPT_PRESCRIPTION",
      "name": "行为处方生成",
      "description": "基于诊断结果生成个性化行为处方",
      "model_config": {
        "primary": {"provider": "dify", "workflow": "prescription_generator"},
        "fallback": {"provider": "ollama", "model": "qwen2.5:7b"}
      },
      "parameters": {
        "temperature": 0.4,
        "max_tokens": 3000
      },
      
      "system_prompt": "你是一位行为健康处方专家，根据诊断结果为用户制定个性化的行为改变方案。\n\n【处方制定原则】\n\n1. 目标难度与SPI匹配：\n   - SPI<40: 难度★ (最小可行)\n   - SPI 40-60: 难度★★ (基础级)\n   - SPI 60-80: 难度★★★ (标准级)\n   - SPI>80: 难度★★★★ (挑战级)\n\n2. 策略与心理层次匹配：\n   - L1-L2: 不推行动计划，以陪伴和认知教育为主\n   - L3: 微习惯策略，降低门槛，即时反馈，成功体验\n   - L4: 环境设计，习惯堆叠，执行意图，难度递增\n   - L5: 身份强化，意义深化，帮助他人，自主维持\n\n3. 针对六类原因短板设计补充策略：\n   - 内在驱动力弱: 价值观澄清、身份探索\n   - 外在事件不足: 创造启动事件、设定截止日期\n   - 情绪体验缺乏: 情绪觉察、可视化未来\n   - 认知知识不足: 知识教育模块、原理讲解\n   - 能力资源不足: 技能培训、资源链接\n   - 社会支持弱: 同伴匹配、家人动员\n\n4. 预设障碍应对方案：\n   - 基于历史跳过原因设计if-then预案\n   - 提供替代方案和迷你版本",

      "user_prompt_template": "请基于以下诊断结果生成行为处方。\n\n## 诊断摘要\n- 用户ID: {{user_id}}\n- SPI: {{spi_score}}分 ({{spi_level}})\n- 心理层次: {{psychological_level}} ({{level_name}})\n- 行为阶段: {{behavioral_stage}}\n\n## 六类原因评分\n{{six_reasons_scores}}\n\n## 短板维度\n{{weakness_dimensions}}\n\n## 优势维度\n{{strength_dimensions}}\n\n## 能力诊断结果（如有）\n- 认知结构: {{cognitive_structure}}\n- 知识结构: {{knowledge_structure}}\n- 能力结构: {{capability_structure}}\n- 支持体系: {{support_system}}\n\n## 用户偏好（如有）\n{{user_preferences}}\n\n## 应用领域\n{{application_domain}}\n\n## 历史跳过原因\n{{skip_reasons_history}}\n\n---\n\n请输出行为处方（严格JSON格式）：\n\n```json\n{\n  \"prescription_id\": \"RX_{{user_id}}_{{timestamp}}\",\n  \"version\": 1,\n  \"status\": \"draft\",\n  \"effective_date\": \"{{effective_date}}\",\n  \"created_by\": \"ai_assistant\",\n  \"requires_review\": true,\n  \n  \"target_behaviors\": [\n    {\n      \"behavior_id\": \"B001\",\n      \"description\": \"餐后散步\",\n      \"specific_target\": \"30分钟\",\n      \"frequency\": \"每日\",\n      \"trigger_context\": \"午餐后或晚餐后\",\n      \"trigger_cue\": \"放下筷子后\",\n      \"difficulty_level\": 2,\n      \"difficulty_display\": \"★★☆☆☆\",\n      \"metrics\": {\n        \"target_value\": 30,\n        \"unit\": \"分钟\",\n        \"minimum_value\": 10,\n        \"tracking_method\": \"manual_checkin\"\n      },\n      \"mini_version\": {\n        \"description\": \"餐后散步10分钟\",\n        \"trigger\": \"时间紧张或身体不适时\"\n      }\n    }\n  ],\n  \n  \"intervention_strategies\": {\n    \"core_strategies\": [\n      {\n        \"strategy_id\": \"STR_MICRO_HABIT\",\n        \"name\": \"微习惯培养\",\n        \"description\": \"从最小可行单位开始，降低启动阻力\",\n        \"implementation\": \"设置10分钟迷你版本作为保底\"\n      },\n      {\n        \"strategy_id\": \"STR_INSTANT_FEEDBACK\",\n        \"name\": \"即时正向反馈\",\n        \"description\": \"完成后立即给予认可和鼓励\",\n        \"implementation\": \"任务完成后自动发送庆祝消息\",\n        \"action_package_ref\": \"PKG_CELEBRATION\"\n      }\n    ],\n    \"weakness_strategies\": [\n      {\n        \"target_weakness\": \"D4_cognitive_knowledge\",\n        \"strategy_name\": \"认知教育模块\",\n        \"implementation\": \"每周推送3次知识卡片\",\n        \"content_ids\": [\"KC_GLUCOSE_BASICS\", \"KC_POSTMEAL_WALKING\"]\n      }\n    ]\n  },\n  \n  \"stage_plan\": {\n    \"launch_phase\": {\n      \"name\": \"启动期\",\n      \"duration_weeks\": 2,\n      \"goal\": \"建立基本行为模式，体验成功\",\n      \"task_difficulty_ratio\": 0.5,\n      \"followup_config\": {\n        \"ai_frequency\": \"daily\",\n        \"coach_frequency\": \"every_3_days\"\n      },\n      \"success_criteria\": \"完成率>=50%\",\n      \"stage_completion_trigger\": \"T_STAGE_COMPLETE\"\n    },\n    \"adaptation_phase\": {\n      \"name\": \"适应期\",\n      \"duration_weeks\": 6,\n      \"goal\": \"稳定行为频率，处理障碍\",\n      \"task_difficulty_ratio\": 0.8,\n      \"followup_config\": {\n        \"ai_frequency\": \"daily\",\n        \"coach_frequency\": \"weekly\"\n      },\n      \"success_criteria\": \"完成率>=70%，连续打卡>=7天\"\n    },\n    \"stabilization_phase\": {\n      \"name\": \"稳定期\",\n      \"duration_weeks\": 8,\n      \"goal\": \"行为内化，减少外部支持\",\n      \"task_difficulty_ratio\": 1.0,\n      \"followup_config\": {\n        \"ai_frequency\": \"weekly\",\n        \"coach_frequency\": \"biweekly\"\n      },\n      \"success_criteria\": \"完成率>=80%，连续打卡>=21天\"\n    }\n  },\n  \n  \"obstacle_plans\": [\n    {\n      \"obstacle_id\": \"OBS_001\",\n      \"obstacle_description\": \"工作忙，没时间运动\",\n      \"detection_trigger\": {\n        \"type\": \"skip_reason\",\n        \"keywords\": [\"没时间\", \"太忙\", \"加班\"]\n      },\n      \"response_strategy\": \"提供10分钟迷你版本\",\n      \"action_package_ref\": \"PKG_TASK_ADJUSTMENT\",\n      \"message_template\": \"忙碌的一天辛苦了！10分钟也是进步，要不要试试简化版？\"\n    },\n    {\n      \"obstacle_id\": \"OBS_002\",\n      \"obstacle_description\": \"身体不舒服\",\n      \"detection_trigger\": {\n        \"type\": \"skip_reason\",\n        \"keywords\": [\"不舒服\", \"生病\", \"累\"]\n      },\n      \"response_strategy\": \"允许休息，不施加压力\",\n      \"message_template\": \"身体是第一位的，今天好好休息吧。明天继续也不迟！\"\n    }\n  ],\n  \n  \"companion_message\": {\n    \"patient_version\": \"我们为您制定了一份21天启动计划，从简单的目标开始，每一小步都是进步！\",\n    \"detail_hidden\": [\"心理层次\", \"SPI分数\", \"风险评估\"]\n  },\n  \n  \"review_notes\": {\n    \"ai_recommendation\": \"建议教练关注认知知识维度，可增加血糖原理讲解\",\n    \"requires_expert_review\": false\n  }\n}\n```"
    },

    "followup_suggestion": {
      "id": "PROMPT_FOLLOWUP",
      "name": "跟进建议生成",
      "description": "为教练生成AI跟进建议",
      "model_config": {
        "primary": {"provider": "ollama", "model": "qwen2.5:7b"},
        "fallback": null
      },
      "parameters": {
        "temperature": 0.5,
        "max_tokens": 1000
      },
      
      "system_prompt": "你是一位健康教练的AI助手，帮助教练制定跟进策略和沟通话术。\n\n【跟进原则】\n1. 基于最新数据分析，不重复已知信息\n2. 建议要具体可操作\n3. 话术要温暖但不过度，避免说教\n4. 尊重用户的自主性\n5. 关注异常信号和正向进展\n\n【话术风格指南】\n- 使用\"我注意到...\"而非\"你应该...\"\n- 使用开放式问题而非封闭式\n- 先肯定后建议\n- 提供选择而非命令",

      "user_prompt_template": "请基于以下信息生成跟进建议。\n\n## 用户最新状态\n- 用户ID: {{user_id}}\n- 心理层次: {{psychological_level}}\n- 当前阶段: {{current_stage}}\n- 处方版本: {{prescription_version}}\n\n## 最近3天执行数据\n- 任务完成率: {{recent_completion_rate}}\n- 完成的任务: {{completed_tasks}}\n- 跳过的任务: {{skipped_tasks}}\n- 跳过原因: {{skip_reasons}}\n\n## 情绪趋势\n- 情绪趋势: {{emotion_trend}}\n- 异常情绪: {{anomaly_emotions}}\n\n## 最新对话摘要\n{{recent_conversation}}\n\n## 触发的警报\n{{triggered_alerts}}\n\n## 上次跟进记录\n- 时间: {{last_followup_time}}\n- 内容: {{last_followup_content}}\n\n---\n\n请输出跟进建议（严格JSON格式）：\n\n```json\n{\n  \"followup_id\": \"FU_{{user_id}}_{{timestamp}}\",\n  \"priority\": \"high|medium|low\",\n  \"summary\": \"一句话总结当前状态\",\n  \n  \"priority_actions\": [\n    {\n      \"action_id\": \"ACT_001\",\n      \"priority\": 1,\n      \"action_type\": \"address_obstacle|positive_reinforcement|knowledge_push|check_in\",\n      \"trigger_reason\": \"饮食记录连续3天未完成\",\n      \"suggested_message\": \"最近饮食记录好像有些中断，是遇到什么困难了吗？有时候觉得麻烦是很正常的，我们可以一起想想更简单的方式...\",\n      \"message_tone\": \"warm\",\n      \"action_buttons\": [\n        {\"text\": \"使用此话术\", \"action\": \"send_message\"},\n        {\"text\": \"修改\", \"action\": \"edit_message\"}\n      ]\n    }\n  ],\n  \n  \"knowledge_push\": {\n    \"recommended\": true,\n    \"content_id\": \"KC_POSTMEAL_GLUCOSE\",\n    \"title\": \"餐后血糖为什么重要\",\n    \"reason\": \"认知知识维度得分较低\",\n    \"best_time\": \"晚间8点\"\n  },\n  \n  \"positive_reinforcement\": {\n    \"trigger\": \"散步任务完成较好\",\n    \"suggested_message\": \"这周的餐后散步坚持得很棒！身体有没有感觉轻松一些？\",\n    \"achievement_badge\": \"连续3天散步达标\"\n  },\n  \n  \"risk_alerts\": [\n    {\n      \"alert_type\": \"completion_drop\",\n      \"severity\": \"medium\",\n      \"description\": \"完成率从70%下降到40%\",\n      \"recommended_response\": \"了解原因，可能需要调整处方难度\"\n    }\n  ],\n  \n  \"coach_notes\": \"用户最近工作压力较大，建议关注情绪状态，适当降低任务难度\"\n}\n```"
    }
  },

  "view_generation_rules": {
    "description": "为不同角色生成不同视图的规则，与StateSyncManager对接",
    
    "patient_view": {
      "role": "patient",
      "display_name": "C端患者视图",
      "principle": "正向引导，隐藏专业术语，保护隐私",
      "hidden_fields": [
        "psychological_level",
        "spi_score",
        "six_reasons_scores",
        "risk_assessment",
        "confidence_scores"
      ],
      "field_transformations": {
        "psychological_level": {
          "L1": "探索期",
          "L2": "思考期",
          "L3": "准备期",
          "L4": "成长期",
          "L5": "收获期"
        },
        "spi_interpretation": {
          "high": "您已经准备好开始改变了！",
          "medium_high": "您正在积极准备中，继续保持！",
          "medium_low": "让我们一起慢慢探索...",
          "low": "不着急，我会陪着您慢慢来"
        }
      },
      "ui_style_default": "warm",
      "avoid_terms": ["风险", "失败", "问题严重", "阻抗", "抵触", "低分", "弱"],
      "state_sync_event_type": "DIAGNOSIS_RESULT"
    },

    "coach_view": {
      "role": "coach",
      "display_name": "B端教练视图",
      "principle": "完整诊断信息，支持专业决策",
      "visible_fields": "all",
      "additional_fields": [
        "ai_suggestions",
        "intervention_scripts",
        "risk_flags",
        "confidence_scores"
      ],
      "highlight_fields": [
        "weakness_dimensions",
        "risk_alerts",
        "requires_verification"
      ],
      "action_buttons": [
        {"id": "send_message", "text": "发送消息", "action": "SEND_MESSAGE"},
        {"id": "push_knowledge", "text": "推送知识", "action": "PUSH_CONTENT"},
        {"id": "adjust_prescription", "text": "调整处方", "action": "EDIT_PRESCRIPTION"},
        {"id": "mark_followup", "text": "标记跟进", "action": "MARK_FOLLOWUP"},
        {"id": "escalate", "text": "升级专家", "action": "ESCALATE_TO_EXPERT"}
      ],
      "risk_flag_colors": {
        "GREEN": "#52c41a",
        "YELLOW": "#faad14",
        "ORANGE": "#fa8c16",
        "RED": "#f5222d"
      },
      "state_sync_event_type": "DIAGNOSIS_RESULT"
    },

    "expert_view": {
      "role": "expert",
      "display_name": "专家督导视图",
      "principle": "完整数据+审核功能",
      "visible_fields": "all",
      "additional_fields": [
        "raw_data",
        "ai_reasoning",
        "audit_history",
        "model_confidence"
      ],
      "action_buttons": [
        {"id": "approve", "text": "审核通过", "action": "APPROVE"},
        {"id": "request_changes", "text": "需要修改", "action": "REQUEST_CHANGES"},
        {"id": "reject", "text": "驳回", "action": "REJECT"},
        {"id": "intervene", "text": "直接介入", "action": "DIRECT_INTERVENTION"}
      ],
      "audit_fields": [
        "diagnosis_accuracy",
        "prescription_appropriateness",
        "risk_assessment_quality"
      ],
      "state_sync_event_type": "DIAGNOSIS_RESULT"
    }
  },

  "integration_config": {
    "dify_workflow": {
      "workflow_name": "Behavior Diagnosis Pipeline",
      "entry_node": "data_aggregation",
      "nodes": [
        {"id": "data_aggregation", "type": "code", "next": "layer1_diagnosis"},
        {"id": "layer1_diagnosis", "type": "llm", "prompt_id": "PROMPT_L1_DIAGNOSIS", "next": "psych_level"},
        {"id": "psych_level", "type": "llm", "prompt_id": "PROMPT_PSYCH_LEVEL", "next": "spi_calc"},
        {"id": "spi_calc", "type": "code", "next": "prescription_gen"},
        {"id": "prescription_gen", "type": "llm", "prompt_id": "PROMPT_PRESCRIPTION", "next": "view_dispatch"},
        {"id": "view_dispatch", "type": "code", "description": "分发到StateSyncManager"}
      ]
    },

    "state_sync_integration": {
      "event_types": [
        "DIAGNOSIS_COMPLETE",
        "SPI_CALCULATED",
        "PRESCRIPTION_GENERATED",
        "PRESCRIPTION_APPROVED"
      ],
      "view_mapping": {
        "patient": "patient_view",
        "coach": "coach_view",
        "expert": "expert_view",
        "admin": "expert_view"
      }
    },

    "trigger_integration": {
      "new_triggers": [
        {
          "id": "T_SPI_DROP",
          "name": "SPI显著下降",
          "condition": "spi_change < -10 within 7 days",
          "action_ref": "PKG_SPI_ALERT"
        },
        {
          "id": "T_LEVEL_REGRESSION",
          "name": "心理层次退行",
          "condition": "psychological_level decreased",
          "action_ref": "PKG_LEVEL_ALERT"
        },
        {
          "id": "T_ASSESSMENT_DUE",
          "name": "定期评估到期",
          "condition": "days_since_last_assessment >= 30",
          "action_ref": "PKG_ASSESSMENT_REMINDER"
        }
      ]
    }
  }
}
