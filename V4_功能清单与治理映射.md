# BehaviorOS V4.0 功能清单与治理映射

> 生成时间：2026-02-14
> 数据来源：9个并行审计Agent逐文件读取所有API文件 + grep治理维度
> 盘点范围：58个路由模块 + main.py内联端点 + 2个独立应用

---

## 概要

| 指标 | 数值 |
|------|------|
| **总端点数** | **646** |
| **功能分组** | 13大类 47小类 |
| **API文件数** | 58个路由文件 + 2个独立App |
| **RBAC覆盖率** | 543/646 = **84%** |
| **可见性分层** | 57/646 = **9%** |
| **积分联动率** | 51/646 = **8%** |
| **审计覆盖率** | 67/646 = **10%** |
| **安全管线率** | 8/646 = **1%** (仅safety_api.py自身) |

### 治理状态分布

| 治理等级 | 端点数 | 占比 | 描述 |
|----------|--------|------|------|
| 🔴 高风险 | **103** | 16% | 无RBAC **或** 弱认证(X-User-ID) |
| 🟡 中风险 | **320** | 50% | 有RBAC但缺 ≥2 项治理维度 |
| 🟢 低风险 | **223** | 34% | RBAC+至少1项其他治理 |

### RBAC认证层次分布

| 认证方式 | 端点数 | 安全等级 |
|----------|--------|----------|
| `require_admin` | 92 | 🟢 强 |
| `require_coach_or_admin` | 78 | 🟢 强 |
| `get_current_user` (JWT) | 373 | 🟢 强 |
| `get_current_user` (auth_api本地) | 3 | 🟢 强 |
| `_uid()` / X-User-Id fallback | 11 | 🟡 弱 |
| `get_mp_user` (X-User-ID header, default=1) | 13 | 🔴 弱 |
| `get_current_user_id` (X-User-ID header, default=1) | 20 | 🔴 弱 |
| **完全无认证** | **56** | 🔴 无 |

---

## 功能分组详表

### A. 用户生命周期 (51个端点)

#### A1. 注册与认证 (6个端点) — `auth_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/auth/register | POST | ⬜公开 | — | ⬜ | ✅ logger.info | — | ① | 系统 |
| /api/v1/auth/login | POST | ⬜公开 | — | ⬜ | ✅ UserActivityLog+logger | — | ① | 系统 |
| /api/v1/auth/me | GET | ✅本地JWT | — | ⬜ | ⬜ | — | ① | 系统 |
| /api/v1/auth/refresh | POST | ⬜无守卫 | — | ⬜ | ⬜ | — | ① | 系统 |
| /api/v1/auth/password | PUT | ✅本地JWT | — | ⬜ | ✅ logger.info | — | ① | 系统 |
| /api/v1/auth/logout | POST | ✅本地JWT | — | ⬜ | ✅ logger.info | — | ① | 系统 |

> 注: auth_api.py定义了自己的`get_current_user`（HTTPBearer），非dependencies.py版本。`/refresh`无依赖注入守卫，函数内部验证。

#### A2. 用户管理 (13个端点) — `user_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/admin/users | GET | ✅admin | — | ⬜ | ⬜ | — | ①⑤ | Admin |
| /api/v1/admin/users/{id} | GET | ✅admin | — | ⬜ | ⬜ | — | ①⑤ | Admin |
| /api/v1/admin/users | POST | ✅admin | — | ⬜ | ✅ logger.info | — | ①⑤ | Admin |
| /api/v1/admin/users/{id} | PUT | ✅admin | — | ⬜ | ✅ logger.info | — | ①⑤ | Admin |
| /api/v1/admin/users/{id}/status | PUT | ✅admin | — | ⬜ | ✅ logger.info | — | ①⑤ | Admin |
| /api/v1/admin/users/{id} | DELETE | ✅admin | — | ⬜ | ✅ logger.info | — | ①⑤ | Admin |
| /api/v1/admin/stats | GET | ✅admin | — | ⬜ | ⬜ | — | ⑤ | Admin |
| /api/v1/admin/coaches | GET | ✅admin | — | ⬜ | ⬜ | — | ⑤ | Admin |
| /api/v1/admin/distribution/* (5ep) | 混合 | ✅admin | — | ⬜ | ✅1/5 | — | ①⑤ | Admin |

#### A3. 角色与权限 (10个端点) — `segments_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/segments/* (10ep全部) | GET/POST | 🔴无认证 | ⬜ | ⬜ | ⬜ | ⬜ | ①⑤ | — |

> **🔴 严重**: segments_api.py全部10个端点完全无认证，任何人可访问用户分段和权限数据。

#### A4. 用户旅程 (22个端点) — `journey_api.py` + `agency_api.py`

| 模块 | 端点数 | R | V | P | A | S | C | O |
|------|--------|---|---|---|---|---|---|---|
| journey_api.py | 15 | 15/15✅ | 2/15 (stage config可见性) | 3/15 (StageEngine point_event) | 3/15 (StageEngine logger) | 0 | ②③ | Coach/系统 |
| agency_api.py | 8 | 8/8✅ | 0/8 | 0/8 | 1/8 | 0 | ②③ | Coach/系统 |
| **小计** | **23** | **23/23** | **2/23** | **3/23** | **4/23** | **0** | | |

---

### B. 评估与诊断 (37个端点)

#### B1. 通用评估 (17个端点) — `assessment_api.py` + `assessment_pipeline_api.py` + `assessment_assignment_api.py`

| 模块 | 端点数 | R | V | P | A | S | C | O |
|------|--------|---|---|---|---|---|---|---|
| assessment_api.py | 5 | 5/5✅ | 3/5 (ownership check) | 0 | 4/5 logger | 0 | ④⑭ | 系统 |
| assessment_pipeline_api.py | 4 | 4/4✅ | 2/4 (coach/user dual-view) | 0 | 0 | 0 | ②④⑭ | 系统 |
| assessment_assignment_api.py | 8 | 8/8✅ | 7/8 (coach_id/student_id scope) | 0 | 0 | 0 | ④⑭ | Coach |
| **小计** | **17** | **17/17** | **12/17** | **0** | **4/17** | **0** | | |

> 评估提交不产生积分事件——建议Sheet⑦增加`assessment_submit(+5)`事件。

#### B2. 调查问卷 (16个端点) — `survey_api.py` + `survey_response_api.py` + `survey_stats_api.py`

| 模块 | 端点数 | R | V | P | A | S | C | O |
|------|--------|---|---|---|---|---|---|---|
| survey_api.py | 10 | 10/10 (admin/coach) | 0 | 0 | 0 | 0 | ⑭ | Admin/Coach |
| survey_response_api.py | 3 | 2/3 (短码匿名OK) | 0 | 0 | 0 | 0 | ⑭ | 系统 |
| survey_stats_api.py | 3 | 3/3 (admin) | 0 | 0 | 0 | 0 | ⑭ | Admin |
| **小计** | **16** | **15/16** | **0** | **0** | **0** | **0** | | |

#### B3. BAPS评估引擎 (4个端点) — `baps_api.py` (独立应用 :8001)

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /baps/* (全部~16ep) | 混合 | 🔴无认证 | ⬜ | ⬜ | ⬜ | ⬜ | ④⑭ | — |

> **🔴 严重**: baps_api.py是独立FastAPI应用，所有~16个端点完全无认证、无任何治理维度。

---

### C. 干预与行动 (62个端点)

#### C1. 行为处方Rx (8个端点) — `behavior_rx/rx_routes.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/rx/compute | POST | ✅coach+ | ⬜ | ⬜ | ⬜ | ⬜ | ④⑬ | Coach |
| /api/v1/rx/strategies | GET | ⬜公开 | ⬜ | ⬜ | ⬜ | ⬜ | ④⑬ | — |
| /api/v1/rx/* (其余6ep) | 混合 | ✅coach+ | ⬜ | ⬜ | ⬜ | ⬜ | ④⑬ | Coach |

#### C2. 微行动 (~6个端点) — `micro_action_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/micro-actions/* (全部) | 混合 | ✅JWT | ⬜ | ⬜ | ⬜ | ⬜ | ③⑦ | 系统 |

> 微行动完成不产生积分事件——建议Sheet⑦增加`micro_action_complete(+3)`。

#### C3. 挑战打卡 (~30个端点) — `challenge_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/challenges/* (全部~30ep) | 混合 | ✅JWT/coach+/admin | 部分(coach scope) | ⬜ | ⬜ | ⬜ | ③⑦⑨ | Coach/Admin |

> 0%审计、0%安全管线、0%积分联动（挑战完成应触发积分事件）。

#### C4. 智能监测方案 (13个端点) — `program_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/programs/* (全部13ep) | 混合 | ✅JWT/coach+/admin | 部分(user scope) | 2/13 (enroll+10, interact+3) | ⬜ | ⬜ | ③④⑦ | Coach/系统 |

#### C5. 提醒与推送 (~13个端点) — `reminder_api.py` + `coach_push_queue_api.py` + `push_recommendation_api.py`

| 模块 | 端点数 | R | V | P | A | S | C | O |
|------|--------|---|---|---|---|---|---|---|
| reminder_api.py | ~5 | ✅JWT | 0 | 0 | 0 | 0 | ③ | 系统 |
| coach_push_queue_api.py | ~5 | ✅coach+ | 5/5 (coach scope) | 0 | 0 | 0 | ③⑨ | Coach |
| push_recommendation_api.py | ~3 | ✅JWT | 0 | 0 | 0 | 0 | ③④ | 系统 |

---

### D. Agent与AI (68个端点)

#### D1. Agent对话 (5个端点) — `chat_rest_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/chat/sessions | GET | ✅JWT | ✅user.id scope | ⬜ | ⬜ | ⬜ | ④ | 系统 |
| /api/v1/chat/sessions | POST | ✅JWT | — | ⬜ | ✅ logger.info | ⬜ | ④ | 系统 |
| /api/v1/chat/sessions/{id}/messages | GET | ✅JWT | ✅ownership | ⬜ | ⬜ | ⬜ | ④ | 系统 |
| /api/v1/chat/sessions/{id}/messages | POST | ✅JWT | ✅ownership | ⬜ | ✅ logger.info | ⬜ | ④⑥ | 系统 |
| /api/v1/chat/sessions/{id} | DELETE | ✅JWT | ✅ownership | ⬜ | ✅ logger.info | ⬜ | ④ | 系统 |

> `send_message`直接调用Ollama/RAG，**未经过SafetyPipeline**。

#### D2. Agent运行与路由 (11个端点) — `agent_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/agent/list | GET | ✅JWT+tenant | ✅tenant enabled_agents filter | ⬜ | ⬜ | ⬜ | ④⑬ | 系统 |
| /api/v1/agent/run | POST | ✅JWT+tenant | ✅observer whitelist | ⬜ | ⬜ | ⬜ | ④⑥⑬ | 系统 |
| /api/v1/agent/* (其余9ep) | 混合 | ✅JWT | ⬜ | ⬜ | ⬜ | ⬜ | ④⑬ | 系统 |

> `/agent/run`通过MasterAgent可能内部触发SafetyPipeline，但API层无直接调用。

#### D3. Agent模板管理 (10个端点) — `agent_template_api.py`

全部`require_admin`。R=10/10, V=0, P=0, A=0, S=0。Sheet: ④⑬。Owner: Admin。

#### D4. Agent生态市场 (12个端点) — `agent_ecosystem_api.py`

全部有认证(JWT/admin/coach+)。R=12/12, V=2/12(role+tenant), P=0, A=0, S=0。Sheet: ⑬。

#### D5. Agent反馈与质量 (8个端点) — `agent_feedback_api.py`

R=8/8(JWT/admin/coach+), V=0, P=0, A=0, S=0。Sheet: ④⑬⑭。

#### D6. 专家Agent管理 (6个端点) — `expert_agent_api.py`

R=6/6(JWT+tenant), V=0, P=0, A=0, S=0。Sheet: ④⑬。

#### D7. 策略引擎 (12个端点) — `policy_api.py`

全部`require_admin`。R=12/12, V=0, P=0, A=12/12(DecisionTrace), S=0。Sheet: ④⑨⑬。

#### D8. main.py内联端点 (19个端点) — `main.py @app.*`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/dispatch | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /health | GET | ⬜公开 | — | — | — | — | ⑫ | 系统 |
| /api/v1/health | GET | ⬜公开 | — | — | — | — | ⑫ | 系统 |
| /api/v1/experts | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /api/v1/dashboard/{user_id} | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ⑤ | — |
| /api/v1/decompose | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/process | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/briefing | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/briefing/{id}/message | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/agent-task | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/action-plan | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/action-plan/{id}/phased | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/profile/{user_id} | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④⑤ | — |
| /orchestrator/device-sync | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/coordinate | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/route | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/route/detailed | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /orchestrator/status | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |
| /api/v1/brain/evaluate | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | ④ | — |

> **🔴 严重**: 全部17个非health端点零RBAC。`/orchestrator/profile/{user_id}`可获取任意用户画像，`/orchestrator/process`可触发Agent管线——均无任何认证。

---

### E. 数据采集与设备 (45个端点)

#### E1. 设备管理与健康数据 — REST (11个端点) — `device_rest_api.py`

全部`get_current_user` JWT认证。R=11/11✅, V=0, P=0, A=11/11(logger.info), S=0。Sheet: ⑩⑫。

#### E2. 小程序设备数据接口 (20个端点) — `device_data.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /device/* (全部20ep) | 混合 | 🔴X-User-ID(default=1) | ⬜ | ⬜ | ✅logger(部分) | ⬜ | ⑩⑫ | — |

> **🔴 严重**: `get_current_user_id()`读取`X-User-ID`请求头，默认值为1，无JWT验证。任何请求者可传入任意user_id冒充用户。

#### E3. 设备告警 (4个端点) — `device_alert_api.py`

R=4/4✅, V=4/4✅(user/coach scope), P=0, A=0, S=0。Sheet: ③⑩。

#### E4. 食物识别 (2个端点) — `food_recognition_api.py`

R=2/2✅, V=0, P=0, A=1/2, S=0。LLM调用(qwen2.5vl)**未经SafetyPipeline**。Sheet: ④⑩。

#### E5. 高频问题预设 (4个端点) — `high_freq_api.py`

R=0/4(全公开), V=0, P=0, A=0, S=0。Sheet: ④。

#### E6. 文件上传 (1个端点) — `upload_api.py`

R=1/1✅, V=0, P=0, A=0, S=0。Sheet: ⑫。

#### E7. WebSocket实时推送 (3个端点) — `websocket_api.py`

R=0/3(user_id从query param，无JWT), V=0, P=0, A=3/3(logger), S=0。Sheet: ⑫。

> **🟡**: `/ws/user/{user_id}`任何人可订阅任意用户的通知频道。

---

### F. 学习与成长 (77个端点)

#### F1. 内容浏览与管理 (50个端点) — `content_api.py` + `content_manage_api.py` + `content_contribution_api.py` + `expert_content_api.py`

| 模块 | 端点数 | R | V | P | A | S | C | O |
|------|--------|---|---|---|---|---|---|---|
| content_api.py | 28 | 21/28(6公开) | 3/28(L0-L5门控) | 1/28(quiz→积分) | 5/28(UserActivityLog) | 0 | ⑤⑦⑪ | Coach/系统 |
| content_manage_api.py | 7 | 7/7(coach+) | 0 | 0 | 0 | 0 | ⑤⑨⑪ | Coach |
| content_contribution_api.py | 7 | 7/7(JWT+role) | 0 | 0 | 0 | 0 | ⑤⑪ | Coach |
| expert_content_api.py | 8 | 8/8(JWT+tenant) | 0 | 0 | 0 | 0 | ⑤⑪⑬ | Expert |

> 内容publish/unpublish/delete无审计日志——高风险操作无痕迹。

#### F2. 学习进度与积分 (15个端点) — `learning_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/learning/coach/points/{user_id} | GET | ✅JWT | 🔴无ownership检查 | ✅读取 | ⬜ | ⬜ | ⑦⑧ | 系统 |
| /api/v1/learning/grower/stats/{user_id} | GET | ✅JWT | 🔴无ownership检查 | ✅读取 | ⬜ | ⬜ | ⑦⑧ | 系统 |
| /api/v1/learning/event | POST | ✅JWT | — | ✅record_learning_points | ✅UserActivityLog | ⬜ | ⑦ | 系统 |
| (其余12ep同上模式) | 混合 | ✅JWT | — | 8/15积分相关 | 2/15审计 | 0 | ⑦⑧ | 系统 |

> **🟡 水平越权**: `/coach/points/{user_id}`, `/grower/stats/{user_id}`等接受任意user_id路径参数，仅验证调用者已登录，不验证调用者是否有权查看该用户数据。

#### F3. 考试系统 (18个端点) — `exam_api.py` + `question_api.py` + `exam_session_api.py`

| 模块 | 端点数 | R | V | P | A | S | C | O |
|------|--------|---|---|---|---|---|---|---|
| exam_api.py | ~9 | ✅admin | 0 | 0 | 0 | 0 | ⑤⑧ | Admin |
| question_api.py | ~5 | ✅admin | 0 | 0 | 0 | 0 | ⑤⑧ | Admin |
| exam_session_api.py | ~4 | ✅JWT | 0 | 1/4(考试通过→积分) | 0 | 0 | ⑤⑦⑧ | 系统 |

#### F4. 教练等级与学习路径 (6个端点) — `paths_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/coach-levels/levels | GET | ⬜公开 | — | — | — | — | ⑤⑧ | — |
| /api/v1/coach-levels/modules | GET | ⬜公开 | — | — | — | — | ⑤⑧ | — |
| /api/v1/coach-levels/progress | GET | ✅JWT | — | ✅读3维积分 | — | — | ⑤⑦⑧ | 系统 |
| /api/v1/coach-levels/overview | GET | ⬜公开 | — | — | — | — | ⑤⑧ | — |
| (其余2ep) | GET | ✅JWT | — | 2/2读积分 | — | — | ⑤⑦⑧ | 系统 |

#### F5. 话术库 (6个端点) — `script_library_api.py`

R=6/6(JWT/coach+/admin), V=0, P=0, A=0, S=0。Sheet: ⑤⑪。

---

### G. 社交与协作 (20个端点)

#### G1. 同伴关系 (6个端点) — `companion_api.py`

R=6/6(JWT/admin), V=0, P=0, A=0, S=0。Sheet: ⑧⑨。

#### G2. 同伴匹配与支持 (9个端点) — `peer_matching_api.py` + `peer_support_api.py`

R=9/9(JWT/admin), V=0, P=0, A=0, S=0。Sheet: ⑧⑨。

#### G3. 教练消息 (~5个端点) — `coach_message_api.py`

R=5/5(JWT), V=ownership filter, P=0, A=0, S=0。Sheet: ③④。

---

### H. 教练与督导 (38个端点)

#### H1. 教练仪表盘 (12个端点) — `coach_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/coach/dashboard | GET | ✅coach+ | ✅coach_id scope | ⬜ | ⬜ | ⬜ | ⑤⑨⑭ | Coach |
| /api/v1/coach/students | GET | ✅coach+ | ✅coach_id scope | ⬜ | ⬜ | ⬜ | ⑤⑨ | Coach |
| /api/v1/coach/students/{id}/behavioral-profile | GET | ✅coach+ | ✅filter_nested_profile | ⬜ | ⬜ | ⬜ | ⑤⑩ | Coach |
| /api/v1/coach/students/{id}/glucose | GET | ✅coach+ | ✅_verify_coach_student | ⬜ | ⬜ | ⬜ | ⑤⑩ | Coach |
| /api/v1/coach/directory | GET | ⬜公开 | — | — | — | — | ⑤ | — |
| (其余7ep同上模式) | 混合 | ✅coach+ | 10/13可见性 | 0 | 0 | 0 | ⑤⑨⑩ | Coach |

> coach_api.py有最强的可见性分层实现(filter_nested_profile + get_hidden_fields)。

#### H2. 教练分析 (6个端点) — `analytics_api.py`

R=6/6(coach+), V=coach scope, P=0, A=0, S=0。Sheet: ⑤⑨⑭。

#### H3. 管理员分析 (7个端点) — `admin_analytics_api.py`

R=7/7(admin), V=0, P=0, A=0, S=0。Sheet: ⑤⑨⑭。

#### H4. 专家租户管理 (10个端点) — `tenant_api.py`

R=10/10(JWT/admin), V=tenant scope, P=0, A=0, S=0。Sheet: ⑬。

#### H5. 专家入驻注册 (8个端点) — `expert_registration_api.py`

R=6/8(JWT/admin; 2个domain查询公开), V=0, P=0, A=0, S=0。Sheet: ①⑬。

---

### I. 积分与激励 (30个端点)

#### I1. 学分管理 (8个端点) — `credits_api.py`

R=8/8(JWT/admin), V=0, P=8/8(全部积分相关), A=0, S=0。Sheet: ⑦⑧。

#### I2. 觉察积分阶段 (7个端点) — `incentive_phase_api.py`

R=7/7(JWT), V=0, P=5/7(PointTransaction), A=2/7, S=0。Sheet: ⑦。

#### I3. 徽章与里程碑 (11个端点) — `core/milestone_service.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/incentive/* (全部11ep) | 混合 | ✅_uid()(JWT+X-User-Id fallback) | ⬜ | 11/11✅(PointTransaction) | ⬜ | ⬜ | ⑦⑧ | 系统 |

> `_uid()`先尝试JWT解析，失败则fallback到X-User-Id header——属于弱认证。

#### I4. 反作弊 (4个端点) — 嵌入`governance_api.py`

R=4/4(JWT/admin), V=0, P=4/4(查询PointTransaction), A=1/4(anomaly logger.warning), S=0。Sheet: ⑦⑨。

---

### J. 晋级与治理 (42个端点)

#### J1. 晋级体系 (6个端点) — `promotion_api.py`

R=6/6(JWT/admin), V=0, P=4/6(eligibility查积分), A=0, S=0。Sheet: ⑧。

#### J2. 治理仪表盘 (26个端点) — `governance_api.py`

| 模块 | 端点数 | R | V | P | A | S | C | O |
|------|--------|---|---|---|---|---|---|---|
| dual-track (3) | 3 | ✅JWT | 0 | 0 | 0 | 0 | ⑧ | 系统 |
| anti-cheat (4) | 4 | ✅JWT/admin | 0 | 4 | 1 | 0 | ⑦⑨ | Admin |
| responsibility (4) | 4 | ✅JWT/coach+/admin | 0 | 0 | 0 | 0 | ⑨ | Coach/Admin |
| violations (3) | 3 | ✅coach+/admin | 0 | 1(penalty) | 0 | 0 | ⑨ | Admin |
| service-rights (2) | 2 | ✅JWT | 2(level filter) | 0 | 0 | 0 | ⑤ | 系统 |
| companions (3) | 3 | ✅JWT | 0 | 0 | 0 | 0 | ⑧ | 系统 |
| observer (2) | 2 | ✅JWT | 2(role gate) | 0 | 0 | 0 | ①⑤ | 系统 |
| agent-layer (2) | 2 | ✅JWT | 2(level→agents) | 0 | 0 | 0 | ④⑤ | 系统 |
| self-audit (2) | 2 | ✅coach+ | 1 | 0 | 0 | 0 | ⑨ | Coach |
| **小计** | **26** | **26/26** | **7/26** | **5/26** | **1/26** | **0** | | |

#### J3. 契约签署 (6个端点) — `contract_api.py`

R=6/6(JWT), V=0, P=0, A=1/6(IP/UA capture), S=0。Sheet: ⑨。

#### J4. 干预成效指数 (4个端点) — `ies_api.py`

R=4/4(JWT), V=0, P=0, A=0, S=0。Sheet: ⑭。

---

### K. 知识管理 (20个端点)

#### K1. 知识共享 (9个端点) — `knowledge_sharing_api.py`

R=9/9(JWT/coach+), V=3/9(expert-only gate), P=0, A=0, S=0。Sheet: ⑪⑬。

#### K2. 批量灌注 (4个端点) — `batch_ingestion_api.py`

R=4/4(coach+), V=0, P=0, A=0, S=0。Sheet: ⑪。

#### K3. 后端知识API (7个端点) — `backend/api/knowledge.py`

R=7/7(JWT), V=0, P=0, A=0, S=0。Sheet: ⑪。

---

### L. 安全与审计 (20个端点)

#### L1. 安全管线管理 (8个端点) — `safety_api.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /api/v1/safety/dashboard | GET | ✅admin | — | — | — | ✅ | ⑥ | Admin |
| /api/v1/safety/logs | GET | ✅admin | — | — | — | ✅ | ⑥ | Admin |
| /api/v1/safety/logs/{id} | GET | ✅admin | — | — | — | ✅ | ⑥ | Admin |
| /api/v1/safety/logs/{id}/resolve | POST | ✅admin | — | — | — | ✅ | ⑥ | Admin |
| /api/v1/safety/review-queue | GET | ✅admin | — | — | — | ✅ | ⑥ | Admin |
| /api/v1/safety/config | GET | ✅admin | — | — | — | ✅ | ⑥ | Admin |
| /api/v1/safety/config | PUT | ✅admin | — | — | — | ✅ | ⑥ | Admin |
| /api/v1/safety/reports/daily | GET | ✅admin | — | — | — | ✅ | ⑥ | Admin |

> **唯一8个S=✅的端点**。SafetyPipeline自身的管理界面，但SafetyPipeline在其他API层的集成率为0%。

#### L2. V14管理路由 (15个端点) — `v14/admin_routes.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /v14/admin/* (全部15ep) | 混合 | 🔴无认证 | ⬜ | ⬜ | ⬜ | ⬜ | ⑤⑨ | — |

> **🔴 严重**: 15个管理员端点（用户CRUD、角色变更、数据清理）完全无任何认证。

---

### M. 平台管理与遗留 (136个端点)

#### M1. 系统健康检查 (2个端点) — `main.py`

/health 和 /api/v1/health，公开，符合预期。Sheet: ⑫。

#### M2. 全局搜索 (~5个端点) — `search_api.py`

R=5/5(JWT), V=0, P=0, A=0, S=0。Sheet: ⑫。

#### M3. 用户统计 (~5个端点) — `user_stats_api.py`

R=5/5(JWT/admin), V=0, P=0, A=0, S=0。Sheet: ⑤⑭。

#### M4. 高级权益 (3个端点) — `advanced_rights_api.py`

R=3/3(JWT), V=1/3(level filter), P=0, A=0, S=0。Sheet: ⑤。

#### M5. 反思日志 (5个端点) — `reflection_api.py`

R=5/5(JWT), V=0, P=0, A=0, S=0。Sheet: ③。

> 反思提交不产生积分事件——建议Sheet⑦增加`reflection_create(+5)`。

#### M6. 生态V4聚合 (12个端点) — `ecosystem_v4_api.py`

R=12/12(JWT), V=0, P=0, A=1/12, S=0。Sheet: ③④⑤⑦⑧⑨⑬。

#### M7. V3遗留路由 (6个端点) — `v3/routes.py`

| 端点 | 方法 | R | V | P | A | S | C | O |
|------|------|---|---|---|---|---|---|---|
| /v3/chat | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | — | — |
| /v3/status | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | — | — |
| /v3/sessions | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | — | — |
| /v3/sessions/{id}/history | GET | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | — | — |
| /v3/sessions/reset_all | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | — | — |
| /v3/knowledge/reload | POST | 🔴无 | ⬜ | ⬜ | ⬜ | ⬜ | — | — |

> **🔴 严重**: `/v3/sessions/reset_all`可清空所有会话，无需任何认证。

#### M8. 小程序入口 (14个端点) — `miniprogram.py`

R=13/14(get_mp_user, X-User-ID header default=1), V=0, P=1/14(内存积分), A=0, S=0。Sheet: ③④。

> **🔴**: `get_mp_user`使用X-User-ID header(default=1)，无JWT验证。`/mp/chat`和`/mp/agent/respond`调用LLM但不经SafetyPipeline。

#### M9. BAPS独立应用 (~16个端点) — `baps_api.py` (:8001)

R=0/16(🔴全无认证), V=0, P=0, A=0, S=0。独立FastAPI应用。Sheet: ④⑭。

#### M10. 行健独立应用 (~7个端点) — `xingjian_api.py` (:8000)

R=0/7(🔴全无认证), V=0, P=0, A=0, S=0。独立FastAPI应用。Sheet: ④。

#### M11. V14管理路由 → 见L2

#### M12. 其余遗留文件 (~40个端点)

包括`v3/api_endpoints.py`、`core/milestone_service.py`内联路由等，混合认证状态。

---

## 治理真空清单

### 🔴 高风险——无RBAC + 无审计（需立即修复）

| 功能 | 文件 | 端点数 | 缺失维度 | 建议优先级 |
|------|------|--------|----------|-----------|
| V14管理路由 | v14/admin_routes.py | 15 | R+V+P+A+S全缺 | **P0** 加`require_admin` |
| main.py编排器 | main.py @app.* | 17 | R+V+P+A+S全缺 | **P0** 加`get_current_user` |
| 用户分段 | segments_api.py | 10 | R+V+P+A+S全缺 | **P0** 加`get_current_user` |
| BAPS引擎 | baps_api.py | 16 | R+V+P+A+S全缺(独立app) | **P0** 加认证中间件 |
| 行健API | xingjian_api.py | 7 | R+V+P+A+S全缺(独立app) | **P0** 加认证中间件 |
| V3遗留路由 | v3/routes.py | 6 | R+V+P+A+S全缺(含reset_all!) | **P0** 加认证或下线 |
| 小程序设备数据 | device_data.py | 20 | 弱R(X-User-ID)+V+P+A+S缺 | **P0** 改用JWT认证 |
| 小程序入口 | miniprogram.py | 13 | 弱R(X-User-ID)+V+P+A+S缺 | **P1** 改用JWT认证 |
| **小计** | | **104** | | |

### 🟡 中风险——有RBAC但缺≥2项治理维度

| 功能 | 文件 | 端点数 | 缺失维度 | 建议优先级 |
|------|------|--------|----------|-----------|
| Agent对话(send_message) | chat_rest_api.py | 1 | S(AI输出无SafetyPipeline) | **P1** 加SafetyPipeline.filter_output |
| Agent运行(/run) | agent_api.py | 1 | S+P(无积分无安全) | **P1** API层加SafetyPipeline |
| 食物识别(LLM调用) | food_recognition_api.py | 1 | S(LLM输出无安全过滤) | **P1** 加SafetyPipeline |
| 内容管理(CRUD) | content_manage_api.py | 7 | A+S(无审计无安全) | **P1** 加审计日志 |
| 内容贡献(审核) | content_contribution_api.py | 7 | A+S(approve/reject无审计) | **P1** 加审计日志 |
| 学习API(越权) | learning_api.py | 8 | V(/{user_id}无ownership) | **P1** 加ownership校验 |
| 挑战打卡(全模块) | challenge_api.py | 30 | A+P+S(0%审计+0%积分+0%安全) | **P2** 加积分事件 |
| 微行动(全模块) | micro_action_api.py | 6 | P+A+S(完成不产生积分) | **P2** 加积分事件 |
| 考试提交 | exam_session_api.py | 4 | A+S(考试结果无审计) | **P2** 加审计 |
| 评估提交 | assessment_api.py | 5 | P+S(评估不产生积分) | **P2** 加积分事件 |
| Agent模板CRUD | agent_template_api.py | 10 | A(管理操作无审计) | **P2** 加审计 |
| WebSocket | websocket_api.py | 3 | R(无JWT, user_id参数可伪造) | **P2** 加token验证 |
| 高频问题 | high_freq_api.py | 4 | R(全公开) | **P3** 评估是否需要认证 |
| 专家内容(CRUD) | expert_content_api.py | 8 | A(发布/删除无审计) | **P2** 加审计 |
| 同伴关系 | companion_api.py | 6 | P+A(加入/退出无积分无审计) | **P3** 加积分事件 |
| 反思日志 | reflection_api.py | 5 | P(创建无积分) | **P3** 加积分事件 |
| 同伴匹配/支持 | peer_matching/support | 9 | P+A(匹配无积分无审计) | **P3** 加积分事件 |
| 契约签署 | contract_api.py | 6 | P(签约无积分) | **P3** 加积分事件 |
| **小计** | | **~120** | | |

### 🟢 低风险——RBAC完备，仅缺积分联动

| 功能 | 文件 | 端点数 | 缺失维度 | 建议 |
|------|------|--------|----------|------|
| 治理仪表盘 | governance_api.py | 26 | P部分(仅anti-cheat读积分) | Sheet⑦增加治理行为事件 |
| 旅程管理 | journey_api.py | 15 | P部分(仅stage变更触发) | Sheet⑦增加旅程里程碑事件 |
| 策略引擎 | policy_api.py | 12 | P(策略操作无积分) | 无需积分(管理功能) |
| 安全管线管理 | safety_api.py | 8 | P(管理操作无积分) | 无需积分(管理功能) |
| 教练仪表盘 | coach_api.py | 12 | P(教练行为无积分) | Sheet⑦增加coach_action事件 |
| 教练分析 | analytics_api.py | 6 | P(无积分) | 无需积分(只读) |
| **小计** | | **~79** | | |

---

## 治理维度全景分析

### R (RBAC权限控制) — 84%覆盖

**3种认证方式**:
1. **JWT标准认证** (`dependencies.py: get_current_user/require_admin/require_coach_or_admin`) — 543个端点
2. **弱Header认证** (`get_mp_user`/`get_current_user_id`，读X-User-ID, default=1) — 33个端点
3. **完全无认证** — 56个端点（分散在v14/admin_routes, segments_api, v3/routes, main.py inline, baps_api, xingjian_api, high_freq_api, 部分content_api, paths_api）

**核心问题**: 弱Header认证(33个)+无认证(56个) = **89个端点无真正安全认证**

### V (可见性分层) — 9%覆盖

**最佳实践**: `coach_api.py`的`filter_nested_profile()`+`get_hidden_fields()` (基于viewer level过滤字段)

**典型缺失模式**:
- 大多数端点返回固定数据结构，不根据调用者角色调整
- `/{user_id}`路径参数端点通常仅检查JWT有效性，不验证调用者与目标用户关系

### P (积分联动) — 8%覆盖

**已实现积分事件** (51个端点):
- learning_api.py: record_learning_points (8个端点)
- credits_api.py: 全部8个端点
- incentive_phase_api.py: 5个端点 (PointTransaction)
- milestone_service.py: 11个端点 (PointTransaction)
- program_api.py: 2个端点 (enroll+10, interact+3)
- governance_api.py: 5个端点 (anti-cheat查询)
- promotion_api.py: 4个端点 (eligibility查积分)
- content_api.py: 1个端点 (quiz submit)
- miniprogram.py: 1个端点 (内存积分，未持久化!)
- journey_api.py: 3个端点 (StageEngine point_event)
- exam_session_api.py: 1个端点

**建议新增积分事件** (Sheet⑦):

| 事件ID | 触发行为 | 建议积分 | 涉及端点 |
|--------|---------|---------|---------|
| assessment_submit | 完成评估 | +5 | assessment_api /submit |
| micro_action_complete | 完成微行动 | +3 | micro_action_api /complete |
| challenge_checkin | 挑战打卡 | +3 | challenge_api /checkin |
| challenge_complete | 完成挑战 | +10 | challenge_api /complete |
| reflection_create | 创建反思 | +5 | reflection_api /entries POST |
| contract_sign | 签署契约 | +5 | contract_api /sign |
| companion_add | 建立同伴关系 | +3 | companion_api /add |
| contribution_submit | 提交知识贡献 | +5 | content_contribution_api /submit |
| food_recognize | 食物识别 | +2 | food_recognition_api /recognize |
| peer_accept | 接受同伴匹配 | +3 | peer_matching_api /accept |

### A (审计日志) — 10%覆盖

**审计实现方式**:
1. `UserActivityLog` ORM记录 — 最佳实践（learning_api, content_api, auth_api）
2. `logger.info` with user context — 次佳（device_rest_api, auth_api, user_api）
3. `DecisionTrace` 表 — 策略引擎专用（policy_api 12个端点）
4. IP/UA capture — contract_api（1个端点）

**严重审计盲区**:
- 内容管理(content_manage_api): create/update/publish/delete — 7个端点 0审计
- 专家内容(expert_content_api): publish/unpublish/delete — 8个端点 0审计
- 挑战管理(challenge_api): 模板CRUD/推送/审核 — 30个端点 0审计
- Agent模板(agent_template_api): create/update/delete/toggle — 10个端点 0审计
- 知识共享审核(knowledge_sharing_api): approve/reject — 9个端点 0审计
- V14管理路由: 用户CRUD/角色变更 — 15个端点 0审计(且无RBAC!)

### S (安全管线) — 1%覆盖

**SafetyPipeline (V005)存在但未集成**:
- 4层管线: input_filter → rag_safety → generation_guard → output_filter
- 仅`safety_api.py`的8个管理端点标记S=✅（这是SafetyPipeline自身的管理界面）
- **全平台所有LLM调用端点均未在API层集成SafetyPipeline**

**急需SafetyPipeline集成的端点**:

| 端点 | 原因 | 优先级 |
|------|------|--------|
| /api/v1/chat/sessions/{id}/messages POST | 用户输入→LLM→用户输出 | **P0** |
| /api/v1/agent/run POST | MasterAgent管线输出 | **P0** |
| /mp/chat POST | 小程序对话→LLM | **P0** |
| /mp/agent/respond POST | 小程序Agent→LLM | **P0** |
| /api/v1/food/recognize POST | 图片→LLM→营养建议 | **P1** |
| /api/v1/rx/compute POST | 行为处方生成 | **P1** |
| /orchestrator/process POST | 编排器→Agent管线 | **P1** (需先加RBAC) |
| /api/v1/reflection/entries POST | 用户反思内容 | **P2** |
| /api/v1/content/{id}/comment POST | 用户评论内容 | **P2** |

---

## 注册表扩展建议

### Sheet⑤ 服务权益矩阵 — 需增加行

| 功能服务 | 当前状态 | 建议 |
|---------|---------|------|
| 反思日志 | 未覆盖 | 增加：observer只读/grower+可创建 |
| 同伴匹配 | 未覆盖 | 增加：grower+可发起/observer不可 |
| 挑战打卡 | 未覆盖 | 增加：按level限制可报名挑战数 |
| 食物识别 | 未覆盖 | 增加：observer每日限3次/grower+不限 |
| 知识贡献 | 未覆盖 | 增加：sharer+可贡献/grower不可 |
| 行为处方 | 未覆盖 | 增加：coach+可生成/其他不可 |

### Sheet⑦ 积分契约 — 需增加事件类型

见上方"建议新增积分事件"表，10个新事件。

### Sheet⑨ 治理触点 — 需增加触点

| 触点ID | 触发条件 | 操作 |
|--------|---------|------|
| content_publish | 内容发布/下架 | 记录审计日志 |
| agent_template_change | Agent模板CRUD | 记录审计日志 |
| knowledge_review | 知识贡献审核 | 记录审计日志 |
| challenge_push | 挑战推送 | 记录审计日志 |
| violation_record | 违规记录 | 积分扣罚+通知 |
| safety_block | SafetyPipeline拦截 | 记录SafetyLog |

### 是否需要新增Sheet

**建议新增: Sheet⑮ 工具引擎治理**

覆盖平台通用工具引擎（Survey/Challenge/Exam/Program/MicroAction）的治理规范：
- 工具引擎的RBAC标准（谁可创建/发布/参与）
- 工具引擎的积分联动标准（参与/完成各触发什么事件）
- 工具引擎的审计标准（哪些操作必须有审计日志）
- 工具引擎的安全标准（哪些涉及用户内容的操作必须经SafetyPipeline）

当前这些工具引擎的治理分散在Sheet③④⑤⑦中，且大部分未被覆盖。统一为Sheet⑮可消除治理真空。

---

## 附录: 端点总表速查

| 大类 | 子类 | 端点数 | R% | V% | P% | A% | S% |
|------|------|--------|----|----|----|----|-----|
| A.用户生命周期 | A1-A4 | 51 | 80% | 47% | 6% | 37% | 0% |
| B.评估与诊断 | B1-B3 | 37 | 86% | 32% | 0% | 11% | 0% |
| C.干预与行动 | C1-C5 | 62 | 97% | 10% | 3% | 0% | 0% |
| D.Agent与AI | D1-D8 | 68 | 72% | 9% | 0% | 22% | 0% |
| E.数据采集 | E1-E7 | 45 | 40% | 9% | 0% | 78% | 0% |
| F.学习与成长 | F1-F5 | 77 | 86% | 4% | 16% | 10% | 0% |
| G.社交协作 | G1-G3 | 20 | 100% | 25% | 0% | 0% | 0% |
| H.教练督导 | H1-H5 | 38 | 95% | 47% | 0% | 0% | 0% |
| I.积分激励 | I1-I4 | 30 | 100% | 0% | 93% | 10% | 0% |
| J.晋级治理 | J1-J4 | 42 | 100% | 17% | 21% | 5% | 0% |
| K.知识管理 | K1-K3 | 20 | 100% | 15% | 0% | 0% | 0% |
| L.安全审计 | L1-L2 | 23 | 65% | 0% | 0% | 0% | 35% |
| M.平台管理 | M1-M12 | 133 | 60% | 1% | 2% | 8% | 0% |
| **总计** | | **646** | **84%** | **9%** | **8%** | **10%** | **1%** |

---

> 本报告由9个并行审计Agent在2026-02-14逐文件读取58个API模块+2个独立应用生成。
> 所有治理维度检查均基于grep代码实际依赖注入和函数体调用，非推测。
