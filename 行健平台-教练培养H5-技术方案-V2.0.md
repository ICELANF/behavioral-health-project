# 行健平台 · 教练培养体系 H5/小程序 技术方案 V2.0

> 版本: V2.0 | 日期: 2026-02-28
> 基座: BehaviorOS V5.3.1 | Alembic HEAD: 059
> 变更说明: 增加微信小程序适配 / 考试模块同步开发 / 内容体系完整规划 / 直播策略决策

---

## 一、架构师核心判断（4份文档综合结论）

### 1.1 直播功能 ⚠️ 关键决策点

**现状**: 后端直播功能明确标注"预留，未实现"，无 LiveSession 模型、无推流接入、无弹幕系统。

**选项对比**:

| 选项 | 开发量 | 上线时间 | 建议 |
|------|--------|---------|------|
| A. MVP 跳过直播，展示"即将开放"占位页 | 0 | 不阻塞 | **推荐** |
| B. 接入第三方直播 SDK（声网/腾讯云直播） | 6-8周额外工作量 | 大幅延后 | 不推荐 MVP |
| C. 用录播视频替代，标注"回放" | 0额外后端 | 不阻塞 | 可接受 |

**建议**: MVP 选 A，直播频道展示"敬请期待"占位 + 预约功能（记录用户意向）。录播课程和在线学习正常上线。

### 1.2 微信小程序 vs H5 架构决策

**现状**: 后端已有 `/api/v1/mp/*` 14个小程序专用端点（任务/反馈/对话/进度/风险）。

**技术路径**: 使用 **uni-app（Vue3语法）** 统一开发，一套代码同时发布：
- 微信小程序（主要渠道）
- H5（浏览器兼容，二维码分享）

好处: 组件复用 ~80%，BHP Design System §1-§40 可适配迁移，不需要维护两套代码库。

### 1.3 考试题型完整性确认

后端 `QuestionBank` 和 `ExamSession` 已支持题型扩展。MVP 同步开发以下题型前端：

| 题型 | 后端支持 | 前端工作量 | MVP 包含 |
|------|---------|---------|---------|
| 单选题 | ✅ | 低 | ✅ |
| 多选题 | ✅ | 低 | ✅ |
| 案例分享（图文） | ✅（content_items 关联） | 中 | ✅ |
| 案例分享（视频） | ✅（media_url + quiz） | 中 | ✅ |
| 问答/简答 | ✅ | 高（需人工评分） | ❌ 延后 |

### 1.4 内容学习体系完整性

四种学习形态均在 MVP 范围内：

```
视频学习   → ContentItem(video) + media_url + LearningProgress 断点续播
在线课程   → ContentItem(course) + 章节制 + 顺序解锁
图文学习   → ContentItem(article) + 阅读时长计算
音频学习   → ContentItem(audio) + TTS/人工录制
```

---

## 二、技术架构总图（V2.0 更新）

```
┌─────────────────────────────────────────────────────────┐
│              用户接入层                                    │
│  ┌──────────────────────┐  ┌───────────────────────────┐  │
│  │  微信小程序           │  │  H5 (浏览器/微信内嵌)     │  │
│  │  uni-app Vue3 编译   │  │  uni-app Vue3 编译        │  │
│  └──────────┬───────────┘  └──────────┬────────────────┘  │
│             └──────────┬──────────────┘                    │
└────────────────────────┼──────────────────────────────────┘
                         │ HTTPS + JWT
                         ▼
┌─────────────────────────────────────────────────────────┐
│          API 路由层 (BehaviorOS V5.3.1)                  │
│  /api/v1/auth  /api/v1/coach  /api/v1/learning           │
│  /api/v1/content  /api/v1/certification  /api/v1/mp      │
│  /api/v1/assessment  /api/v1/companions  /api/v1/paths   │
└─────────────────────────────────────────────────────────┘
                         │
┌─────────────────────────────────────────────────────────┐
│          核心服务层                                       │
│  BAPSScoringEngine | BehavioralProfileService            │
│  CoachPushQueueService | ContentAccessService            │
│  LearningService | PromotionService | ExamService        │
└─────────────────────────────────────────────────────────┘
                         │
┌─────────────────────────────────────────────────────────┐
│          数据层                                          │
│  PostgreSQL(pgvector) | Redis | Qdrant                   │
│  150+ 表 | 59 迁移版本                                   │
└─────────────────────────────────────────────────────────┘
```

---

## 三、完整页面流（V2.0 更新）

### 3.1 页面树（完整版）

```
/pages/                              # 根目录
│
├── auth/login                       登录（手机号+密码 / 微信一键授权）
├── auth/register                    注册
├── auth/wechat-callback             微信OAuth回调
│
├── home/index                       首页（角色自适应渲染）
│
├── learning/                        ═══ 学习中心 ═══
│   ├── index                        学习首页（今日推荐 + 进行中）
│   ├── catalog                      课程目录（M1知识/M2技能/M3实践/M4评估/选修）
│   ├── search                       搜索内容
│   ├── content-detail               内容详情（文章/视频/音频/课程）
│   ├── video-player                 视频播放（断点续播 + 测验触发）
│   ├── audio-player                 音频播放（正念/引导冥想）
│   ├── course-detail                课程详情（章节列表 + 解锁状态）
│   ├── course-chapter               章节学习（顺序解锁）
│   ├── quiz                         随堂测验（单选+多选+案例题）
│   ├── quiz-result                  测验结果（分数+解析+积分奖励）
│   ├── my-learning                  我的学习（进度+时长+历史）
│   └── credits                      我的学分记录
│
├── exam/                            ═══ 认证考试 ═══
│   ├── index                        考试中心（可参加列表）
│   ├── intro/:id                    考试说明（规则+时间+题量）
│   ├── session/:id                  考试作答
│   │   ├── 单选题卡片
│   │   ├── 多选题卡片
│   │   └── 案例题卡片（图文/视频 + 配套题目）
│   ├── result/:id                   考试结果（通过/未通过 + 详细解析）
│   └── history                      我的考试记录
│
├── journey/                         ═══ 成长路径 ═══
│   ├── overview                     六级路径全景（可视化时间线）
│   ├── progress                     我的进度（三维积分 + 晋级要求检查清单）
│   ├── promotion                    晋级申请（四维快照预览 + 提交）
│   └── history                      历史申请记录
│
├── companions/                      ═══ 同道者 ═══
│   ├── index                        同道者列表（最多4人 + 状态）
│   ├── invite                       邀请同道者（搜索用户 + 发送邀请）
│   ├── detail/:id                   同道者详情（互动记录 + CR-28指标）
│   └── invitations                  收到的邀请列表
│
├── assessment/                      ═══ 评估（学员侧）═══
│   ├── pending                      待完成评估列表
│   ├── do/:id                       完成评估（分量表分步作答）
│   │   ├── TTM7（21题 · 改变阶段）
│   │   ├── BIG5（50题 · 人格）
│   │   ├── BPT6（18题 · 行为分型）
│   │   ├── CAPACITY（32题 · 潜力）
│   │   └── SPI（50题 · 成功预测）
│   └── result/:id                   评估结果（行为画像 + 教练处方）
│
├── coach/                           ═══ 教练工作台（L3+）═══
│   ├── dashboard                    工作台总览（待处理红点汇总）
│   ├── students/index               学员列表（四维分类 + 风险排序）
│   ├── students/detail/:id          学员详情（5个Tab）
│   │   ├── 画像 Tab                 大五雷达图 + TTM阶段 + 风险标签
│   │   ├── 评估 Tab                 历史评估 + 分配新评估 + AI建议
│   │   ├── 处方 Tab                 行为处方 + CoachReviewItems审核
│   │   ├── 健康数据 Tab             血糖/睡眠/运动图表
│   │   └── 消息 Tab                 对话历史 + AI消息建议 + 发送
│   ├── push-queue                   推送审批队列（待审批 / 已处理）
│   ├── assessment/index             评估管理（分配 + 待审核列表）
│   ├── assessment/review/:id        评估审核详情（goal/prescription/suggestion）
│   ├── analytics/index              数据分析（风险趋势 + 阶段分布 + 领域表现）
│   └── live/                        ─── 直播管理（MVP占位页）───
│       └── index                    "直播功能即将上线" + 预约通知
│
├── profile/                         ═══ 个人中心 ═══
│   ├── index                        基本信息 + 级别徽章 + 成就展示
│   ├── certification                认证信息 + 晋级进度条
│   ├── performance                  我的绩效（学员数/消息数/改善率）
│   ├── streak                       连续打卡记录
│   ├── leaderboard                  积分排行榜
│   └── settings                     账户设置 / 通知开关
│
└── notifications/index              ═══ 消息中心 ═══
    （收件箱 + 评估通知 + 同道者邀请 + 系统消息）
```

### 3.2 导航 TabBar（双模式）

```
学习者模式 (L0-L2):
  ┌────────┬────────┬────────┬────────┬────────┐
  │  首页  │  学习  │  路径  │ 同道者 │  我的  │
  └────────┴────────┴────────┴────────┴────────┘

教练模式 (L3+):
  ┌────────┬────────┬────────┬────────┬────────┐
  │ 工作台 │  学员  │  学习  │  消息  │  我的  │
  └────────┴────────┴────────┴────────┴────────┘
  （消息Tab含红点 = 待审批队列数）
```

---

## 四、数据库设计（含V2.0新增）

### 4.1 学习内容相关表（完整版，现有表）

| 表名 | 关键字段 | 用途 |
|------|---------|------|
| `content_items` | content_type, level, has_quiz, media_url, status, review_status | 内容主表（文章/视频/课程/音频/卡片） |
| `learning_progress` | user_id, content_id, progress_percent, last_position, status | **视频断点续播核心** |
| `learning_time_logs` | user_id, content_id, domain, minutes | 学习时长（连续打卡依赖） |
| `learning_points_logs` | user_id, source_type, points, category | 三维积分流水 |
| `user_learning_stats` | user_id, total_minutes, growth_points, current_streak | 聚合统计（快速读） |
| `content_likes` | user_id, content_id | 点赞（互斥唯一键） |
| `content_bookmarks` | user_id, content_id | 收藏 |
| `content_comments` | user_id, content_id, parent_id | 嵌套评论 |
| `content_audio` | content_item_id, audio_url, duration_seconds | 音频附件 |

### 4.2 考试相关表（现有表 + 新增扩展）

| 表名 | 状态 | 关键字段 |
|------|------|---------|
| `exam_definitions` | 现有 | title, duration_minutes, pass_score, target_level |
| `question_bank` | 现有 | question_type, content, options, correct_answer, media_url |
| `exam_sessions` | 现有 | user_id, exam_id, status, start_time, answers |
| `exam_results` | 现有 | session_id, score, passed, detailed_scores |

**question_bank 字段扩展（新增1列）**:
```sql
-- 支持案例题关联内容
ALTER TABLE question_bank ADD COLUMN IF NOT EXISTS
    case_content_id INTEGER REFERENCES content_items(id);
-- 案例题 = 先展示一段图文或视频，再答题
```

**题型枚举扩展（question_type)**:
```
single_choice   → 单选题  （已有）
multiple_choice → 多选题  （已有）
case_text       → 案例题（图文）（新增枚举值）
case_video      → 案例题（视频）（新增枚举值）
```

### 4.3 直播预约表（MVP新增，轻量级）

```sql
-- 直播预约收集（MVP阶段，替代直播功能）
CREATE TABLE IF NOT EXISTS public.live_session_reservations (
    id          BIGSERIAL PRIMARY KEY,
    user_id     INTEGER REFERENCES users(id),
    topic       VARCHAR(200),               -- 期望的直播主题
    notify      BOOLEAN DEFAULT TRUE,       -- 是否在直播时通知
    created_at  TIMESTAMP DEFAULT NOW()
);
```

### 4.4 微信小程序用户绑定表（微信登录必须）

```sql
-- users表已有 wx_openid 字段（Migration 059 已增加）
-- 直接使用 users.wx_openid + users.wx_miniprogram_openid
-- 无需新建表
```

---

## 五、API 规格说明（V2.0 完整版）

### 5.1 微信小程序专用接口

| 方法 | 路径 | 用途 | 说明 |
|------|------|------|------|
| POST | `/api/v1/auth/wechat/miniprogram` | 微信一键登录 | code → openid → JWT |
| GET | `/api/v1/mp/tasks/today` | 今日任务（小程序端） | 已有 mp 专用端点 |
| POST | `/api/v1/mp/feedback` | 行为反馈上报 | 已有 |
| GET | `/api/v1/mp/progress` | 学习进度摘要 | 已有 |
| GET | `/api/v1/mp/risk` | 风险状态 | 已有 |

### 5.2 内容学习接口（完整版）

| 方法 | 路径 | 用途 | 注意事项 |
|------|------|------|---------|
| GET | `/api/v1/content` | 内容列表（分页+筛选） | 等级门控自动过滤 |
| GET | `/api/v1/content?content_type=video` | 视频列表 | type 参数筛选 |
| GET | `/api/v1/content?content_type=course` | 课程列表 | 章节制内容 |
| GET | `/api/v1/content/:id` | 内容详情 | 含 media_url / body |
| POST | `/api/v1/content/user/learning-progress` | **更新学习进度** | 触发积分+打卡+断点记录 |
| GET | `/api/v1/content/user/learning-progress/:id` | 获取断点位置 | 视频续播用 |
| POST | `/api/v1/content/:id/like` | 点赞 | 影响力积分+1给作者 |
| POST | `/api/v1/content/:id/bookmark` | 收藏 | 影响力积分+2给作者 |
| POST | `/api/v1/content/:id/comment` | 评论 | 成长积分给评论者 |
| GET | `/api/v1/content/:id/comments` | 评论列表 | 嵌套结构 |
| POST | `/api/v1/learning/complete` | **完成课程模块** | 学分+积分联动 |

**⚠️ 断点续播实现逻辑**:
```
前端: 每30秒 or 暂停时 → POST /learning-progress { progress_percent, last_position: "1234" (秒数) }
重新打开: GET /learning-progress/:id → 读取 last_position → video.currentTime = last_position
```

### 5.3 考试接口（完整版，MVP同步开发）

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | `/api/v1/certification/exams` | 可参加的考试列表 |
| GET | `/api/v1/certification/exams/:id` | 考试详情（规则+题量+时限） |
| POST | `/api/v1/certification/exams/:id/start` | 开始考试 → 生成 session + 抽题 |
| GET | `/api/v1/certification/sessions/:id/questions` | 获取本次考题列表 |
| POST | `/api/v1/certification/sessions/:id/answer` | 提交单题答案（实时保存防丢失） |
| POST | `/api/v1/certification/sessions/:id/submit` | 提交全卷 → 自动评分 |
| GET | `/api/v1/certification/sessions/:id/result` | 考试结果 + 逐题解析 |
| GET | `/api/v1/certification/my-history` | 我的考试记录 |

**⚠️ 考试防丢失策略**:
```
每题提交答案时实时调用 /answer（不等最后提交）
客户端同时本地缓存（小程序 Storage）
断线重连后 GET /sessions/:id/questions 恢复已答状态
```

### 5.4 评估接口（学员侧完整版）

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | `/api/v1/assessment/assignments/pending` | 我的待完成评估 |
| GET | `/api/v1/assessment/questions/ttm7` | 获取TTM7题目（21题） |
| POST | `/api/v1/assessment/evaluate` | **提交答卷 → 触发6步评估流水线** |
| GET | `/api/v1/assessment/profile` | 获取我的行为画像 |
| GET | `/api/v1/assessment/assignments/:id/result` | 评估结果（含教练推送的处方） |

### 5.5 所有接口汇总（按页面映射）

| 页面 | 调用接口数 | 主要接口 |
|------|---------|---------|
| 首页（学习者） | 4 | /learning/streak, /paths/my-progress, /content(推荐), /companions/my |
| 首页（教练） | 3 | /coach/dashboard, /coach-push/pending(count), /assessment/pending-reviews(count) |
| 学习中心 | 3 | /content(list), /content(recommended), /learning/my-stats |
| 视频播放页 | 3 | /content/:id, /learning-progress/:id(GET), /learning-progress(POST每30s) |
| 随堂测验 | 3 | quiz嵌入content/:id, /learning/complete(答对后) |
| 考试作答 | 4 | /exams/:id/start, /sessions/:id/questions, /sessions/:id/answer(每题), /submit |
| 成长进度 | 3 | /paths/my-progress, /paths/level-requirements, /segments/upgrade-suggestions |
| 学员详情 | 6 | /students/:id, /behavioral-profile, /assessment-detail, /glucose, /sleep, /messages/ai-suggestions |
| 推送审批队列 | 2 | /coach-push/pending, /coach-push/:id/approve or reject |

---

## 六、前端技术方案（V2.0 uni-app 版）

### 6.1 技术栈（统一小程序+H5）

```
框架:       uni-app（Vue3 Composition API + TypeScript）
UI组件库:   uni-ui + 自定义 BHP Design System 组件
状态管理:   Pinia（3个核心 store）
HTTP:       uni.request 封装（自动 Token 注入 + 刷新）
路由:       uni-app 原生路由（pages.json 配置）
图表:       uCharts（uni-app 生态，小程序+H5 通用）
视频:       uni-app video 组件（支持微信小程序 video 标签）
本地存储:   uni.setStorageSync（统一抹平小程序/H5差异）
```

### 6.2 微信小程序专项适配

```typescript
// 微信一键登录流程
const wxLogin = async () => {
  // 1. 获取 wx.code
  const { code } = await uni.login({ provider: 'weixin' })
  
  // 2. 换取 JWT
  const { data } = await api.post('/api/v1/auth/wechat/miniprogram', { code })
  
  // 3. 存储 token（小程序用 Storage，H5 用 localStorage）
  uni.setStorageSync('access_token', data.access_token)
  userStore.setUser(data.user)
}

// 全局请求拦截（统一处理 token）
const request = (options) => {
  const token = uni.getStorageSync('access_token')
  return uni.request({
    ...options,
    header: { Authorization: `Bearer ${token}`, ...options.header }
  })
}
```

**小程序分包策略**（控制主包体积 ≤2MB）:
```
主包 (< 1.5MB):
  └── 首页 / 登录 / 注册 / TabBar页面

分包A - 学习 (< 2MB):
  └── 课程目录 / 内容详情 / 视频播放 / 随堂测验

分包B - 考试 (< 1MB):
  └── 考试中心 / 考试作答 / 结果详情

分包C - 教练工作台 (< 2MB):
  └── 学员列表 / 学员详情 / 推送队列 / 数据分析

分包D - 成长路径 (< 1MB):
  └── 路径全景 / 晋级申请 / 同道者管理
```

### 6.3 核心 Store 设计（V2.0）

```typescript
// store/user.ts
interface UserState {
  id: number
  username: string
  role: UserRole
  roleLevel: number                   // 0-99，决定视图模式
  growthPoints: number
  contributionPoints: number
  influencePoints: number
  wxOpenid?: string                   // 微信小程序登录
  currentStreak: number               // 连续打卡天数
}

// store/learning.ts
interface LearningState {
  myCredits: { total: number; m1: number; m2: number; m3: number; m4: number }
  inProgressContent: ContentProgress[]  // 进行中的课程（最多展示5个）
  todayMinutes: number                 // 今日学习分钟
  videoProgress: Record<number, { percent: number; position: number }>
}

// store/coach.ts（L3+使用）
interface CoachState {
  dashboardStats: DashboardStats
  pendingQueueCount: number           // TabBar 红点
  pendingAssessmentCount: number      // 待审核评估数
  highRiskStudents: Student[]         // 高风险学员（首页优先展示）
  currentExamSession: ExamSession | null  // 进行中的考试
}
```

### 6.4 考试作答页面设计（关键页面规格）

```
ExamSession 页面状态机:

INTRO → ANSWERING → REVIEW → SUBMITTING → RESULT

[ANSWERING 状态 UI]
┌─────────────────────────────────┐
│  第 3 / 25 题   剩余 42:18 ⏱   │
├─────────────────────────────────┤
│  [题目进度条]  ●●●○○○○...       │
├─────────────────────────────────┤
│  [单选题]                        │
│  以下关于TTM模型的说法，正确的是？ │
│                                 │
│  ○ A. 共分为5个阶段              │
│  ● B. 共分为7个阶段（已选）      │
│  ○ C. 主要用于评估人格特质       │
│  ○ D. 以上都不对                │
├─────────────────────────────────┤
│  [案例题时的额外区域]            │
│  📄 阅读以下案例材料...          │
│  [图文/视频展示区]               │
├─────────────────────────────────┤
│       [上一题]  [下一题]         │
└─────────────────────────────────┘

⚠️ 每次选择后立即调用 /sessions/:id/answer 保存
⚠️ 倒计时归零时自动触发 /submit
⚠️ 小程序后台切换 > 30秒 → 弹出警告
```

### 6.5 视频播放页面设计

```
VideoPlayer 页面功能:

┌─────────────────────────────────┐
│  [视频播放区域]                  │
│  ← 标题                   全屏→  │
│  ████████████░░░░  42% 12:30    │
│  ⏮  ⏪  ▶  ⏩  🔈               │
├─────────────────────────────────┤
│  课程：动机访谈技术 M2-03        │
│  ⭐ 收藏  👍 点赞  📤 分享       │
├─────────────────────────────────┤
│  课程章节列表                   │
│  ✅ 1. 动机访谈概述 (10min)      │
│  ▶️ 2. 核心技术（当前）(15min)   │
│  🔒 3. 实践演练 (20min) [解锁后] │
├─────────────────────────────────┤
│  [学完后弹出随堂测验]            │
│  完成学习可获得 +10 成长积分     │
└─────────────────────────────────┘

断点续播逻辑:
- 进入页面: GET /learning-progress/:id → video.seek(last_position)
- 播放中: 每 30s POST /learning-progress { last_position, progress_percent }
- 关闭/暂停: 立即 POST 保存当前位置
- 进度 >= 90%: 触发完成标记 + 积分发放 + 随堂测验弹出（如有）
```

---

## 七、MVP 上线范围（V2.0 确认版）

### 7.1 Sprint 计划（6周）

```
Sprint 1（Week 1）: 基础骨架
  ✦ uni-app 项目初始化（小程序+H5双目标配置）
  ✦ BHP Design System 组件库迁移适配
  ✦ 路由配置 + 分包策略 + TabBar 双模式
  ✦ Pinia store 初始化 + API 封装层
  ✦ 登录（账号密码 + 微信一键授权）
  ✦ 通用组件（LevelBadge / PointsCard / RiskTag / CourseCard）
  ── 交付物: 可登录的壳，双 TabBar 正确切换 ──

Sprint 2（Week 2）: 学习中心
  ✦ 课程目录（M1-M4 分类 + 等级门控展示）
  ✦ 内容详情（图文 + 视频播放 + 音频播放）
  ✦ 视频断点续播（30s 心跳保存）
  ✦ 随堂测验（单选+多选，内嵌在内容页）
  ✦ 完成学习 → 积分+学分联动刷新
  ✦ 点赞/收藏/评论
  ── 交付物: 完整学习流程可跑通 ──

Sprint 3（Week 3）: 认证考试 + 成长路径
  ✦ 考试中心（列表 + 考试说明页）
  ✦ 考试作答（单选+多选+案例图文+案例视频）
  ✦ 每题实时保存 + 倒计时 + 断线恢复
  ✦ 考试结果（分数+解析+通过证明）
  ✦ 成长路径全景（六级时间线可视化）
  ✦ 晋级进度页（三维积分 + 四维要求检查清单）
  ✦ 晋级申请（条件检查 + 四维快照预览）
  ── 交付物: 考试全流程 + 晋级申请可跑通 ──

Sprint 4（Week 4）: 教练工作台核心
  ✦ 工作台首页（高风险学员优先 + 待处理汇总）
  ✦ 学员列表（四维分类 + 风险排序 + 搜索）
  ✦ 学员详情（画像Tab + 消息Tab）
  ✦ 推送审批队列（批量审批操作）
  ✦ 评估分配（选量表 + 分配给学员）
  ✦ 评估审核（CoachReviewItems逐条审核）
  ── 交付物: 教练核心工作流可跑通 ──

Sprint 5（Week 5）: 同道者 + 个人中心 + 评估学员侧
  ✦ 同道者列表 + 邀请 + 详情（CR-28指标）
  ✦ 个人中心（认证进度 + 绩效 + 连续打卡）
  ✦ 学员侧评估作答（BAPS量表分步表单）
  ✦ 评估结果展示（行为画像 + 教练处方查看）
  ✦ 消息通知中心
  ── 交付物: 学员评估闭环完整 ──

Sprint 6（Week 6）: 集成测试 + 上线准备
  ✦ 微信小程序审核提交材料准备
  ✦ 联调测试（按角色走完所有核心流程）
  ✦ 性能优化（分包体积 / 首屏加载时间）
  ✦ 边界情况处理（断网 / Token过期 / 权限拦截）
  ✦ pre_launch_verify.py 68项自检通过
  ── 交付物: 提审版本 ──
```

### 7.2 MVP 包含 vs 延后

| 功能 | MVP | 延后版本 | 说明 |
|------|-----|---------|------|
| 视频学习（录播） | ✅ | — | 断点续播 + 随堂测验 |
| 图文学习 | ✅ | — | — |
| 音频学习 | ✅ | — | TTS + 人工录制 |
| 在线课程（章节制） | ✅ | — | 顺序解锁 |
| 单选/多选考试 | ✅ | — | — |
| 案例题（图文+视频） | ✅ | — | — |
| 简答/问答题 | ❌ | v1.1 | 需人工评分流程 |
| **直播** | ❌ | v1.2 | 后端未实现，需另立项 |
| 教练工作台核心 | ✅ | — | 学员/推送/评估 |
| 数据分析图表（3图） | ✅ | — | uCharts 实现 |
| 同道者管理 | ✅ | — | — |
| BAPS评估作答（学员侧） | ✅ | — | 分步表单 |
| 知识投稿（教练） | ❌ | v1.1 | — |
| 直播预约收集 | ✅ | — | 简单表单，占位功能 |
| 微信小程序发布 | ✅ | — | 同步发布 |

---

## 八、项目文件结构（uni-app 版）

```
coach-h5-miniprogram/         # uni-app 项目根目录
├── src/
│   ├── pages/                # 页面（对应 3.1 页面树）
│   │   ├── auth/
│   │   ├── home/
│   │   ├── learning/
│   │   ├── exam/
│   │   ├── journey/
│   │   ├── companions/
│   │   ├── assessment/
│   │   ├── coach/
│   │   ├── profile/
│   │   └── notifications/
│   │
│   ├── components/           # 通用组件
│   │   ├── LevelBadge.vue      六级徽章（L0灰/L1绿/L2蓝/L3紫/L4粉/L5金）
│   │   ├── PointsCard.vue      三维积分展示卡
│   │   ├── ProgressChecklist.vue 晋级要求检查清单（✅/⏳/❌）
│   │   ├── CourseCard.vue      课程卡片（含进度条）
│   │   ├── VideoPlayer.vue     视频播放器（含断点续播逻辑）
│   │   ├── QuizCard.vue        题目卡片（单选/多选/案例）
│   │   ├── StudentCard.vue     学员卡片（含风险标签）
│   │   ├── RiskTag.vue         风险等级标签（高/中/低/无数据）
│   │   ├── InteractionBar.vue  点赞/收藏/评论/分享底栏
│   │   ├── RadarChart.vue      大五人格雷达图（uCharts）
│   │   └── TrendChart.vue      折线图（血糖/积分趋势）
│   │
│   ├── stores/
│   │   ├── user.ts
│   │   ├── learning.ts
│   │   └── coach.ts
│   │
│   ├── api/
│   │   ├── request.ts          基础请求封装（token + 错误处理）
│   │   ├── auth.ts
│   │   ├── content.ts
│   │   ├── exam.ts
│   │   ├── learning.ts
│   │   ├── coach.ts
│   │   ├── assessment.ts
│   │   └── companion.ts
│   │
│   ├── utils/
│   │   ├── level.ts            级别/积分/颜色映射工具
│   │   ├── time.ts             倒计时/时长格式化
│   │   └── wechat.ts           微信登录/分享封装
│   │
│   └── pages.json              路由配置 + 分包 + TabBar 双模式
│
├── manifest.json               小程序 AppID + H5 配置
└── vite.config.ts
```

---

## 九、风险清单与处理方案

| 风险 | 等级 | 处理方案 |
|------|------|---------|
| **直播后端未实现** | 高 | MVP用"即将上线"占位+预约功能，单独立项 |
| 视频断点续播在小程序内存限制 | 中 | 每30s心跳保存，页面隐藏时立即保存；小程序 video 组件原生支持 |
| 考试中途断线/切后台 | 中 | 实时保存每题答案，重新进入自动恢复 |
| 微信审核合规（医疗健康类） | 高 | **上线前确认：是否涉及医疗资质要求，功能描述聚焦"行为习惯管理"而非"医疗诊断"** |
| 小程序分包体积超限 | 低 | 按4分包规划，图表库用 uCharts（轻量），避免引入大型依赖 |
| BAPS 171题评估体验差 | 中 | 分量表分步作答（每组21/50题独立进度条），允许暂存草稿 |
| 等级门控内容展示 | 低 | content_access_service.py 已处理，前端仅需展示"解锁提示" |
| 课程内容尚未全部录入 | 中 | 结构先上，内容通过 CMS 动态维护，不阻塞发布 |

---

## 十、上线前验证 Checklist（V2.0）

```bash
# 后端验证（现有脚本）
python scripts/pre_launch_verify.py        # 68项自检
python scripts/test_all_pages_by_role.py   # 166/166

# 前端核心流程验证（人工走测）

【学习闭环】
□ L1用户 → 打开视频 → 播放 → 关闭 → 重新打开 → 从断点继续 ✓
□ 视频 >90% → 自动弹出随堂测验 → 通过 → 积分+学分更新 ✓
□ 完成课程 → 首页积分数字实时刷新 ✓

【考试闭环】
□ 进入考试 → 答题 → 切换到微信 30s → 返回 → 答案未丢失 ✓
□ 单选/多选/案例图文/案例视频 四种题型正常显示 ✓
□ 倒计时归零 → 自动提交 → 结果页正常显示 ✓
□ 考试通过 → 晋级进度页"考试认证"项变为✅ ✓

【晋级闭环】
□ 条件未满足 → 申请按钮置灰，显示"还差XX分" ✓
□ 条件全满足 → 提交申请 → 待审状态显示 ✓

【教练工作台闭环】
□ L0用户访问 /coach/dashboard → 自动跳转 /home（权限守卫）✓
□ L3教练 → 学员列表 → 高风险置顶 ✓
□ 发送消息 → 进审批队列 → 推送审批页看到待处理 → 审批通过 ✓
□ AI消息建议一键填充 → 编辑后发送 ✓

【微信小程序专项】
□ 微信一键登录全流程通过 ✓
□ 分包加载正常（首次进入学习分包无卡顿）✓
□ 小程序主包体积 < 2MB ✓
□ 微信内分享链接可跳转到对应页面 ✓

【危机安全铁律（NEVER BREAK）】
□ 输入含"自杀/自残"关键词 → CrisisAgent 触发 → 返回热线 400-161-9995 ✓
```

---

## 附录A：核心积分触发快查

| 用户行为 | 积分类型 | 数量 |
|---------|---------|------|
| 完成视频课程 | growth | +10 |
| 视频随堂测验满分 | growth | +5（额外）|
| 考试通过 | growth | +50 |
| 完成图文阅读 | growth | +5 |
| 每日登录 | growth | +2 |
| 连续打卡7天 | growth | +20（额外）|
| 发表评论 | growth | +3 |
| 内容被点赞（作者） | influence | +1 |
| 内容被收藏（作者） | influence | +2 |
| 投稿知识提交 | contribution | +5 |
| 投稿审核通过 | contribution | +10 |

---

## 附录B：直播功能独立立项说明

如需实现直播功能，需要独立立项，包含以下工作量（参考）：

**后端（约4周）**:
- LiveSession 数据模型（主播/观众/状态/推流密钥）
- 集成推流服务（腾讯云直播 / 声网 Agora 推荐）
- WebSocket 弹幕/实时互动系统
- 直播管理 API（开播/结束/回放/录制）
- 定时任务（直播超时自动结束）

**前端（约2周）**:
- 观看端（拉流播放 + 弹幕 + 互动）
- 主播端（推流控制，建议用 PC 端）
- 回放页面（复用视频播放器）

**合规**:
- 互联网直播资质（《互联网信息服务管理办法》）
- 直播内容审核机制

**建议**：将直播作为 v1.2 独立版本，在 MVP 通过验证后再启动。

---

*技术方案版本: V2.0 | 基于 BehaviorOS V5.3.1 | 2026-02-28*
*架构决策已包含: 微信小程序适配 / 考试模块同步 / 直播占位策略 / 内容完整体系*
*待确认后进入 Sprint 1 代码编写*
