# =============================================================
# BehaviorOS V4.0 — Deployment Pipeline
# =============================================================
# Triggers:
#   - push to develop  → deploy to staging (after CI passes)
#   - push to main     → deploy to production (after CI passes)
#
# This workflow runs AFTER ci.yml (lint → test → build).
# It only handles deployment — no duplicate test jobs.
#
# Required GitHub Secrets:
#   STAGING_HOST        — Staging server IP/hostname
#   STAGING_USER        — SSH username
#   STAGING_SSH_KEY     — SSH private key
#   PRODUCTION_HOST     — Production server IP/hostname
#   PRODUCTION_USER     — SSH username
#   PRODUCTION_SSH_KEY  — SSH private key
# =============================================================

name: Deploy

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [develop, main]

jobs:
  # ─── Deploy to Staging ────────────────────────────────────
  deploy-staging:
    name: Deploy Staging
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'
    environment: staging
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            set -e
            cd /opt/behaviros
            git pull origin develop

            # Build and restart
            docker compose -f docker-compose.app.yaml build
            docker compose -f docker-compose.app.yaml up -d

            # Run migrations
            sleep 5
            docker exec bhp-api python -m alembic upgrade head

            # Health check
            for i in $(seq 1 10); do
              if curl -sf http://localhost:8000/health > /dev/null; then
                echo "Staging deploy OK"
                exit 0
              fi
              sleep 3
            done
            echo "Health check failed"
            exit 1

  # ─── Deploy to Production ─────────────────────────────────
  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    environment: production
    steps:
      - name: Deploy via SSH (Rolling)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            set -e
            cd /opt/behaviros
            git pull origin main

            # Backup database before deploy
            BACKUP="backup_$(date +%Y%m%d_%H%M%S).sql"
            docker exec dify-db-1 pg_dump -U postgres -d bhp_db > "/opt/behaviros/backups/$BACKUP"
            echo "DB backup: $BACKUP"

            # Build new images
            docker compose -f docker-compose.app.yaml build

            # Rolling restart: API first
            docker compose -f docker-compose.app.yaml up -d --no-deps bhp-api
            sleep 10

            # Run migrations
            docker exec bhp-api python -m alembic upgrade head

            # Health check API
            for i in $(seq 1 15); do
              if curl -sf http://localhost:8000/health > /dev/null; then
                echo "API healthy"
                break
              fi
              sleep 3
            done

            # Restart frontends
            docker compose -f docker-compose.app.yaml up -d --no-deps bhp-admin-portal bhp-h5

            echo "Production deploy complete"
