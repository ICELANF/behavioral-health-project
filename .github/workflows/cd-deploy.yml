# ============================================================================
# cd-deploy.yml â€” æ”¹è¿›ç‰ˆéƒ¨ç½²å·¥ä½œæµ
# ä½ç½®ï¼š.github/workflows/cd-deploy.yml
# æ”¹è¿›ç‚¹ï¼š
#   1. Gate æ£€æŸ¥é€»è¾‘æ›´æ¸…æ™°ï¼ŒåŒºåˆ† CI è§¦å‘ vs æ‰‹åŠ¨è§¦å‘
#   2. è„šæœ¬å­˜åœ¨æ€§æ£€æŸ¥ï¼ˆç»Ÿä¸€è·¯å¾„ï¼Œé¿å…é‡å¤ï¼‰
#   3. åˆ†çº§æµ‹è¯•é›†æˆï¼ˆsmoke â†’ fullï¼‰
#   4. éƒ¨ç½²å‰å®‰å…¨æ£€æŸ¥
# ============================================================================

name: CD - Deploy

on:
  workflow_run:
    workflows: ["CI - Test"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•ï¼ˆä»…ç´§æ€¥ä¿®å¤ä½¿ç”¨ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      test_level:
        description: 'æµ‹è¯•çº§åˆ«'
        required: false
        default: 'smoke'
        type: choice
        options:
          - smoke
          - full

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==================== Gate æ£€æŸ¥ ====================
  gate-check:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.gate.outputs.should_deploy }}
    steps:
      - name: Check CI status
        id: gate
        run: |
          echo "ğŸ“‹ Deployment Gate Check"
          echo "  Event: ${{ github.event_name }}"
          echo "  Commit: ${{ github.sha }}"
          echo "  Ref: ${{ github.ref }}"
          echo ""
          
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "  è§¦å‘æ–¹å¼: CI å·¥ä½œæµå®Œæˆ"
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "âŒ CI å¤±è´¥ï¼Œé˜»æ­¢éƒ¨ç½²"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            echo "âœ… CI é€šè¿‡ï¼Œå…è®¸éƒ¨ç½²"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "  è§¦å‘æ–¹å¼: æ‰‹åŠ¨è§¦å‘"
            echo "  è·³è¿‡æµ‹è¯•: ${{ inputs.skip_tests }}"
            echo "  æµ‹è¯•çº§åˆ«: ${{ inputs.test_level }}"
            echo "â„¹ï¸ æ‰‹åŠ¨è§¦å‘ â€” è·³è¿‡ä¸Šæ¸¸ CI æ£€æŸ¥"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  # ==================== è„šæœ¬éªŒè¯ ====================
  verify-scripts:
    runs-on: ubuntu-latest
    needs: gate-check
    if: needs.gate-check.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Verify deployment scripts
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…è¦è„šæœ¬..."
          
          # ç»Ÿä¸€è„šæœ¬è·¯å¾„ï¼ˆpentest_bhp.py ä»…ä¿ç•™é¡¹ç›®æ ¹ç›®å½•ç‰ˆæœ¬ï¼‰
          scripts=(
            "scripts/e2e_acceptance.py"
            "scripts/static_checks.py"
            "pentest_bhp.py"
          )
          
          missing=0
          for script in "${scripts[@]}"; do
            if [ ! -f "$script" ]; then
              echo "âŒ ç¼ºå¤±: $script"
              missing=$((missing + 1))
            else
              echo "âœ… æ‰¾åˆ°: $script"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo ""
            echo "âŒ ç¼ºå¤± $missing ä¸ªè„šæœ¬ï¼Œç»ˆæ­¢éƒ¨ç½²"
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰å¿…è¦è„šæœ¬å°±ç»ª"

      - name: Verify static checks config
        run: |
          if [ -f "static_checks_config.yaml" ]; then
            echo "âœ… é™æ€æ£€æŸ¥é…ç½®å­˜åœ¨"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° static_checks_config.yamlï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi

  # ==================== åˆ†çº§æµ‹è¯• ====================
  run-tests:
    runs-on: ubuntu-latest
    needs: verify-scripts
    if: ${{ inputs.skip_tests != 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt 2>/dev/null || echo "â„¹ï¸ æ—  requirements.txt"

      - name: Static checks (å¿«é€Ÿ)
        run: |
          echo "ğŸ” è¿è¡Œé™æ€æ£€æŸ¥..."
          python scripts/static_checks.py --fast || {
            echo "âš ï¸ é™æ€æ£€æŸ¥å‘ç°é—®é¢˜ï¼ŒæŸ¥çœ‹ä¸Šæ–¹è¾“å‡º"
            # ä¸é˜»å¡ï¼Œä»…è­¦å‘Š
          }

      - name: Smoke test
        run: |
          echo "ğŸš€ è¿è¡ŒçƒŸé›¾æµ‹è¯•..."
          python scripts/e2e_acceptance.py --smoke
        timeout-minutes: 10

      - name: Full E2E test
        if: ${{ inputs.test_level == 'full' || github.event_name == 'workflow_run' }}
        run: |
          echo "ğŸ§ª è¿è¡Œå®Œæ•´ E2E éªŒæ”¶æµ‹è¯•..."
          python scripts/e2e_acceptance.py
        timeout-minutes: 30

      - name: Security pentest
        if: ${{ inputs.test_level == 'full' }}
        run: |
          echo "ğŸ”’ è¿è¡Œå®‰å…¨æ¸—é€æµ‹è¯•..."
          python pentest_bhp.py --full
        timeout-minutes: 20

  # ==================== æ„å»º & æ¨é€é•œåƒåˆ° ACR ====================
  build-push:
    runs-on: ubuntu-latest
    needs: [gate-check, verify-scripts, run-tests]
    if: |
      always() &&
      needs.gate-check.outputs.should_deploy == 'true' &&
      needs.verify-scripts.result == 'success' &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped')
    strategy:
      matrix:
        include:
          - service: bhp-api
            context: .
            dockerfile: Dockerfile
          - service: bhp-h5
            context: ./h5
            dockerfile: Dockerfile
          - service: bhp-admin-portal
            context: ./admin-portal
            dockerfile: Dockerfile
          - service: bhp-ui-components
            context: ./behaviros-frontend
            dockerfile: Dockerfile
          - service: bhp-expert-workbench
            context: .
            dockerfile: workbench/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - name: Login to Alibaba Cloud ACR
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login \
            --username "${{ secrets.ACR_USERNAME }}" \
            --password-stdin \
            "${{ secrets.ACR_REGISTRY }}"

      - name: Set image tag
        id: tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "sha_tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_tag=${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ matrix.service }}:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "latest_tag=${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ matrix.service }}:latest" >> $GITHUB_OUTPUT

      - name: Build image
        run: |
          # æ„å»º Dockerfile å®Œæ•´è·¯å¾„ (context + dockerfile)
          # ä¾‹: ./h5 + Dockerfile = ./h5/Dockerfile
          # ä¾‹: . + workbench/Dockerfile = ./workbench/Dockerfile
          DF_PATH="${{ matrix.context }}/${{ matrix.dockerfile }}"
          # è§„èŒƒåŒ–: å»é™¤ ./ é‡å¤
          DF_PATH=$(echo "$DF_PATH" | sed 's|^\./\./|./|')
          docker build \
            -f "$DF_PATH" \
            -t ${{ steps.tag.outputs.full_tag }} \
            -t ${{ steps.tag.outputs.latest_tag }} \
            ${{ matrix.context }}

      - name: Push to ACR
        run: |
          docker push ${{ steps.tag.outputs.full_tag }}
          docker push ${{ steps.tag.outputs.latest_tag }}
          echo "âœ… ${{ matrix.service }} â†’ ACR (${{ steps.tag.outputs.sha_tag }})"

  # ==================== éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ ====================
  deploy:
    runs-on: ubuntu-latest
    needs: [gate-check, build-push]
    if: needs.build-push.result == 'success'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy summary
        run: |
          echo "ğŸš€ å‡†å¤‡éƒ¨ç½²"
          echo "  Commit: ${{ github.sha }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "  é•œåƒæ ‡ç­¾: $(echo ${{ github.sha }} | cut -c1-7)"
          echo ""

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Generate remote .env
        env:
          ENV_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          ENV_REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          ENV_JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          ENV_CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          ENV_CLOUD_LLM_PROVIDER: ${{ secrets.CLOUD_LLM_PROVIDER }}
          ENV_CLOUD_LLM_API_KEY: ${{ secrets.CLOUD_LLM_API_KEY }}
          ENV_CLOUD_LLM_BASE_URL: ${{ secrets.CLOUD_LLM_BASE_URL }}
          ENV_CLOUD_LLM_MODEL: ${{ secrets.CLOUD_LLM_MODEL }}
          ENV_DIFY_API_URL: ${{ secrets.DIFY_API_URL }}
          ENV_DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }}
          ENV_ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ENV_ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
          ENV_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          cat > /tmp/deploy.env << EOF
          # === Auto-generated by CD pipeline ===
          ENVIRONMENT=production
          APP_VERSION=${{ github.sha }}
          # --- ACR é•œåƒ ---
          ACR_REGISTRY=${ENV_ACR_REGISTRY}
          ACR_NAMESPACE=${ENV_ACR_NAMESPACE}
          IMAGE_TAG=${SHORT_SHA}
          # --- æ•°æ®åº“ ---
          DATABASE_URL=postgresql://postgres:${ENV_DB_PASSWORD}@db:5432/health_platform
          # --- Redis ---
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_PASSWORD=${ENV_REDIS_PASSWORD}
          # --- å®‰å…¨ ---
          JWT_SECRET_KEY=${ENV_JWT_SECRET_KEY}
          JWT_ALGORITHM=HS256
          CORS_ORIGINS=${ENV_CORS_ORIGINS}
          # --- AI / LLM ---
          CLOUD_LLM_PROVIDER=${ENV_CLOUD_LLM_PROVIDER}
          CLOUD_LLM_API_KEY=${ENV_CLOUD_LLM_API_KEY}
          CLOUD_LLM_BASE_URL=${ENV_CLOUD_LLM_BASE_URL}
          CLOUD_LLM_MODEL=${ENV_CLOUD_LLM_MODEL}
          LLM_ROUTE_STRATEGY=cloud_first
          SAFETY_ENABLED=true
          # --- Dify ---
          DIFY_API_URL=${ENV_DIFY_API_URL}
          DIFY_API_KEY=${ENV_DIFY_API_KEY}
          # --- Ollama ---
          OLLAMA_API_URL=http://host.docker.internal:11434
          OLLAMA_MODEL=qwen2.5:0.5b
          # --- æ—¥å¿— ---
          LOG_LEVEL=INFO
          LOG_FORMAT=json
          PYTHONUNBUFFERED=1
          # --- ç›‘æ§ ---
          SENTRY_DSN=${ENV_SENTRY_DSN}
          SENTRY_TRACES_SAMPLE_RATE=0.1
          ENABLE_METRICS=true
          EOF
          # æ¸…ç†è¡Œé¦–ç©ºæ ¼ (YAML heredoc ç¼©è¿›)
          sed -i 's/^          //' /tmp/deploy.env

      - name: Deploy to remote server
        env:
          SSH_CMD: ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}
          SCP_CMD: scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no
          REMOTE_PATH: ${{ secrets.DEPLOY_PATH }}
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_NAMESPACE: ${{ secrets.ACR_NAMESPACE }}
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          echo "ğŸ“¦ Step 1: ä¸Šä¼  .env åˆ°è¿œç¨‹æœåŠ¡å™¨"
          $SCP_CMD /tmp/deploy.env ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${REMOTE_PATH}/.env

          echo "ğŸ”‘ Step 2: è¿œç¨‹ ACR ç™»å½•"
          $SSH_CMD << SSHEOF
            echo "${{ secrets.ACR_PASSWORD }}" | docker login \
              --username "${{ secrets.ACR_USERNAME }}" \
              --password-stdin \
              "${ACR_REGISTRY}"
          SSHEOF

          echo "â¬‡ï¸ Step 3: æ‹‰å–æœ€æ–°é•œåƒ"
          SERVICES="bhp-api bhp-h5 bhp-admin-portal bhp-ui-components bhp-expert-workbench"
          for svc in $SERVICES; do
            echo "  Pulling ${svc}:${SHORT_SHA}..."
            $SSH_CMD "docker pull ${ACR_REGISTRY}/${ACR_NAMESPACE}/${svc}:${SHORT_SHA}"
            # Tag as the compose-expected name for docker-compose.app.yaml
            $SSH_CMD "docker tag ${ACR_REGISTRY}/${ACR_NAMESPACE}/${svc}:${SHORT_SHA} dify-${svc}:latest"
          done

          echo "ğŸ—„ï¸ Step 4: æ•°æ®åº“è¿ç§»"
          $SSH_CMD << SSHEOF
            cd ${REMOTE_PATH}
            docker compose -f docker-compose.yaml -f docker-compose.app.yaml \
              run --rm bhp-api alembic upgrade head
          SSHEOF

          echo "ğŸ”„ Step 5: é‡å¯æœåŠ¡"
          $SSH_CMD << SSHEOF
            cd ${REMOTE_PATH}
            docker compose -f docker-compose.yaml -f docker-compose.app.yaml \
              up -d --force-recreate \
              bhp-api bhp-h5 bhp-admin-portal bhp-ui-components bhp-expert-workbench bhp-gateway
          SSHEOF

          echo "â³ Step 6: ç­‰å¾…æœåŠ¡å°±ç»ª (æœ€å¤š60ç§’)"
          for i in $(seq 1 12); do
            if $SSH_CMD "curl -sf http://localhost:8000/health" > /dev/null 2>&1; then
              echo "âœ… bhp-api å¥åº·"
              break
            fi
            echo "  ç­‰å¾…ä¸­... ($((i*5))/60s)"
            sleep 5
          done

      - name: Post-deploy health check
        run: |
          echo "ğŸ¥ å…¨é¢å¥åº·æ£€æŸ¥..."
          ENDPOINTS=(
            "http://${{ secrets.DEPLOY_HOST }}:8000/health"
            "http://${{ secrets.DEPLOY_HOST }}:5173"
            "http://${{ secrets.DEPLOY_HOST }}:5174"
          )
          ALL_OK=true
          for ep in "${ENDPOINTS[@]}"; do
            if curl -sf --max-time 10 "$ep" > /dev/null 2>&1; then
              echo "  âœ… $ep"
            else
              echo "  âŒ $ep"
              ALL_OK=false
            fi
          done

          if [ "$ALL_OK" = false ]; then
            echo ""
            echo "âš ï¸ éƒ¨åˆ†æœåŠ¡æœªé€šè¿‡å¥åº·æ£€æŸ¥ï¼Œè¯·æŸ¥çœ‹è¿œç¨‹æ—¥å¿—"
            exit 1
          fi
          echo ""
          echo "âœ… æ‰€æœ‰æœåŠ¡å¥åº·ï¼Œéƒ¨ç½²å®Œæˆ"

      - name: Deployment notification
        if: always()
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ“¢ éƒ¨ç½²æˆåŠŸ: ${SHORT_SHA} â†’ production"
          else
            echo "ğŸ“¢ éƒ¨ç½²å¤±è´¥: ${SHORT_SHA} â€” è¯·æ£€æŸ¥æ—¥å¿—"
          fi
