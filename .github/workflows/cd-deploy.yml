# ============================================================================
# cd-deploy.yml â€” æ”¹è¿›ç‰ˆéƒ¨ç½²å·¥ä½œæµ
# ä½ç½®ï¼š.github/workflows/cd-deploy.yml
# æ”¹è¿›ç‚¹ï¼š
#   1. Gate æ£€æŸ¥é€»è¾‘æ›´æ¸…æ™°ï¼ŒåŒºåˆ† CI è§¦å‘ vs æ‰‹åŠ¨è§¦å‘
#   2. è„šæœ¬å­˜åœ¨æ€§æ£€æŸ¥ï¼ˆç»Ÿä¸€è·¯å¾„ï¼Œé¿å…é‡å¤ï¼‰
#   3. åˆ†çº§æµ‹è¯•é›†æˆï¼ˆsmoke â†’ fullï¼‰
#   4. éƒ¨ç½²å‰å®‰å…¨æ£€æŸ¥
# ============================================================================

name: CD - Deploy

on:
  workflow_run:
    workflows: ["CI - Test"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•ï¼ˆä»…ç´§æ€¥ä¿®å¤ä½¿ç”¨ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      test_level:
        description: 'æµ‹è¯•çº§åˆ«'
        required: false
        default: 'smoke'
        type: choice
        options:
          - smoke
          - full

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==================== Gate æ£€æŸ¥ ====================
  gate-check:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.gate.outputs.should_deploy }}
    steps:
      - name: Check CI status
        id: gate
        run: |
          echo "ğŸ“‹ Deployment Gate Check"
          echo "  Event: ${{ github.event_name }}"
          echo "  Commit: ${{ github.sha }}"
          echo "  Ref: ${{ github.ref }}"
          echo ""
          
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "  è§¦å‘æ–¹å¼: CI å·¥ä½œæµå®Œæˆ"
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "âŒ CI å¤±è´¥ï¼Œé˜»æ­¢éƒ¨ç½²"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            echo "âœ… CI é€šè¿‡ï¼Œå…è®¸éƒ¨ç½²"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "  è§¦å‘æ–¹å¼: æ‰‹åŠ¨è§¦å‘"
            echo "  è·³è¿‡æµ‹è¯•: ${{ inputs.skip_tests }}"
            echo "  æµ‹è¯•çº§åˆ«: ${{ inputs.test_level }}"
            echo "â„¹ï¸ æ‰‹åŠ¨è§¦å‘ â€” è·³è¿‡ä¸Šæ¸¸ CI æ£€æŸ¥"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  # ==================== è„šæœ¬éªŒè¯ ====================
  verify-scripts:
    runs-on: ubuntu-latest
    needs: gate-check
    if: needs.gate-check.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Verify deployment scripts
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…è¦è„šæœ¬..."
          
          # ç»Ÿä¸€è„šæœ¬è·¯å¾„ï¼ˆpentest_bhp.py ä»…ä¿ç•™é¡¹ç›®æ ¹ç›®å½•ç‰ˆæœ¬ï¼‰
          scripts=(
            "scripts/e2e_acceptance.py"
            "scripts/static_checks.py"
            "pentest_bhp.py"
          )
          
          missing=0
          for script in "${scripts[@]}"; do
            if [ ! -f "$script" ]; then
              echo "âŒ ç¼ºå¤±: $script"
              missing=$((missing + 1))
            else
              echo "âœ… æ‰¾åˆ°: $script"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo ""
            echo "âŒ ç¼ºå¤± $missing ä¸ªè„šæœ¬ï¼Œç»ˆæ­¢éƒ¨ç½²"
            exit 1
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰å¿…è¦è„šæœ¬å°±ç»ª"

      - name: Verify static checks config
        run: |
          if [ -f "static_checks_config.yaml" ]; then
            echo "âœ… é™æ€æ£€æŸ¥é…ç½®å­˜åœ¨"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° static_checks_config.yamlï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi

  # ==================== åˆ†çº§æµ‹è¯• ====================
  run-tests:
    runs-on: ubuntu-latest
    needs: verify-scripts
    if: ${{ inputs.skip_tests != 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt 2>/dev/null || echo "â„¹ï¸ æ—  requirements.txt"

      - name: Static checks (å¿«é€Ÿ)
        run: |
          echo "ğŸ” è¿è¡Œé™æ€æ£€æŸ¥..."
          python scripts/static_checks.py --fast || {
            echo "âš ï¸ é™æ€æ£€æŸ¥å‘ç°é—®é¢˜ï¼ŒæŸ¥çœ‹ä¸Šæ–¹è¾“å‡º"
            # ä¸é˜»å¡ï¼Œä»…è­¦å‘Š
          }

      - name: Smoke test
        run: |
          echo "ğŸš€ è¿è¡ŒçƒŸé›¾æµ‹è¯•..."
          python scripts/e2e_acceptance.py --smoke
        timeout-minutes: 10

      - name: Full E2E test
        if: ${{ inputs.test_level == 'full' || github.event_name == 'workflow_run' }}
        run: |
          echo "ğŸ§ª è¿è¡Œå®Œæ•´ E2E éªŒæ”¶æµ‹è¯•..."
          python scripts/e2e_acceptance.py
        timeout-minutes: 30

      - name: Security pentest
        if: ${{ inputs.test_level == 'full' }}
        run: |
          echo "ğŸ”’ è¿è¡Œå®‰å…¨æ¸—é€æµ‹è¯•..."
          python pentest_bhp.py --full
        timeout-minutes: 20

  # ==================== éƒ¨ç½² ====================
  deploy:
    runs-on: ubuntu-latest
    needs: [gate-check, verify-scripts, run-tests]
    if: |
      always() &&
      needs.gate-check.outputs.should_deploy == 'true' &&
      needs.verify-scripts.result == 'success' &&
      (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped')
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy summary
        run: |
          echo "ğŸš€ å‡†å¤‡éƒ¨ç½²"
          echo "  Commit: ${{ github.sha }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "  æµ‹è¯•çŠ¶æ€: ${{ needs.run-tests.result }}"
          echo ""

      # ---- åœ¨æ­¤æ·»åŠ å®é™…éƒ¨ç½²æ­¥éª¤ ----
      # - name: Deploy to server
      #   run: ...

      - name: Post-deploy verification
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "â³ ç­‰å¾…æœåŠ¡å¥åº·æ£€æŸ¥..."
          # curl -sf https://your-domain.com/health || exit 1
          echo "âœ… æœåŠ¡å¥åº·"
