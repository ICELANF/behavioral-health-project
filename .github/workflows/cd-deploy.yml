# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  è¡Œå¥å¹³å° V4.0 â€” CD éƒ¨ç½²æµæ°´çº¿
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  è§¦å‘: main æ¨é€ (CI é€šè¿‡åè‡ªåŠ¨), æˆ–æ‰‹åŠ¨éƒ¨ç½²
#  æµç¨‹: CI é€šè¿‡ â†’ éƒ¨ç½² staging â†’ çº¿ä¸ŠéªŒæ”¶ â†’ éƒ¨ç½² production
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CD â€” Deploy & Verify

on:
  workflow_run:
    workflows: ["CI â€” Security & Acceptance"]
    types: [completed]
    branches: [main, master]

  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        type: choice
        options:
          - staging
          - production
      skip_pentest:
        description: "Skip pentest (emergency deploy)"
        type: boolean
        default: false

concurrency:
  group: deploy-${{ github.event.inputs.target || 'staging' }}
  cancel-in-progress: false  # éƒ¨ç½²ä¸å–æ¶ˆ

env:
  PYTHON_VERSION: "3.11"

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Gate: ç¡®è®¤ CI é€šè¿‡
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  gate:
    name: ğŸš¦ Deployment Gate
    runs-on: ubuntu-latest
    outputs:
      target: ${{ steps.decide.outputs.target }}

    steps:
      - name: Check CI status
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI failed, blocking deploy"
            exit 1
          fi
          echo "âœ… CI passed"

      - name: Decide target
        id: decide
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "target=${{ github.event.inputs.target }}" >> "$GITHUB_OUTPUT"
          else
            echo "target=staging" >> "$GITHUB_OUTPUT"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Stage 1: éƒ¨ç½²åˆ° Staging
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: gate
    if: needs.gate.outputs.target == 'staging' || needs.gate.outputs.target == 'production'
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to staging server
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PATH: ${{ secrets.STAGING_PATH || '/opt/behaviros' }}
        run: |
          # å†™å…¥ SSH key
          mkdir -p ~/.ssh
          echo "$STAGING_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$STAGING_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          SSH_CMD="ssh -i ~/.ssh/deploy_key ${STAGING_USER}@${STAGING_HOST}"

          # åŒæ­¥ä»£ç 
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='reports/' \
            ./ ${STAGING_USER}@${STAGING_HOST}:${STAGING_PATH}/

          # è¿œç¨‹æ‰§è¡Œéƒ¨ç½²
          $SSH_CMD << 'DEPLOY'
            set -e
            cd $STAGING_PATH

            # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
            source venv/bin/activate

            # å®‰è£…ä¾èµ–
            pip install -r requirements.txt -q

            # æ•°æ®åº“è¿ç§»
            alembic upgrade head

            # é‡å¯æœåŠ¡
            sudo systemctl restart behaviros-api

            # ç­‰å¾…å¥åº·æ£€æŸ¥
            for i in $(seq 1 15); do
              curl -sf http://localhost:8000/health && break
              sleep 2
            done
            curl -sf http://localhost:8000/health || exit 1
            echo "âœ… Staging deploy complete"
          DEPLOY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Stage 2: Staging çº¿ä¸ŠéªŒæ”¶
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  verify-staging:
    name: ğŸ›¡ï¸ Verify Staging
    runs-on: ubuntu-latest
    needs: deploy-staging
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: pip install requests httpx

      - name: Run acceptance on staging
        env:
          STAGING_URL: ${{ secrets.STAGING_URL || 'http://staging.xingjian.com' }}
        run: |
          python scripts/e2e_acceptance.py \
            --base $STAGING_URL \
            --project . \
            --json reports/staging-acceptance.json

          # éªŒè¯ç»“æœ
          python -c "
          import json, sys
          with open('reports/staging-acceptance.json') as f:
              data = json.load(f)
          failed = data.get('summary', {}).get('failed', 0)
          risk = data.get('summary', {}).get('risk_level', 'UNKNOWN')
          if failed > 0 or risk != 'LOW':
              print(f'âŒ Staging verification failed: {failed} failures, risk={risk}')
              sys.exit(1)
          print(f'âœ… Staging verified: risk={risk}')
          "

      - name: Run pentest on staging
        if: github.event.inputs.skip_pentest != 'true'
        env:
          STAGING_URL: ${{ secrets.STAGING_URL || 'http://staging.xingjian.com' }}
        run: |
          python scripts/pentest_bhp.py \
            --base $STAGING_URL/api/v1 \
            --json reports/staging-pentest.json

          python -c "
          import json, sys
          with open('reports/staging-pentest.json') as f:
              data = json.load(f)
          critical = [f for f in data.get('findings', []) if f.get('severity') in ('CRITICAL', 'HIGH')]
          if critical:
              print(f'âŒ Staging pentest: {len(critical)} CRITICAL/HIGH')
              sys.exit(1)
          print('âœ… Staging pentest passed')
          "

      - name: Upload staging reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-reports
          path: reports/staging-*.json
          retention-days: 90

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Stage 3: éƒ¨ç½²åˆ° Production (éœ€æ‰‹åŠ¨å®¡æ‰¹)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-production:
    name: ğŸ­ Deploy Production
    runs-on: ubuntu-latest
    needs: verify-staging
    if: needs.gate.outputs.target == 'production'
    environment:
      name: production
      # GitHub Environment Protection Rules ä¼šåœ¨æ­¤å¤„è¦æ±‚å®¡æ‰¹

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to production
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PATH: ${{ secrets.PROD_PATH || '/opt/behaviros' }}
        run: |
          mkdir -p ~/.ssh
          echo "$PROD_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$PROD_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          SSH_CMD="ssh -i ~/.ssh/deploy_key ${PROD_USER}@${PROD_HOST}"

          # ç”Ÿäº§éƒ¨ç½²å‰å¤‡ä»½
          $SSH_CMD << 'BACKUP'
            set -e
            cd /opt/behaviros
            TS=$(date +%Y%m%d_%H%M%S)
            mkdir -p /opt/behaviros/backups
            tar czf /opt/behaviros/backups/pre-deploy-${TS}.tar.gz \
              --exclude='venv' --exclude='__pycache__' --exclude='.git' .
            echo "âœ… Backup: pre-deploy-${TS}.tar.gz"
          BACKUP

          # åŒæ­¥ä»£ç 
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='.env' \
            --exclude='reports/' \
            --exclude='backups/' \
            ./ ${PROD_USER}@${PROD_HOST}:${PROD_PATH}/

          # è¿œç¨‹éƒ¨ç½²
          $SSH_CMD << 'DEPLOY'
            set -e
            cd /opt/behaviros
            source venv/bin/activate
            pip install -r requirements.txt -q
            alembic upgrade head
            sudo systemctl restart behaviros-api
            for i in $(seq 1 20); do
              curl -sf http://localhost:8000/health && break
              sleep 3
            done
            curl -sf http://localhost:8000/health || {
              echo "âŒ Health check failed, rolling back"
              sudo systemctl restart behaviros-api
              exit 1
            }
            echo "âœ… Production deploy complete"
          DEPLOY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Stage 4: ç”Ÿäº§éªŒæ”¶
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  verify-production:
    name: âœ… Verify Production
    runs-on: ubuntu-latest
    needs: deploy-production
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: pip install requests httpx

      - name: Production acceptance
        env:
          PROD_URL: ${{ secrets.PROD_URL || 'https://app.xingjian.com' }}
        run: |
          python scripts/e2e_acceptance.py \
            --base $PROD_URL \
            --project . \
            --json reports/prod-acceptance.json

          python -c "
          import json, sys
          with open('reports/prod-acceptance.json') as f:
              data = json.load(f)
          summary = data.get('summary', {})
          failed = summary.get('failed', 0)
          risk = summary.get('risk_level', 'UNKNOWN')
          passed = summary.get('passed', 0)
          total = summary.get('total', 0)
          if failed > 0 or risk != 'LOW':
              print(f'ğŸš¨ PRODUCTION VERIFICATION FAILED: {failed} failures, risk={risk}')
              print('â†’ Consider immediate rollback')
              sys.exit(1)
          print(f'âœ… Production verified: {passed}/{total} PASS, risk={risk}')
          "

      - name: Upload production report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-reports
          path: reports/prod-*.json
          retention-days: 180

      - name: Notify success
        if: success()
        run: |
          echo "ğŸ‰ Production deployment verified successfully"
          echo "  Commit: ${{ github.sha }}"
          echo "  Time: $(date -u)"
          # TODO: æ¥å…¥é’‰é’‰/é£ä¹¦/ä¼ä¸šå¾®ä¿¡é€šçŸ¥
          # curl -X POST "${{ secrets.WEBHOOK_URL }}" \
          #   -H "Content-Type: application/json" \
          #   -d '{"msg_type":"text","content":{"text":"âœ… è¡Œå¥å¹³å° V4.0 ç”Ÿäº§éƒ¨ç½²éªŒè¯é€šè¿‡"}}'

      - name: Notify failure
        if: failure()
        run: |
          echo "ğŸš¨ Production verification FAILED"
          # TODO: æ¥å…¥å‘Šè­¦é€šçŸ¥
