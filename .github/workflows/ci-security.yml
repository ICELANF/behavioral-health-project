# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  Ë°åÂÅ•Âπ≥Âè∞ V4.0 ‚Äî CI ÂÆâÂÖ®È™åÊî∂ÊµÅÊ∞¥Á∫ø
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
#  Ëß¶Âèë: PR ‚Üí main/develop, Êàñ push Âà∞ main/develop
#  ËÅåË¥£: ÈùôÊÄÅÂÆ°ËÆ° + ÂçïÂÖÉÊµãËØï + ÂÆâÂÖ®È™åÊî∂ (‰∏çÈÉ®ÁΩ≤)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: CI ‚Äî Security & Acceptance

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  ENVIRONMENT: "test"
  DATABASE_URL: "postgresql://bhp:bhp_test@localhost:5432/bhp_test"
  REDIS_URL: "redis://localhost:6379/0"
  CORS_ORIGINS: "http://localhost:3000"
  JWT_SECRET: "ci-test-secret-do-not-use-in-prod"
  JWT_ALGORITHM: "HS256"

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #  Stage 1: ÈùôÊÄÅÂÆâÂÖ®ÂÆ°ËÆ° (Êó†ÈúÄÊúçÂä°, ÊúÄÂø´)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  static-audit:
    name: üîç Static Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install audit tools
        run: |
          pip install bandit safety pip-audit

      - name: Bandit ‚Äî Python security linter
        run: |
          mkdir -p reports
          bandit -r api/ core/ -f json -o reports/bandit.json \
            --severity-level medium \
            --confidence-level medium \
            -x "**/test_*,**/tests/*" || true
          # Ëß£ÊûêÁªìÊûú
          python -c "
          import json, sys
          with open('reports/bandit.json') as f:
              data = json.load(f)
          highs = [r for r in data.get('results', []) if r['issue_severity'] == 'HIGH']
          if highs:
              print(f'‚ùå {len(highs)} HIGH severity issues found')
              for h in highs:
                  print(f\"  {h['filename']}:{h['line_number']} ‚Äî {h['issue_text']}\")
              sys.exit(1)
          print(f\"‚úÖ Bandit: {len(data.get('results', []))} findings (0 HIGH)\")
          "
        continue-on-error: false

      - name: pip-audit ‚Äî Dependency vulnerabilities
        run: |
          pip install -r requirements.txt
          pip-audit --format json --output reports/pip-audit.json || true
          python -c "
          import json, sys
          with open('reports/pip-audit.json') as f:
              data = json.load(f)
          vulns = data.get('dependencies', [])
          critical = [v for v in vulns if any(
              a.get('severity', '') in ('CRITICAL', 'HIGH') for a in v.get('vulns', [])
          )]
          if critical:
              print(f'‚ùå {len(critical)} critical/high dependency vulnerabilities')
              sys.exit(1)
          print('‚úÖ pip-audit: No critical vulnerabilities')
          "

      - name: Custom static checks
        run: python scripts/static_checks.py

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: static-audit-reports
          path: reports/
          retention-days: 30

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #  Stage 2: ÂçïÂÖÉÊµãËØï + ÂÆâÂÖ®È™åÊî∂
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  acceptance:
    name: üõ°Ô∏è Security Acceptance (E2E)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: static-audit

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_USER: bhp
          POSTGRES_PASSWORD: bhp_test
          POSTGRES_DB: bhp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install requests httpx

      - name: Database setup
        run: |
          # Migration 001 uses Base.metadata.create_all() which creates ALL current
          # ORM tables at once.  Later migrations (004, 005, 008, 022, 025 ...) also
          # do op.create_table() for some of those same tables, so running
          # "alembic upgrade head" on a fresh DB fails with "already exists".
          #
          # The correct approach for CI (fresh DB):
          #   1. Create required schemas
          #   2. Use create_all() to build all tables from current ORM
          #   3. Stamp alembic_version as HEAD (skip per-migration replay)
          python -c "
          import os, sys
          sys.path.insert(0, '.')
          from sqlalchemy import create_engine, text
          engine = create_engine(os.environ['DATABASE_URL'])
          with engine.begin() as conn:
              conn.execute(text('CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"'))
              conn.execute(text('CREATE EXTENSION IF NOT EXISTS vector'))
              conn.execute(text('CREATE SCHEMA IF NOT EXISTS coach_schema'))
          from core.models import Base
          Base.metadata.create_all(engine)
          print('‚úÖ All tables created from ORM')
          "
          alembic stamp head
          echo "‚úÖ Alembic stamped at HEAD"

      - name: Seed demo accounts
        run: |
          python scripts/seed_demo_accounts.py --db $DATABASE_URL

      - name: Start application
        run: |
          ENVIRONMENT=test \
          uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          # Á≠âÂæÖÂêØÂä®
          for i in $(seq 1 30); do
            curl -sf http://localhost:8000/health && break
            echo "  Waiting for app... ($i/30)"
            sleep 2
          done
          curl -sf http://localhost:8000/health || { echo "‚ùå App failed to start"; exit 1; }
          echo "‚úÖ App started"

      - name: Run E2E acceptance tests
        run: |
          python scripts/e2e_acceptance.py \
            --base http://localhost:8000 \
            --project . \
            --json reports/acceptance.json

      - name: Validate acceptance results
        run: |
          python -c "
          import json, sys
          with open('reports/acceptance.json') as f:
              data = json.load(f)

          meta = data.get('report_meta', {})
          counts = meta.get('test_counts', {})
          summary = data.get('summary', {})

          total = counts.get('total', summary.get('total_results', 0))
          passed = counts.get('passed', 0)
          failed = counts.get('failed', 0)
          overall = summary.get('overall', 'UNKNOWN')

          print(f'  Total:  {total}')
          print(f'  Passed: {passed}')
          print(f'  Failed: {failed}')
          print(f'  Overall: {overall}')
          print()

          if failed > 0:
              print(f'‚ùå {failed} tests FAILED')
              for t in data.get('results', []):
                  if t.get('status') == 'FAIL':
                      print(f\"  FAIL: {t.get('name')} ‚Äî {t.get('detail', '')[:80]}\")
              sys.exit(1)

          if overall not in ('PASS',):
              print(f'‚ùå Overall result is {overall}, expected PASS')
              sys.exit(1)

          print(f'‚úÖ Acceptance PASS ‚Äî {passed}/{total}')
          "

      - name: Upload acceptance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-report
          path: reports/acceptance.json
          retention-days: 90

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #  Stage 2.5: ÂÖ®Âπ≥Âè∞ÂäüËÉΩÈ™åËØÅ (96 tests + 5 chains)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  platform-full-test:
    name: üß™ Full Platform Test (96+5)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: acceptance

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_USER: bhp
          POSTGRES_PASSWORD: bhp_test
          POSTGRES_DB: bhp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install requests httpx

      - name: Database setup
        run: |
          python -c "
          import os, sys; sys.path.insert(0, '.')
          from sqlalchemy import create_engine, text
          engine = create_engine(os.environ['DATABASE_URL'])
          with engine.begin() as conn:
              conn.execute(text('CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"'))
              conn.execute(text('CREATE EXTENSION IF NOT EXISTS vector'))
              conn.execute(text('CREATE SCHEMA IF NOT EXISTS coach_schema'))
          from core.models import Base
          Base.metadata.create_all(engine)
          "
          alembic stamp head
          python scripts/seed_demo_accounts.py --db $DATABASE_URL

      - name: Start application
        run: |
          ENVIRONMENT=test \
          uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          for i in $(seq 1 30); do
            curl -sf http://localhost:8000/health && break
            sleep 2
          done
          curl -sf http://localhost:8000/health || { echo "‚ùå App failed to start"; exit 1; }

      - name: Run full platform test (96 tests + 5 chains)
        run: |
          python scripts/test_platform_full.py --json reports/platform_test_report.json
          echo "exit_code=$?" >> $GITHUB_ENV

      - name: Validate platform test results
        run: |
          python -c "
          import json, sys
          with open('reports/platform_test_report.json') as f:
              data = json.load(f)
          mod = data.get('module_summary', {})
          chains = data.get('chain_summary', {})
          mod_pass = mod.get('passed', 0)
          mod_total = mod.get('total', 0)
          mod_fail = mod.get('failed', 0)
          chain_pass = chains.get('passed', 0)
          chain_total = chains.get('total', 0)
          chain_fail = chains.get('failed', 0)
          print(f'  Modules: {mod_pass}/{mod_total} passed, {mod_fail} failed')
          print(f'  Chains:  {chain_pass}/{chain_total} passed, {chain_fail} failed')
          if mod_fail > 0 or chain_fail > 0:
              print(f'‚ùå Platform test failed: {mod_fail} module + {chain_fail} chain failures')
              sys.exit(1)
          print(f'‚úÖ Platform test PASS ‚Äî {mod_pass}/{mod_total} + {chain_pass}/{chain_total} chains')
          "

      - name: Upload platform test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: platform-test-report
          path: reports/platform_test_report.json
          retention-days: 90

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #  Stage 3: Ê∏óÈÄèÊµãËØï (‰ªÖ main ÂàÜÊîØ, ÊàñÊâãÂä®Ëß¶Âèë)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  pentest:
    name: üîì Penetration Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: platform-full-test
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_USER: bhp
          POSTGRES_PASSWORD: bhp_test
          POSTGRES_DB: bhp_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install & start
        run: |
          pip install -r requirements.txt
          pip install requests httpx
          # Fresh DB: create_all + stamp (same as acceptance job)
          python -c "
          import os, sys; sys.path.insert(0, '.')
          from sqlalchemy import create_engine, text
          engine = create_engine(os.environ['DATABASE_URL'])
          with engine.begin() as conn:
              conn.execute(text('CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"'))
              conn.execute(text('CREATE EXTENSION IF NOT EXISTS vector'))
              conn.execute(text('CREATE SCHEMA IF NOT EXISTS coach_schema'))
          from core.models import Base
          Base.metadata.create_all(engine)
          "
          alembic stamp head
          python scripts/seed_demo_accounts.py --db $DATABASE_URL
          ENVIRONMENT=test uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          for i in $(seq 1 30); do
            curl -sf http://localhost:8000/health && break
            sleep 2
          done

      - name: Run penetration test
        run: |
          python scripts/pentest_bhp.py \
            --base http://localhost:8000/api/v1 \
            --json reports/pentest.json

      - name: Validate pentest results
        run: |
          python -c "
          import json, sys
          with open('reports/pentest.json') as f:
              data = json.load(f)
          findings = data.get('findings', [])
          critical = [f for f in findings if f.get('severity') in ('CRITICAL', 'HIGH')]
          if critical:
              print(f'‚ùå {len(critical)} CRITICAL/HIGH findings:')
              for f in critical:
                  print(f\"  [{f['severity']}] {f['title']}\")
              sys.exit(1)
          print(f'‚úÖ Pentest: {len(findings)} findings (0 CRITICAL/HIGH)')
          "

      - name: Upload pentest report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pentest-report
          path: reports/pentest.json
          retention-days: 90
