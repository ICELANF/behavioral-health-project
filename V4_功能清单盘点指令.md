# BehaviorOS V4.0 功能清单×治理映射 全量盘点指令

## 目标

对平台全部605个端点进行**功能视角**（非文件视角）的分组盘点，建立每个功能模块与契约注册表14Sheet的映射关系，识别"治理真空"区域。

## 为什么需要这份盘点

契约注册表14Sheet定义的是治理架构（角色/权限/积分/晋级/安全），但平台有大量功能性模块（问卷/打卡/食物识别/学习/考试等）只被注册表间接提及或完全未提及。如果不梳理，V4.0治理规则可能管不到这些模块，造成：
- 权限盲区：某功能没有RBAC校验，任何角色都能访问
- 积分断联：某功能的用户行为不产生积分事件
- 审计空白：某功能的操作没有日志记录
- 安全遗漏：某功能的输出不经过SafetyPipeline

---

## 第一步：全量端点采集

读取 `api/main.py`，提取所有 `app.include_router()` 注册的路由模块，然后逐个读取每个API文件，提取所有路由定义（@router.get/post/put/delete 或 @app.get/post/put/delete），记录：
- HTTP方法
- 路径
- 函数名
- 所属API文件

同时扫描 `baps_api.py` 和 `xingjian_api.py`（独立app，不在main.py中）。

输出格式示例：
```
GET  /api/v1/surveys                    list_surveys           survey_api.py
POST /api/v1/surveys                    create_survey          survey_api.py
GET  /api/v1/surveys/{id}               get_survey             survey_api.py
...
```

## 第二步：按业务功能分组

将所有端点按**用户视角的业务功能**归类（不是按文件，一个文件可能含多个功能，多个文件可能属于同一功能）。

建议的功能分组框架（根据实际端点调整，可增减）：

### A. 用户生命周期
- A1. 注册与认证（auth, OAuth, 令牌刷新）
- A2. 用户画像管理（profile, 个人信息, 偏好）
- A3. 角色与权限（RBAC, 角色查询, 权限校验）
- A4. 用户旅程（S0-S5阶段, 主体性, 信任评分）

### B. 评估与诊断
- B1. BAPS评估引擎（BigFive, BPT6, CAPACITY, SPI, TTM7）
- B2. 通用评估管线（assessment pipeline, 批次评估）
- B3. 调查问卷引擎（survey创建/发布/分发/回收/统计）
- B4. 健康素养评估（competency, COMB, 自我效能, 障碍, 支持）
- B5. 风险评估（risk level, trigger detection）

### C. 干预与行动
- C1. 行为处方Rx引擎（compute_rx, 策略匹配, 处方生成）
- C2. 微行动系统（micro action任务/日志/追踪）
- C3. 挑战打卡活动（challenge模板/报名/每日推送/问卷/日志）
- C4. 干预方案管理（intervention, program, 方案模板）
- C5. 提醒与推送（reminder, coach push queue, 推送建议）

### D. Agent与AI
- D1. Agent对话（chat, 消息, 多轮会话）
- D2. Agent路由与编排（MasterAgent, 路由决策, 编排器）
- D3. Agent模板管理（CRUD, 启用/禁用, 测试路由）
- D4. Agent生态市场（发布/审核/安装/评分/组合编排）
- D5. Agent反馈与质量（feedback, 日指标, prompt版本）
- D6. Agent策略引擎（PolicyEngine, 冲突解决, 决策追踪, 成本控制）

### E. 数据采集与设备
- E1. 生理数据采集（血糖/心率/HRV/血压/血氧/体重）
- E2. 行为数据采集（睡眠/运动/活动/步数）
- E3. 食物识别（拍照识别, 营养分析）
- E4. 设备管理（设备注册/同步/告警）
- E5. 高频数据接口（批量写入, 实时流）

### F. 学习与成长
- F1. 内容管理（内容发布/浏览/搜索/分类/L0-L5门控）
- F2. 学习进度追踪（学时/积分/完成率）
- F3. 考试系统（题库/试卷/考试/成绩）
- F4. 课程与学分（课程模块/学分/晋级学分要求）

### G. 社交与协作
- G1. 同伴关系（companion匹配/追踪/质量验证）
- G2. 同伴支持（peer support互动/辅导记录）
- G3. 教练消息（coach message, 沟通记录）
- G4. 内容互动（点赞/收藏/评论/分享）

### H. 教练与督导
- H1. 教练KPI管理（指标/红绿灯/告警）
- H2. 教练审核（coach review, 处方审核, Agent输出审核）
- H3. 督导管理（督导关系/记录/排期）
- H4. 专家租户管理（tenant, 客户, Agent映射, 审计）
- H5. 教练注册与认证（expert registration, 三轨入口）

### I. 积分与激励
- I1. 积分事件与余额（point event/transaction/balance）
- I2. 防刷策略（anti-cheat, 异常检测）
- I3. 徽章与里程碑（badge, milestone, streak）
- I4. 激励奖品（incentive reward, 兑换）
- I5. 翻卡/nudge（flip card, nudge record, memorial）

### J. 晋级与治理
- J1. 双轨晋级引擎（积分轨+成长轨, 4种状态）
- J2. 晋级申请（promotion application, 仪式触发）
- J3. 责任追踪（28条指标, governance health check）
- J4. 治理违规（violation, 积分扣罚, 降级, 保护期）
- J5. 契约签署（user contract, 伦理声明）

### K. 知识管理
- K1. RAG知识检索（文档/分块/向量/引用）
- K2. 知识贡献（contribution, 证据分级）
- K3. 知识共享（跨租户/跨领域共享）
- K4. 批量灌注（batch ingestion）

### L. 安全与审计
- L1. 安全管线（SafetyPipeline L1-L5）
- L2. LLM调用日志（call log, token统计）
- L3. RAG查询日志
- L4. 行为审计（audit log, behavior trace）
- L5. 用户活动日志（activity log）

### M. 平台管理
- M1. 系统健康检查（health, 版本, 配置）
- M2. Admin行为管理（v14 admin routes）
- M3. 数据可视化与分析（analytics, admin analytics）
- M4. 内容音频管理（content audio, TTS）

## 第三步：治理映射

对每个功能分组，检查以下7项治理维度是否已实现：

| 维度代码 | 治理维度 | 检查方法 |
|---------|---------|---------|
| **R** | RBAC权限控制 | 端点是否有 `Depends(require_xxx)` 装饰器或依赖注入校验角色 |
| **V** | 可见性分层 | 不同角色看到的数据范围是否不同（字段级/行级过滤） |
| **P** | 积分联动 | 功能操作是否触发积分事件（PointEvent记录） |
| **A** | 审计日志 | 操作是否被记录到audit log或activity log |
| **S** | 安全管线 | 输入/输出是否经过SafetyPipeline过滤 |
| **C** | 契约Sheet | 对应注册表哪个Sheet（①~⑭，可多个） |
| **O** | 治理Owner | 谁负责这个功能的治理（Admin/Supervisor/Coach/系统自动） |

检查方法：
- R: grep 端点函数中的 Depends() 参数和 dependencies.py 中的依赖
- V: 检查返回数据是否根据 user.role 或 role_level 进行过滤
- P: grep 函数体中是否有 point_event / award_points / PointTransaction 调用
- A: grep 函数体中是否有 audit_log / activity_log / log_ 调用
- S: grep 函数体中是否有 safety / pipeline / SafetyPipeline 调用

## 第四步：输出报告

生成文件：`V4_功能清单与治理映射.md`

### 报告结构

```markdown
# BehaviorOS V4.0 功能清单与治理映射

## 概要
- 总端点数：XXX
- 功能分组数：XX大类 XX小类
- 治理覆盖率：
  - RBAC覆盖：XX% (已有RBAC的端点 / 总端点)
  - 积分联动：XX% (触发积分的功能 / 应触发的功能)
  - 审计覆盖：XX% (有日志的端点 / 总端点)
  - 安全管线：XX% (经安全过滤的端点 / 需要过滤的端点)

## 功能分组详表

### A. 用户生命周期

#### A1. 注册与认证 (X个端点)
| 端点 | 方法 | 文件 | R | V | P | A | S | C | O |
|------|------|------|---|---|---|---|---|---|---|
| /api/v1/auth/register | POST | auth_api.py | ⬜ | — | ⬜ | ✅ | — | ① | 系统 |
| /api/v1/auth/login | POST | auth_api.py | ⬜ | — | ⬜ | ✅ | — | ① | 系统 |
...

（对每个功能分组重复此表）

## 治理真空清单

按严重程度列出所有治理维度缺失的功能：

### 🔴 高风险（无RBAC + 无审计）
| 功能 | 端点数 | 缺失维度 | 建议 |
...

### 🟡 中风险（有RBAC但无积分联动或无审计）
...

### 🟢 低风险（仅缺积分联动）
...

## 注册表扩展建议

基于治理真空分析，建议注册表新增或扩展的内容：
- Sheet⑤ 服务权益矩阵需要增加的行
- Sheet⑦ 积分契约需要增加的事件类型
- Sheet⑨ 治理触点需要增加的触点
- 是否需要新增Sheet（如"工具引擎治理"覆盖Survey/Challenge/Exam等通用工具）
```

## 执行要求

1. **实际读取每个API文件**，不要从审计报告推测——上次审计是文件视角，这次需要端点视角
2. **治理维度检查要grep代码**，不要猜测
3. 对于端点数量多的模块（如 content_api 28个、challenge_api 23个），可以抽样检查5-8个代表性端点，其余标注"同上"
4. 分组框架仅供参考，根据实际端点调整——如果某个分组只有1-2个端点就合并到相近分组
5. 重点关注治理真空，那是此次盘点的核心价值
