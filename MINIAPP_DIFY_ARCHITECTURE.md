# 🎯 小程序 + Dify 协作架构设计

**核心理念**: 小程序负责信息采集和结果展示，Dify负责智能对话和决策支持

**更新时间**: 2026-01-28

---

## 📊 架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                    小程序/H5前端                             │
│              (信息采集 + 结果展示)                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │ 数据录入界面  │    │ 对话界面     │    │ 结果展示界面  │  │
│  │              │    │              │    │              │  │
│  │ • 血糖值     │    │ • AI助手对话 │    │ • 评估报告   │  │
│  │ • HRV数据    │    │ • 健康咨询   │    │ • 风险等级   │  │
│  │ • 文字日记   │    │ • 方案建议   │    │ • 行动计划   │  │
│  │ • 表单问答   │    │ • 互动问答   │    │ • 历史趋势   │  │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘  │
│         │                   │                   │          │
└─────────┼───────────────────┼───────────────────┼──────────┘
          │                   │                   │
          ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI 后端网关                          │
│                 (路由分发 + 业务编排)                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐         ┌──────────────────┐         │
│  │  数据处理模块     │         │  对话路由模块     │         │
│  │                  │         │                  │         │
│  │ • 数据验证       │         │ • 意图识别       │         │
│  │ • 存储到DB       │         │ • 调用Dify       │         │
│  │ • 触发评估       │         │ • 返回AI回复     │         │
│  └────────┬─────────┘         └────────┬─────────┘         │
│           │                            │                   │
└───────────┼────────────────────────────┼───────────────────┘
            │                            │
            ▼                            ▼
    ┌───────────────┐          ┌─────────────────┐
    │  SQLite 数据库 │          │  Dify AI平台    │
    │               │          │                 │
    │ • 用户数据    │          │ • 对话管理      │
    │ • 评估记录    │          │ • 知识库RAG     │
    │ • 历史趋势    │          │ • 专家工作流    │
    └───────────────┘          │ • 多轮对话      │
                               └─────────────────┘
```

---

## 🎭 两个核心角色

### 角色1: 小程序/H5 - "信息采集者 + 展示器"

**职责**:
1. ✅ **信息采集** (Input)
   - 用户输入健康数据
   - 填写问卷和表单
   - 上传照片/语音（未来）
   - 选择症状/感受

2. ✅ **结果展示** (Output)
   - 显示评估报告
   - 可视化图表
   - 历史记录列表
   - 行动计划清单

3. ✅ **交互入口** (Gateway)
   - 提供"AI助手对话"入口
   - 展示Dify返回的对话内容
   - 渲染富文本/Markdown格式的建议

**不负责**:
- ❌ 复杂的AI推理
- ❌ 知识库检索
- ❌ 多轮对话管理
- ❌ 专家级决策

---

### 角色2: Dify - "智能对话支持者"

**职责**:
1. ✅ **智能对话** (Conversation)
   - 理解用户自然语言问题
   - 多轮对话上下文管理
   - 澄清模糊问题
   - 主动追问关键信息

2. ✅ **知识检索** (RAG)
   - 搜索专业健康知识库
   - 匹配相似案例
   - 引用权威文献
   - 提供证据支持

3. ✅ **专家决策** (Expert AI)
   - 多专家协作分析
   - 综合评估风险
   - 生成个性化方案
   - 优先级排序

4. ✅ **工作流编排** (Orchestration)
   - A1评估准备度
   - A2分析健康数据
   - A3生成行动计划
   - A4追踪进度

**不负责**:
- ❌ 数据长期存储（由后端DB负责）
- ❌ 用户界面展示（由小程序负责）
- ❌ 身份认证管理
- ❌ 支付/订单处理

---

## 🔄 典型交互流程

### 流程1: 数据录入 → 评估报告

```
用户操作小程序:
  1. 打开"数据录入"页面
  2. 输入血糖: 11.2 mmol/L
  3. 输入HRV: 45 ms
  4. 写日记: "最近压力很大，睡不好"
  5. 点击"提交评估"
     ↓
小程序发送 POST /api/assessment/submit
     ↓
后端接收数据:
  1. 验证数据格式
  2. 存储到数据库
  3. 触发评估引擎
  4. 生成风险评估结果
  5. 返回评估报告
     ↓
小程序展示:
  1. 显示风险等级: R2 中度风险
  2. 显示风险分数: 45.7
  3. 显示Trigger列表
  4. 显示推荐行动

✅ 此流程不需要Dify
```

---

### 流程2: AI对话咨询（引入Dify）

```
用户操作小程序:
  1. 看到评估结果后，有疑问
  2. 点击"咨询AI助手"按钮
  3. 在对话界面输入:
     "我的血糖为什么会波动这么大？"
     ↓
小程序发送 POST /api/v1/dispatch
     {
       "user_id": "patient_alice",
       "message": "我的血糖为什么会波动这么大？",
       "mode": "dify",
       "context": {
         "latest_glucose": [9.5, 11.2, 13.8],
         "latest_assessment": "R2-中度风险"
       }
     }
     ↓
后端网关:
  1. 接收请求
  2. 识别mode="dify"
  3. 调用 AgentGateway.call_dify_workflow()
     ↓
Dify工作流执行:
  A1. 专家1（内分泌专家）分析血糖数据
      - 检索知识库: 血糖波动原因
      - 识别: 可能与饮食、运动、压力相关

  A2. 专家2（营养师）分析饮食因素
      - 询问: "最近吃了什么？"
      - 建议: 监测餐后血糖

  A3. 专家3（心理咨询师）分析压力
      - 关联: 日记中"压力很大"
      - 解释: 压力激素影响血糖

  A4. 综合建议生成
      - 整合三位专家意见
      - 生成个性化解释和建议
     ↓
Dify返回响应:
  {
    "answer": "您的血糖波动可能与以下因素有关：

    1. **饮食因素**: 您最近可能摄入了较多高GI食物...
    2. **压力影响**: 您提到'压力很大'，压力激素...
    3. **睡眠不足**: HRV值偏低提示睡眠质量不佳...

    **建议行动**:
    - 记录每餐的食物和餐后2小时血糖
    - 尝试放松技巧（深呼吸、冥想）
    - 保证每晚7-8小时睡眠

    [参考文献: 《糖尿病管理指南2025》第3章]",

    "conversation_id": "conv-xxx",
    "metadata": {
      "experts_involved": ["内分泌", "营养", "心理"],
      "knowledge_sources": ["指南2025", "案例库"],
      "confidence": 0.89
    }
  }
     ↓
后端网关:
  1. 接收Dify响应
  2. 格式化为统一结构
  3. 返回给小程序
     ↓
小程序展示:
  1. 在对话界面显示AI回复
  2. 渲染Markdown格式
  3. 高亮关键建议
  4. 提供"继续提问"按钮
     ↓
用户继续对话:
  "那我应该吃什么早餐比较好？"
     ↓
（重复上述流程，Dify会记住对话历史）
```

---

## 🎨 小程序界面设计

### 页面1: 首页

```
┌─────────────────────────────┐
│  行为健康            [退出]  │
├─────────────────────────────┤
│  ┌───────────────────────┐  │
│  │ 👤 Alice Wang         │  │
│  │ 今日状态: 良好        │  │
│  └───────────────────────┘  │
│                             │
│  快捷操作                   │
│  ┌─────┐ ┌─────┐ ┌─────┐  │
│  │ 📝  │ │ 💬  │ │ 📊  │  │
│  │录入 │ │AI助手│ │分析 │  │  ← 新增"AI助手"
│  └─────┘ └─────┘ └─────┘  │
│                             │
│  最近评估                   │
│  [评估列表...]              │
└─────────────────────────────┘
```

---

### 页面2: AI对话界面（新增）⭐

```
┌─────────────────────────────┐
│  ← AI健康助手               │
├─────────────────────────────┤
│                             │
│  ┌─────────────────────┐   │
│  │ 👤 我                │   │
│  │ 我的血糖为什么会    │   │
│  │ 波动这么大？        │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │ 🤖 AI助手            │   │
│  │ 您的血糖波动可能与  │   │
│  │ 以下因素有关：      │   │
│  │                     │   │
│  │ 1. 饮食因素 🍎      │   │
│  │    您最近可能摄入...│   │
│  │                     │   │
│  │ 2. 压力影响 😰      │   │
│  │    压力激素会...    │   │
│  │                     │   │
│  │ 建议行动：          │   │
│  │ • 记录餐后血糖      │   │
│  │ • 尝试放松技巧      │   │
│  │                     │   │
│  │ [查看完整方案]      │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │ 输入您的问题...    [📤]│  │
│  └─────────────────────┘   │
│                             │
│  常见问题:                  │
│  • 如何控制血糖？          │
│  • 吃什么早餐好？          │
│  • 怎样改善睡眠？          │
└─────────────────────────────┘
```

**特点**:
- ✅ 实时对话（WebSocket或轮询）
- ✅ 显示"正在输入..."状态
- ✅ 支持Markdown渲染
- ✅ 可以插入卡片（方案、建议）
- ✅ 保存对话历史
- ✅ 快捷问题推荐

---

### 页面3: 评估结果页（增强版）

```
┌─────────────────────────────┐
│  ← 评估结果                 │
├─────────────────────────────┤
│  风险评估                   │
│  ┌───────────────────────┐  │
│  │ R2 中度风险    45.7分 │  │
│  │ 主要关注: 血糖波动     │  │
│  └───────────────────────┘  │
│                             │
│  识别的风险信号             │
│  • 血糖波动过大 (High)     │
│  • 睡眠质量下降 (Moderate) │
│                             │
│  推荐行动                   │
│  1. 调整饮食结构           │
│  2. 监测餐后血糖           │
│  3. 改善睡眠质量           │
│                             │
│  ┌───────────────────────┐  │
│  │ 💬 有疑问？问AI助手   │  │  ← 新增
│  └───────────────────────┘  │
│                             │
│  [继续评估] [返回首页]      │
└─────────────────────────────┘
```

---

## 🔌 API接口设计

### 接口1: 数据录入（现有）

```http
POST /api/assessment/submit

Request:
{
  "user_id": 2,
  "text_content": "最近压力很大，睡不好",
  "glucose_values": [9.5, 11.2, 13.8],
  "hrv_values": [52, 48, 55]
}

Response:
{
  "assessment_id": "ASS-xxx",
  "risk_assessment": {
    "risk_level": "R2",
    "risk_score": 45.7,
    "primary_concern": "血糖波动过大"
  },
  "triggers": [...],
  "routing_decision": {...}
}
```

---

### 接口2: AI对话（新增/增强）⭐

```http
POST /api/v1/chat

Request:
{
  "user_id": "patient_alice",
  "message": "我的血糖为什么会波动这么大？",
  "conversation_id": "conv-xxx",  // 可选，续接对话
  "context": {  // 可选，提供上下文
    "latest_assessment_id": "ASS-xxx",
    "user_profile": {...}
  }
}

Response:
{
  "status": "success",
  "answer": "您的血糖波动可能与以下因素有关...",
  "conversation_id": "conv-xxx",
  "message_id": "msg-xxx",
  "suggestions": [  // 建议的后续问题
    "那我应该吃什么早餐？",
    "如何记录餐后血糖？"
  ],
  "actions": [  // 可执行的行动
    {
      "type": "view_plan",
      "label": "查看完整方案",
      "url": "/plan/xxx"
    }
  ],
  "metadata": {
    "source": "dify",
    "experts_involved": ["内分泌", "营养"],
    "confidence": 0.89,
    "processing_time_ms": 1234
  }
}
```

---

### 接口3: 对话历史（新增）

```http
GET /api/v1/chat/history/{user_id}?limit=20

Response:
{
  "conversations": [
    {
      "conversation_id": "conv-xxx",
      "created_at": "2026-01-28T10:00:00",
      "last_message_at": "2026-01-28T10:05:00",
      "messages": [
        {
          "role": "user",
          "content": "我的血糖为什么波动大？",
          "timestamp": "2026-01-28T10:00:00"
        },
        {
          "role": "assistant",
          "content": "您的血糖波动可能与...",
          "timestamp": "2026-01-28T10:00:05"
        }
      ],
      "summary": "关于血糖波动原因的咨询"
    }
  ]
}
```

---

## 💡 实现优先级

### Phase 1: 基础对话（MVP）🎯 当前阶段

**目标**: 让用户能够在小程序中问问题，得到AI回复

**需要实现**:
1. ✅ 小程序添加"AI助手"入口
2. ✅ 对话界面UI（类似微信聊天）
3. ✅ 后端 `/api/v1/chat` 接口
4. ✅ 调用Dify Chatbot API
5. ✅ 显示AI回复

**不需要**:
- ❌ 复杂的上下文管理
- ❌ 多模态输入（图片、语音）
- ❌ 个性化记忆

**预计工作量**: 2-3天

---

### Phase 2: 上下文增强 📈

**目标**: AI能够了解用户的健康数据和历史

**需要实现**:
1. 在对话请求中附带用户context
2. Dify工作流集成用户数据API
3. 对话历史管理
4. 会话保存和恢复

**预计工作量**: 3-5天

---

### Phase 3: 主动推荐 🚀

**目标**: AI主动根据数据变化提供建议

**需要实现**:
1. 后台监测数据异常
2. 触发AI生成建议
3. 推送通知到小程序
4. 用户可查看推荐对话

**预计工作量**: 5-7天

---

## 📊 数据流向图

```
小程序 (信息采集)
    │
    ├─ 结构化数据 (血糖、HRV)
    │      ↓
    │  后端API → 存储DB → 评估引擎 → 返回报告
    │                                      ↓
    │                              小程序展示结果
    │
    └─ 自然语言对话
           ↓
       后端网关
           ↓
       Dify平台
           ├─ RAG检索知识库
           ├─ 多专家工作流
           └─ 生成个性化回复
                  ↓
              后端网关
                  ↓
           小程序展示对话
```

---

## ✅ 您的理解总结

| 组件 | 角色定位 | 核心职责 |
|------|---------|---------|
| **小程序/H5** | 信息采集 + 结果展示 | • 收集用户输入（数据、对话）<br>• 展示评估结果<br>• 渲染AI回复<br>• 提供交互界面 |
| **Dify** | 交互式对话支持者 | • 理解自然语言<br>• 知识库检索<br>• 多轮对话管理<br>• 生成专家级建议 |
| **后端API** | 业务编排中枢 | • 路由请求<br>• 数据存储<br>• 调用Dify<br>• 格式转换 |

---

## 🎯 下一步建议

### 短期（1-2周）
1. ✅ 在小程序添加"AI助手"按钮
2. ✅ 实现基础对话界面
3. ✅ 对接 `/api/v1/dispatch` 接口
4. ✅ 测试Dify对话流程

### 中期（1个月）
1. 📊 增强Dify工作流（专家协作）
2. 📚 扩充知识库内容
3. 🔄 实现上下文传递
4. 💾 保存对话历史

### 长期（3个月）
1. 🎯 主动推荐功能
2. 🗣️ 语音对话支持
3. 📸 图片识别（食物、药品）
4. 🤝 多用户协作（家人共享）

---

**您的理解完全正确！** 🎉

小程序 = **数据IO层**（输入输出）
Dify = **智能大脑**（理解和决策）
后端API = **中枢神经**（连接和编排）

这个架构清晰、可扩展，易于维护！👍
