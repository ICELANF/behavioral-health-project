# 行健平台 V4.0 上线前优先级审核

**审核日期:** 2026-02-15  
**审核依据:** 契约注册表 V4.0（15 Sheet）× V2.4合并版（20引擎/540测试）× 剩余待办六阶段  

---

## 一、你提的两条优先级——逐项审核

### ✅ 优先级A：本周3天端到端冒烟测试——**同意，但建议补两条关键链路**

你定义的主线路径完全正确：

> 访客浏览 → 注册 → HF-20体验评估 → AI试用3轮 → 成长者S0 → S1-S4推进 → 积分累积 → L0→L1晋级

这条链路覆盖了 Sheet③④⑤⑦⑧ 的核心契约，是成长轨的"黄金路径"。V2.4报告的540个测试全是单元/集成级别，**从未做过真实代码库中的端到端旅程串联**。这一步不能再拖。

**但对照契约注册表，建议补两条并行验证链路：**

**补充链路1：安全管线串联（Sheet⑨⑬⑮，1天可验证）**
- POST `/agent/run`（正常输入）→ 正常响应 + 审计日志写入验证
- POST `/agent/run`（危险输入）→ SafetyPipeline L1拦截 + SafetyLog记录
- POST `/agent/run`（未登录）→ 401
- 原因：Sheet⑮ 明确标注安全管线覆盖多处"⬜"，冒烟测试中不验安全链路，上线后第一个出问题的就是这里

**补充链路2：治理轨最小闭环（Sheet②⑥⑪，0.5天可验证）**
- 教练登录 → 查看KPI仪表盘 → 责任追踪三色灯正常显示
- Admin登录 → 治理健康看板28指标至少可达
- 原因：V2.4标注 Sheet② 为⚠️部分完成，仪表盘和34条责任追踪虽有引擎但从未在真实环境下走过一遍

**3天分配建议：**

| 天 | 任务 | 覆盖Sheet | 验收标准 |
|---|---|---|---|
| Day 1 | 黄金路径前半段：访客→注册→HF-20→AI三轮→成长者S0授权 | ③⑤⑧ | 全程无500/403，数据库状态一致 |
| Day 2 | 黄金路径后半段：S0→S1-S4推进→积分累积→L0→L1晋级校验→AntiCheat触发 | ④⑦⑪ | 积分正确累积，双轨晋级四状态可达，防刷至少1策略触发 |
| Day 3 | 安全链路 + 治理闭环 + RBAC边界（Observer→Coach端点403/Grower→Admin端点403） | ②⑥⑨⑬⑮ | 安全拦截可验证，仪表盘可达，角色越权被拦 |

### ⚠️ 优先级B：启动V4.1 Agent双层物理分离——**方向对，但时序需要调整**

你的判断核心逻辑没问题：

> 行为健康场景下用户层和教练层的数据隔离是合规硬要求，越早启动越好

契约注册表⑫明确标注"双层4周"，V2.4也将其列为 V4.1 P0 第一项。**但以下因素建议你不要在本周就启动，而是冒烟测试通过后再启动：**

**理由1：V4.0 MVP还未通过端到端验证**
- 540个测试虽然全绿，但全是隔离测试。如果冒烟测试暴露出数据模型层面的问题（比如 BehavioralProfile ↔ JourneyState 同步在真实调用中出bug），这些底层修复会直接影响Agent双层分离的架构设计
- 先跑通冒烟再动架构，避免"在不稳定地基上盖楼"

**理由2：冒烟测试可能暴露出比双层分离更紧急的阻塞项**
- Sheet⑮ 工具引擎治理显示：400分制教练考核标注"❌未实现(P2待建)"、反思日志安全管线"⬜"、食物识别安全管线"⬜"
- 这些如果在冒烟中被暴露为上线阻塞项，优先级可能高于双层分离
- 当前RBAC逻辑隔离（93%覆盖）确实能支撑MVP上线，你自己也说了

**理由3：双层分离的前置依赖还没ready**
- Sheet⑩ 列出 Agent双层需要~30端点重构
- Sheet⑫ 督导三重角色系统（3周）依赖双层分离
- Agent注册机制（2.5周）也依赖双层
- 这是一条 4+3+2.5 = 9.5周的依赖链，本周启动和下周启动差异可忽略，但冒烟测试的信息量对架构决策非常关键

**建议时序：**
- 本周 Day 1-3：冒烟测试（按上表）
- Day 4-5：冒烟bug修复 + Agent双层架构设计文档（RFC级别，不写代码）
- 下周起：正式启动Agent双层物理分离编码

---

## 二、契约注册表审核发现——你可能忽略的3个风险点

### 风险1：审计日志覆盖率是上线合规的软肋

V2.4 报告审计日志从16%提升到≥50%，但Sheet⑮ 工具引擎治理显示：

- 调查问卷创建/发布：⬜ 审计
- 考试系统创建/提交：⬜ 审计
- 反思日志：⬜ 安全管线
- 食物识别：⬜ 安全管线

行为健康平台涉及个人健康数据，"谁在什么时候创建了什么评估内容"这类操作如果没有审计记录，在合规审查时会被质疑。V4.1 计划将审计从50%提到95%+，但**核心操作路径（评估创建、考试创建）的审计缺失是MVP上线的灰色地带**。

**建议：** 冒烟测试Day 3如果有余量，给 `survey.create`、`exam.create`、`exam.submit` 三个端点补上 `UserActivityLog` 写入，工作量约0.5天。这不是新引擎，只是在现有审计中间件上加几个事件类型。

### 风险2：数据一致性同步在冒烟中必须验证

待办文档明确提到"第三层：数据一致性测试"——

- 推进 `JourneyState.journey_stage` → `BehavioralProfile.current_stage` 是否同步
- 更新 `agency_mode` → User + BehavioralProfile + JourneyState 三处一致性
- 创建用户但无 BehavioralProfile → 同步降级不报错

V2.4 虽然有 Stage Engine（STG-01~20）和 Dual Track Engine（DTK-01~25）的单元测试，但**跨表同步在真实调用链中是否可靠，只有端到端才能验证**。建议在 Day 2 的阶段推进测试中，每次推进后额外做一次三表一致性断言。

### 风险3：RBAC 93%→100% 的2天任务不应等到V4.1

V2.4 列出 RBAC 100% 只需2天（Supervisor双身份 + Master细粒度），这个任务和 Agent 双层分离是独立的。当前7%的RBAC缺口意味着约46个端点缺乏权限校验。

**建议：** 冒烟测试结束后、Agent双层启动前，先用2天补完 RBAC。这样MVP上线时权限体系是完整的，不需要带着7%的缺口上线。

---

## 三、修正后的优先级排序

| 序号 | 任务 | 工期 | 依据 | 阻塞关系 |
|---|---|---|---|---|
| **1** | **端到端冒烟测试**（含安全链路+治理闭环） | 3天 | Sheet③④⑤⑦⑧⑨⑬⑮ | 所有后续工作的前提 |
| **2** | 冒烟阻塞bug修复 | 1-2天 | 冒烟输出 | 阻塞MVP判定 |
| **3** | 核心审计补全（survey/exam 3端点） | 0.5天 | Sheet⑮ ⬜标注 | 合规底线 |
| **4** | RBAC 93%→100% | 2天 | V2.4 V4.1列表 | 独立于Agent双层 |
| **5** | Agent双层架构RFC | 2天 | Sheet⑫ | 为编码阶段定锚 |
| **6** | **Agent双层物理分离编码** | 4周 | Sheet⑫ P0 | V4.1主线 |
| **7** | 督导三重角色 + Agent注册 | 3+2.5周 | Sheet⑫⑬ | 依赖#6 |

**净效果：** 你的两条优先级不变，只是在它们之间插入了约4天的"加固层"（bug修复+审计补全+RBAC封口），确保MVP上线时的合规底线和权限完整性。Agent双层分离整体延后不超过1周，但上线质量和合规姿态显著提升。

---

## 四、Sheet覆盖状态快照（基于本次审核）

| 状态 | Sheet | 冒烟是否覆盖 |
|---|---|---|
| ✅ 完成（11个） | ①③④⑤⑥⑦⑧⑨⑪⑬⑭ | Day 1-3 全部触达 |
| ⚠️ 部分（4个） | ②治理轨：Day 3验证仪表盘 | ✔ |
| | ⑩技术映射：冒烟本身就是验证手段 | ✔ |
| | ⑫Agent生态：V4.1主线，冒烟不覆盖 | ✘ 设计预期 |
| | ⑮工具引擎：Day 3安全链路覆盖核心 | 部分 |

---

*本审核基于契约注册表V4.0（15 Sheet）与V2.4合并版交叉对照。下次审核节点建议设在冒烟测试完成后（预计2月18日）。*
