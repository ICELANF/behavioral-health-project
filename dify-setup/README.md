# Dify 主动健康教练配置指南

## 核心理念：主动健康 · 吃动守恒

```
┌─────────────────────────────────────────────────────────────┐
│                   主动健康 · 吃动守恒                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     🥗 吃（摄入）    ⚖️ 守恒（平衡）    🏃 动（消耗）        │
│          │               │               │                  │
│     科学饮食 ─────── 能量平衡 ─────── 合理运动              │
│          │               │               │                  │
│     低GI饮食          体重管理          有氧+力量            │
│     定时定量          血糖稳定          循序渐进             │
│                                                             │
│  能量平衡公式:                                               │
│  • 摄入 = 消耗 → 体重稳定                                    │
│  • 摄入 > 消耗 → 体重增加                                    │
│  • 摄入 < 消耗 → 体重减少                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 文件说明

| 文件 | 说明 |
|------|------|
| `proactive-health-balance.yaml` | **主应用 DSL** - 吃动守恒健康教练 |
| `http-tools-config.md` | HTTP 工具详细配置 |
| `behavior-health-coach.yaml` | 备用简化版配置 |

---

## 快速开始

### 1. 确保服务运行

```bash
# 检查 Dify 服务
docker ps | grep dify

# 检查 Ollama 服务
curl http://localhost:11434/api/tags

# 访问地址
Dify 控制台: http://localhost
Ollama API:  http://localhost:11434
后端 API:    http://localhost:8001
前端:        http://localhost:5180
```

### 2. 导入应用

1. 登录 Dify 控制台 → **工作室**
2. 点击 **创建应用** → **导入DSL**
3. 上传 `proactive-health-balance.yaml`
4. 点击 **创建**

### 3. 配置 Ollama 模型

1. 进入 **设置** → **模型供应商**
2. 添加 **Ollama**
3. 配置参数：
   ```
   Base URL: http://host.docker.internal:11434
   模型名称: qwen2.5:14b
   ```

### 4. 添加 HTTP 工具

参考 `http-tools-config.md` 添加以下工具：

| 工具 | 端点 | 功能 |
|------|------|------|
| `intake` | POST /intake | 用户信息采集 |
| `stage_evaluate` | POST /stage/evaluate | TTM阶段评估 |
| `risk_evaluate` | POST /risk/evaluate | 风险评估 |
| `energy_balance` | POST /energy/calculate | 能量平衡计算 |
| `followup_register` | POST /followup/register | 随访注册 |

### 5. 发布并获取 API Key

1. 点击 **发布**
2. 进入 **访问 API** → 复制密钥
3. 更新前端 `.env`:
   ```
   VITE_DIFY_API_KEY=app-xxxxxxxxxxxxxxxx
   ```

---

## 系统架构

```
┌───────────────────────────────────────────────────────────────┐
│                         用户端                                 │
│   ┌────────────┐   ┌────────────┐   ┌────────────┐           │
│   │ 患者小程序  │   │ 教练工作台  │   │ 督导专家台  │           │
│   └─────┬──────┘   └─────┬──────┘   └─────┬──────┘           │
└─────────┼────────────────┼────────────────┼───────────────────┘
          │                │                │
          ▼                ▼                ▼
┌───────────────────────────────────────────────────────────────┐
│                       AI 智能层                                │
│  ┌──────────────────────────────────────────────────────────┐│
│  │                     Dify Agent 平台                       ││
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ ││
│  │  │ 健康教练  │  │ 饮食顾问  │  │ 运动指导  │  │ 心理支持  │ ││
│  │  │   🌿     │  │   🥗     │  │   🏋️     │  │   🧘     │ ││
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘ ││
│  └──────────────────────────────────────────────────────────┘│
│                            │                                  │
│  ┌──────────────────────────────────────────────────────────┐│
│  │                 Ollama 本地模型                           ││
│  │              qwen2.5:14b / deepseek-r1:7b                ││
│  └──────────────────────────────────────────────────────────┘│
└───────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌───────────────────────────────────────────────────────────────┐
│                       业务服务层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │
│  │ 用户服务  │  │ 健康数据  │  │ 行为评估  │  │ 干预服务  │     │
│  │ /intake  │  │ /glucose │  │ /stage   │  │/followup │     │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │
│                   FastAPI (Port 8001)                        │
└───────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌───────────────────────────────────────────────────────────────┐
│                       数据存储层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │PostgreSQL│  │  Redis   │  │向量数据库 │                   │
│  │  (5432)  │  │  (6379)  │  │ (Chroma) │                   │
│  └──────────┘  └──────────┘  └──────────┘                   │
└───────────────────────────────────────────────────────────────┘
```

---

## Agent 类型

### 🌿 主动健康教练 (A1)

**核心理念**: 吃动守恒

**能力**:
- 健康状况综合评估
- 能量平衡分析
- TTM行为阶段匹配
- 个性化健康建议
- 动机访谈引导

**触发场景**: 首次使用、主动咨询、健康评分变化

---

### 🥗 饮食顾问 (A3)

**职责**: 营养指导与饮食规划

**能力**:
- 低GI饮食指导
- 热量计算与配比
- 个性化食谱推荐
- 外出就餐建议

---

### 🏋️ 运动指导 (A2)

**职责**: 运动处方制定

**能力**:
- 运动能力评估
- 个性化运动处方
- 运动风险预警
- 进度追踪

---

### 🧘 心理支持 (A4)

**职责**: 情绪疏导

**能力**:
- 情绪状态识别
- 压力管理技巧
- 动机激励
- 复发预防

---

## TTM 行为改变模型

```
┌─────────────────────────────────────────────────────────────────┐
│                      TTM 跨理论模型                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   前意向期 ──▶ 意向期 ──▶ 准备期 ──▶ 行动期 ──▶ 维持期         │
│      │          │          │          │          │             │
│    无意愿      考虑中     准备行动    正在改变    已成习惯       │
│      │          │          │          │          │             │
│   提升认知    利弊分析    制定计划    支持鼓励    预防复发       │
│                                                                 │
│   ◀───────────────────── 可能复发 ─────────────────────────     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

| 阶段 | 用户特征 | 干预策略 |
|------|----------|----------|
| 前意向期 | 没意识到问题 | 提升认知，不施压 |
| 意向期 | 在考虑改变 | 帮助权衡利弊 |
| 准备期 | 准备开始行动 | 制定具体计划 |
| 行动期 | 正在努力改变 | 持续支持鼓励 |
| 维持期 | 已形成习惯 | 预防复发 |

---

## 测试用例

### 吃动守恒咨询
```
用户: 什么是吃动守恒？
预期: 解释能量平衡概念，结合用户情况给出建议
```

### 饮食分析
```
用户: 我今天早餐吃了两个包子和一碗粥
预期: 分析热量和GI值，给出优化建议
```

### 运动建议
```
用户: 我想开始运动但不知道做什么
预期: 评估当前状态，推荐适合的运动类型和强度
```

---

## 故障排除

### Ollama 连接问题
```bash
# 检查 Ollama
curl http://localhost:11434/api/tags

# Docker 内访问使用
http://host.docker.internal:11434
```

### Dify 导入失败
1. 检查 YAML 格式
2. 确保 Dify 版本 >= 0.6.0
3. 尝试简化版配置

---

## 访问入口

| 服务 | 地址 |
|------|------|
| 患者端首页 | http://localhost:5180/client |
| AI 聊天 | http://localhost:5180/client/chat?agent=A1 |
| Dify 控制台 | http://localhost |
| 后端 API | http://localhost:8001/docs |
